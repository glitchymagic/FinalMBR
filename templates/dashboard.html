<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FY26 Tech Spot Operational Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* === Walmart GT Brand Palette === */
        @font-face {
            font-family: "Bogle";
            src: local("Arial"), local("Helvetica"), system-ui, -apple-system, sans-serif;
            font-weight: 400;
            font-display: swap;
        }
        @font-face {
            font-family: "Bogle";
            src: local("Arial Bold"), local("Helvetica Bold"), system-ui, -apple-system, sans-serif;
            font-weight: 700;
            font-display: swap;
        }

        :root {
            --c-ink: #041F41;        /* Blue Ink - primary text / dark-theme surfaces */
            --c-green: #06F27B;      /* Global Green - positive deltas, CTAs, sparklines */
            --c-gray: #B9BBC5;       /* Gray - subtle fills, disabled UI */
            --c-granite: #605E63;    /* Granite Gray - borders, muted text, data gridding */
            --c-white: #FFFFFF;      /* White - default light surface */
            
            /* Chart colors following 30/20/20/15/15 rule */
            --chart-primary: var(--c-ink);      /* 30% Blue Ink */
            --chart-accent: var(--c-green);     /* 20% Global Green */
            --chart-secondary: #4a90e2;         /* Supporting blue */
            --chart-tertiary: #f5a623;          /* Supporting amber */
            --chart-neutral: var(--c-granite);  /* 15% Granite Gray */
        }

        /* LIGHT THEME (default) */
        :root[data-theme="light"], :root {
            --surface: var(--c-white);
            --surface-subtle: #F5F7FA;
            --surface-card: var(--c-white);
            --text-primary: var(--c-ink);
            --text-muted: var(--c-granite);
            --text-disabled: var(--c-gray);
            --accent: var(--c-green);
            --border-color: var(--c-gray);
            --border-subtle: #E5E7EB;
        }

        /* DARK THEME (Blue Ink canvas) */
        :root[data-theme="dark"] {
            --surface: var(--c-ink);           /* Blue Ink background */
            --surface-subtle: #11263E;         /* 20% tint of Ink */
            --surface-card: #0A1B2E;           /* Darker card backgrounds */
            --text-primary: var(--c-white);
            --text-muted: #D1D5DB;             /* Lighter gray for better visibility */
            --text-disabled: #9CA3AF;
            --accent: var(--c-green);          /* Green pops on Ink */
            --border-color: var(--c-granite);
            --border-subtle: #1F2937;
            
            /* Chart colors for dark mode - much lighter for visibility */
            --chart-primary: #93C5FD;          /* Light blue for dark mode */
            --chart-secondary: #7DD3FC;        /* Light cyan for dark mode */
            --chart-tertiary: #FDE68A;         /* Light amber for dark mode */
            --chart-neutral: #D1D5DB;          /* Light gray for dark mode */
            
            /* Modal variables for dark mode */
            --modal-bg: #1f2937;
            --modal-text: #ffffff;
            --modal-text-secondary: #9ca3af;
            --modal-border: #374151;
            --modal-card-bg: #374151;
        }
        
        /* Modal variables for light mode */
        :root[data-theme="light"] {
            --modal-bg: #ffffff;
            --modal-text: #041F41;
            --modal-text-secondary: #605E63;
            --modal-border: #e5e7eb;
            --modal-card-bg: #f9fafb;
        }

        /* Base styling with Walmart tokens + animations */
        body {
            background: var(--surface);
            color: var(--text-primary);
            font-family: "Bogle", system-ui, -apple-system, sans-serif;
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* Walmart-compliant animations */
        @keyframes walmartFadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes walmartSlideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes walmartGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(6, 242, 123, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(6, 242, 123, 0.6);
            }
        }

        @keyframes walmartPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes walmartShimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Loading animation */
        @keyframes walmartSpin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Animated cards and containers */
        .chart-container {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            animation: walmartFadeInUp 0.6s ease-out;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* Modal animations */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.8) translateY(50px);
            }
        }

        @keyframes modalBackdropFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalBackdropFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Modal container styling */
        .modal-backdrop {
            animation: modalBackdropFadeIn 0.3s ease-out;
        }

        .modal-backdrop.closing {
            animation: modalBackdropFadeOut 0.3s ease-out;
        }

        .modal-content {
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center;
        }

        .modal-content.closing {
            animation: modalSlideOut 0.3s ease-in;
        }

        /* Team name hover animation */
        .team-name {
            position: relative;
            transition: all 0.2s ease;
        }

        .team-name::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--c-green);
            transition: width 0.3s ease;
        }

        .team-name:hover::after {
            width: 100%;
        }

        .metric-card {
            background: var(--surface-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
            animation: walmartSlideInLeft 0.5s ease-out;
        }

        .metric-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(4, 31, 65, 0.1);
        }

        /* Animated number counters */
        .animated-number {
            display: inline-block;
            transition: all 0.3s ease;
        }

        @keyframes numberPulse {
            0% {
                text-shadow: 0 0 0px rgba(255, 255, 255, 0);
                color: inherit;
            }
            30% {
                text-shadow: 0 0 6px rgba(255, 255, 255, 0.5);
                color: #ffffff;
            }
            100% {
                text-shadow: 0 0 0px rgba(255, 255, 255, 0);
                color: inherit;
            }
        }
        
        .number-pulse {
            animation: numberPulse 0.8s ease-out;
            will-change: text-shadow, color;
        }

        /* Loading states */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--c-green);
            border-radius: 50%;
            animation: walmartSpin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        /* Shimmer effect for loading */
        .shimmer {
            background: linear-gradient(
                90deg,
                var(--surface-card) 25%,
                var(--surface-subtle) 50%,
                var(--surface-card) 75%
            );
            background-size: 200% 100%;
            animation: walmartShimmer 1.5s infinite;
        }

        /* Status colors (keeping Global Green for positive) */
        .trend-up {
            color: var(--c-green);
        }
        .trend-down {
            color: #DC2626;  /* Standard red for negative */
        }
        .trend-neutral {
            color: var(--text-muted);
        }

        /* Insight cards with Walmart colors */
        .insight-card {
            background: var(--surface-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
        }
        .insight-cyan {
            border-left: 4px solid var(--chart-secondary);
        }
        .insight-purple {
            border-left: 4px solid var(--c-ink);
        }
        .insight-pink {
            border-left: 4px solid var(--chart-tertiary);
        }
        
        /* Walmart Brand Theme Overrides */
        
        /* Background colors using CSS custom properties */
        [data-theme="light"] .bg-gray-900,
        .bg-gray-900 {
            background-color: var(--surface) !important;
        }

        [data-theme="light"] .bg-gray-800,
        .bg-gray-800 {
            background-color: var(--surface-subtle) !important;
        }

        [data-theme="light"] .bg-gray-700,
        .bg-gray-700 {
            background-color: var(--surface-card) !important;
        }

        [data-theme="light"] .bg-gray-600,
        .bg-gray-600 {
            background-color: var(--surface-subtle) !important;
        }

        [data-theme="light"] .bg-gray-500,
        .bg-gray-500 {
            background-color: var(--border-color) !important;
        }

        /* Text colors using Walmart palette */
        [data-theme="light"] .text-white,
        [data-theme="dark"] .text-white,
        .text-white {
            color: var(--text-primary) !important;
        }

        [data-theme="light"] .text-gray-400,
        [data-theme="dark"] .text-gray-400,
        .text-gray-400 {
            color: var(--text-muted) !important;
        }

        [data-theme="light"] .text-gray-200,
        [data-theme="dark"] .text-gray-200,
        .text-gray-200 {
            color: var(--text-muted) !important;
        }

        [data-theme="light"] .text-gray-300,
        [data-theme="dark"] .text-gray-300,
        .text-gray-300 {
            color: var(--text-muted) !important;
        }

        /* Walmart brand colors for chart headers */
        .text-blue-300, .text-blue-400 {
            color: var(--chart-primary) !important;
        }

        /* Improve blue text visibility in dark mode */
        [data-theme="dark"] .text-blue-600 {
            color: #60A5FA !important; /* Much lighter blue for dark mode */
        }

        [data-theme="dark"] .text-blue-500 {
            color: #3B82F6 !important; /* Lighter blue for dark mode */
        }

        [data-theme="dark"] .text-blue-400 {
            color: #60A5FA !important; /* Lighter blue for better visibility */
        }

        [data-theme="dark"] .text-blue-300 {
            color: #93C5FD !important; /* Even lighter blue for dark mode */
        }

        [data-theme="light"] .text-blue-600 {
            color: #2563EB !important; /* Keep original blue in light mode */
        }

        [data-theme="light"] .text-blue-500 {
            color: #3B82F6 !important; /* Keep original blue in light mode */
        }

        [data-theme="light"] .text-blue-400 {
            color: #60A5FA !important; /* Keep original blue in light mode */
        }

        /* Improve red text visibility in dark mode */
        [data-theme="dark"] .text-red-600 {
            color: #F87171 !important; /* Lighter red for dark mode */
        }

        [data-theme="light"] .text-red-600 {
            color: #DC2626 !important; /* Keep original red in light mode */
        }

        /* Improve purple text visibility in dark mode */
        [data-theme="dark"] .text-purple-600 {
            color: #C084FC !important; /* Lighter purple for dark mode */
        }

        [data-theme="light"] .text-purple-600 {
            color: #9333EA !important; /* Keep original purple in light mode */
        }

        /* Improve border colors in dark mode */
        [data-theme="dark"] .border-blue-600 {
            border-color: #60A5FA !important; /* Lighter blue border for dark mode */
        }

        [data-theme="light"] .border-blue-600 {
            border-color: #2563EB !important; /* Keep original blue border in light mode */
        }

        /* Improve background colors in dark mode */
        [data-theme="dark"] .bg-blue-900 {
            background-color: #1E3A8A !important; /* Lighter background for dark mode */
        }

        [data-theme="dark"] .bg-blue-600 {
            background-color: #2563EB !important; /* Keep blue-600 backgrounds visible */
        }

        /* Improve gray-500 text visibility in dark mode */
        [data-theme="dark"] .text-gray-500 {
            color: #D1D5DB !important; /* Lighter gray for dark mode */
        }

        [data-theme="light"] .text-gray-500 {
            color: #6B7280 !important; /* Keep original gray in light mode */
        }

        .text-purple-300 {
            color: var(--chart-secondary) !important;
        }

        .text-pink-300 {
            color: var(--chart-tertiary) !important;
        }

        .text-green-300 {
            color: var(--c-green) !important;
        }

        .text-red-300, .text-red-400 {
            color: #DC2626 !important;
        }

        /* Border colors */
        [data-theme="light"] .border-gray-700,
        [data-theme="dark"] .border-gray-700,
        .border-gray-700 {
            border-color: var(--border-color) !important;
        }

        [data-theme="light"] .border-gray-600,
        [data-theme="dark"] .border-gray-600,
        .border-gray-600 {
            border-color: var(--border-subtle) !important;
        }

        /* Form elements */
        select, input, textarea {
            background-color: var(--surface-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        select option {
            background-color: var(--surface-card) !important;
            color: var(--text-primary) !important;
        }

        /* Table styling */
        .border-b {
            border-color: var(--border-subtle) !important;
        }

        tr:hover {
            background-color: var(--surface-subtle) !important;
        }

        thead {
            background-color: var(--surface-subtle) !important;
        }

        /* Hover effects */
        .hover\\:bg-gray-700:hover, .hover\\:bg-gray-800:hover {
            background-color: var(--surface-subtle) !important;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            background-color: var(--surface);
        }

        ::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--c-granite);
        }

        /* Canvas and chart backgrounds */
        .light-mode canvas {
            background-color: transparent !important;
        }

        /* Ensure no remnant dark backgrounds */
        .light-mode * {
            border-color: inherit;
        }

        .light-mode .bg-gray-900,
        .light-mode .bg-gray-800,
        .light-mode .bg-gray-700,
        .light-mode .bg-gray-600,
        .light-mode .bg-gray-500 {
            background-color: inherit !important;
        }

        /* Override the body background specifically */
        body.light-mode {
            background-color: #ffffff !important;
            color: #1e293b !important;
        }

        /* Ensure all direct children maintain light theme */
        .light-mode > div {
            background-color: inherit;
        }

        /* More specific overrides for persistent dark elements */
        .light-mode .bg-gray-800 {
            background-color: #f8fafc !important;
            color: #1e293b !important;
        }

        .light-mode .bg-gray-700 {
            background-color: #f1f5f9 !important;
            color: #1e293b !important;
        }

        /* Specifically target table elements */
        .light-mode table thead {
            background-color: #f8fafc !important;
        }

        .light-mode table tbody tr {
            color: #1e293b !important;
        }

        .light-mode table tbody tr:hover {
            background-color: #f8fafc !important;
        }

        /* Force override any remaining dark text */
        .light-mode .text-white {
            color: #1e293b !important;
        }

        .light-mode .text-gray-400 {
            color: #64748b !important;
        }

        /* Enhanced theme toggle with Walmart animations */
        .theme-toggle {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            animation: walmartGlow 2s infinite;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Enhanced critical breach alert */
        .critical-alert {
            animation: walmartGlow 3s infinite;
        }

        /* Staggered animations for charts */
        .chart-container:nth-child(1) { animation-delay: 0.1s; }
        .chart-container:nth-child(2) { animation-delay: 0.2s; }
        .chart-container:nth-child(3) { animation-delay: 0.3s; }
        .chart-container:nth-child(4) { animation-delay: 0.4s; }
        .chart-container:nth-child(5) { animation-delay: 0.5s; }

        /* Progress bar animations */
        .progress-bar {
            background: linear-gradient(
                90deg,
                var(--c-green) 0%,
                var(--c-green) var(--progress, 0%),
                var(--border-color) var(--progress, 0%),
                var(--border-color) 100%
            );
            height: 4px;
            border-radius: 2px;
            transition: all 0.8s ease;
            overflow: hidden;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: walmartShimmer 2s infinite;
        }

        /* Floating elements */
        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        
        /* Smooth comparison transitions */
        .comparison-smooth-transition {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out !important;
        }

        /* Data refresh indicator */
        .refresh-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: var(--c-green);
            border-radius: 50%;
            opacity: 0;
            animation: refreshPulse 0.5s ease-in-out;
        }

        @keyframes refreshPulse {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.5); }
        }

        /* Dynamic incident title colors to match chart lines */
        [data-theme="dark"] #incident-title {
            color: #06d6a0; /* Bright cyan/teal for dark mode */
        }

        [data-theme="light"] #incident-title {
            color: #0891b2; /* Cyan-600 for light mode */
        }
        
        /* SLA Chart Line Glow Effects */
        @keyframes lineGlow {
            0% {
                filter: drop-shadow(0 0 10px currentColor);
            }
            50% {
                filter: drop-shadow(0 0 20px currentColor) drop-shadow(0 0 30px currentColor);
            }
            100% {
                filter: drop-shadow(0 0 10px currentColor);
            }
        }
        
        .sla-line-glow {
            animation: lineGlow 2s ease-in-out infinite;
        }
        
        /* Canvas hover cursor */
        /* SLA Chart CSS removed */
        
        /* SLA tooltip CSS removed */
    </style>
</head>
<body class="bg-gray-900 text-white font-sans">
    <div class="min-h-screen px-4 py-6">
        <!-- Animated Header -->
        <div class="flex justify-between items-center mb-8" style="animation: walmartFadeInUp 0.8s ease-out;">
            <div>
                <h1 class="text-3xl font-bold text-white floating">FY26 TECH SPOT OPERATIONAL METRICS</h1>
                <p class="text-gray-400 mt-2" style="animation: walmartSlideInLeft 1s ease-out;">Traffic & Trends Dashboard</p>
                
                <!-- Navigation Tabs -->
                <div class="mt-4 flex space-x-4 border-b border-gray-700">
                    <a href="/" class="px-4 py-2 text-cyan-300 border-b-2 border-cyan-300 font-medium">Incidents</a>
                    <a href="/consultations" class="px-4 py-2 transition-colors duration-200" style="color: var(--text-muted);" onmouseover="this.style.color='var(--text-primary)';" onmouseout="this.style.color='var(--text-muted)';">Consultations</a>
                </div>
            </div>
            <div class="flex flex-col space-y-4">
                <!-- Top Row: Theme Toggle, Quarter Filter, Region Filter, Stats -->
                <div class="flex items-center space-x-6">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" class="theme-toggle bg-gray-800 hover:bg-gray-700 p-3 rounded-lg border border-gray-600 transition-colors">
                        <span id="theme-icon">ðŸŒ™</span>
                    </button>
                    
                    <!-- Smart Time Period Filter -->
                    <div class="bg-gray-800 px-4 py-2 rounded-lg relative">
                        <label class="text-sm text-gray-400 block mb-1">Time Period</label>
                        <select id="time-period" class="bg-gray-700 text-white text-sm rounded px-3 py-1 border border-gray-600">
                            <option value="all">ðŸ“Š All Months (Feb-Jun 2025)</option>
                            <optgroup label="ðŸ“… Quarters">
                                <option value="Q1">Q1 (Feb-Apr 2025)</option>
                                <option value="Q2">Q2 (May-Jun 2025)</option>
                            </optgroup>
                            <optgroup label="ðŸ“† Individual Months">
                                <option value="2025-02">February 2025</option>
                                <option value="2025-03">March 2025</option>
                                <option value="2025-04">April 2025</option>
                                <option value="2025-05">May 2025</option>
                                <option value="2025-06">June 2025</option>
                            </optgroup>
                        </select>
                        <div id="time-period-indicator" class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full opacity-0 transition-opacity duration-300 pulse"></div>
                    </div>
                    
                    <!-- Location Filter -->
                    <div class="bg-gray-800 px-4 py-2 rounded-lg relative">
                        <label class="text-sm text-gray-400 block mb-1">Location Filter</label>
                        <select id="location-filter" class="bg-gray-700 text-white text-sm rounded px-3 py-1 border border-gray-600">
                            <option value="all">All Locations</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <div id="location-indicator" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full opacity-0 transition-opacity duration-300 pulse"></div>
                    </div>
                    
                    <!-- Region Filter -->
                    <div class="bg-gray-800 px-4 py-2 rounded-lg relative">
                        <label class="text-sm text-gray-400 block mb-1">Region Filter</label>
                        <select id="region-filter" class="bg-gray-700 text-white text-sm rounded px-3 py-1 border border-gray-600">
                            <option value="all">All Regions</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <div id="region-indicator" class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full opacity-0 transition-opacity duration-300 pulse"></div>
                    </div>
                    
                    <!-- Animated Stats -->
                    <div class="flex space-x-4 text-center">
                        <div class="metric-card px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors transform hover:scale-105 active:scale-95" style="animation-delay: 0.2s;" onclick="openTechniciansModal()" title="Click to view all technicians by region">
                            <div class="text-2xl font-bold text-blue-200 animated-number" id="technicians">...</div>
                            <div class="text-sm text-gray-200">Technicians</div>
                            <div class="progress-bar mt-2" style="--progress: 75%;"></div>
                        </div>

                        <div class="metric-card px-4 py-2 rounded-lg" style="animation-delay: 0.6s;">
                            <div class="text-2xl font-bold text-blue-200 animated-number number-pulse" id="customers">...</div>
                            <div class="text-sm text-gray-200">Customers</div>
                            <div class="progress-bar mt-2" style="--progress: 95%;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Row: Assignment Group Filter -->
                <div class="flex items-center space-x-6">
                    <!-- Theme Toggle Placeholder (for alignment) -->
                    <div class="w-12"></div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-12 gap-6">

            
            <!-- Charts - Full Width -->
            <div class="col-span-12">
                <!-- Trends Section -->
                <div class="bg-gray-800 rounded-xl p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-white">Trends</h2>
                    
                    <!-- Charts Grid Layout -->
                    <div class="grid grid-cols-3 gap-6">
                        <!-- Top Row - 3 Charts -->
                        <!-- Incident Delta Î” Chart -->
                        <div class="chart-container bg-gray-700 rounded-lg p-4 relative">
                            <div class="refresh-indicator" id="incident-refresh"></div>
                            <div class="flex items-center mb-2">
                                <h3 class="text-lg font-medium floating" id="incident-title">Incident Delta Î”</h3>
                            </div>
                            <div class="text-xs text-gray-400 mb-2" id="incident-subtitle">FY 2026 - Last 6 Months</div>
                            <div class="flex items-center mb-3">
                                <span class="text-2xl font-bold text-white animated-number" id="incident-total">...</span>
                                <span class="text-xs text-gray-400 ml-2">total</span>
                                <span class="text-lg font-medium text-white ml-3 animated-number" id="incident-delta">...</span>
                                <span class="text-xs text-gray-400 ml-1">Î” change</span>
                            </div>
                            <div style="height: 250px;">
                                <canvas id="incidentChart"></canvas>
                            </div>
                        </div>

                        <!-- MTTR Delta Î” Chart -->
                        <div class="chart-container bg-gray-700 rounded-lg p-4 relative">
                            <div class="refresh-indicator" id="mttr-refresh"></div>
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-medium text-pink-300 floating">MTTR Delta Î”</h3>
                                <button onclick="openMTTRCompareMode()" class="px-3 py-1 text-xs font-medium bg-pink-600 hover:bg-pink-700 text-white rounded-full transition-colors duration-200 flex items-center space-x-1" title="Compare months">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <span>Compare</span>
                                </button>
                            </div>
                            <div class="text-xs text-gray-400 mb-2" id="mttr-subtitle">FY 2026 - Last 6 Months</div>
                            <div class="flex items-center mb-3">
                                <span class="text-2xl font-bold text-white animated-number" id="mttr-total">...</span>
                                <span class="text-xs text-gray-400 ml-2">avg MTTR</span>
                            </div>
                            <div style="height: 250px;">
                                <canvas id="mttrChart"></canvas>
                            </div>
                        </div>

                        <!-- FCR Delta Î” Chart -->
                        <div class="chart-container bg-gray-700 rounded-lg p-4 relative">
                            <div class="refresh-indicator" id="fcr-refresh"></div>
                            <div class="flex items-center mb-2">
                                <h3 class="text-lg font-medium text-purple-300 floating">FCR Delta Î”</h3>
                            </div>
                            <div class="text-xs text-gray-400 mb-2" id="fcr-subtitle">FY 2026 - Last 6 Months</div>
                            <div class="flex items-center mb-3">
                                <span class="text-2xl font-bold text-white animated-number number-pulse" id="fcr-total">...</span>
                                <span class="text-xs text-gray-400 ml-2">total FCR</span>
                            </div>
                            <div style="height: 250px;">
                                <canvas id="fcrChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom Row - 2 Charts -->
                    <div class="grid grid-cols-2 gap-6 mt-6">
                        <!-- Trending Issues (KB Usage) Chart -->
                        <div class="chart-container bg-gray-700 rounded-lg p-4 relative">
                            <div class="refresh-indicator" id="kb-refresh"></div>
                            <div class="flex items-center mb-2">
                                <span class="text-xl mr-2 floating">ðŸ“š</span>
                                <h3 class="text-lg font-medium text-yellow-300 floating">Trending Issues (KB Usage)</h3>
                            </div>
                            <div class="text-xs text-gray-400 mb-2" id="kb-subtitle">FY 2026 - Most Used Knowledge Base Articles</div>
                            <div class="flex items-center mb-3">
                                <span class="text-2xl font-bold text-white animated-number" id="kb-total">...</span>
                                <span class="text-xs text-gray-400 ml-1">unique KBs</span>
                                <span class="text-lg font-medium text-white ml-3 animated-number" id="kb-coverage">...</span>
                                <span class="text-xs text-gray-400 ml-1">coverage</span>
                            </div>
                            
                            <!-- Top KB Articles List -->
                            <div class="bg-gray-600 border border-gray-500 rounded-lg p-3 mb-4" id="kb-trending-list">
                                <div class="flex items-center mb-2">
                                    <h4 class="text-sm font-medium text-gray-200">Top 10 Trending Issues</h4>
                                </div>
                                <div class="space-y-2 text-xs max-h-64 overflow-y-auto" id="kb-articles-container">
                                    <!-- KB articles will be populated here -->
                                    <div class="loading-text" style="color: var(--text-muted);">Loading trending issues...</div>
                                </div>
                            </div>
                        </div>

                        <!-- SLA Breach Chart with Critical Alert -->
                        <div class="chart-container bg-gray-700 rounded-lg p-4 relative">
                            <div class="refresh-indicator" id="breach-refresh"></div>
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-2 floating">ðŸš¨</span>
                                <h3 class="text-lg font-medium text-red-300 floating">SLA Breaches</h3>
                            </div>
                            <div class="text-xs text-gray-400 mb-2" id="breach-subtitle">FY 2026 - Last 6 Months (MTTR > 240min)</div>
                            <div class="flex items-center mb-3">
                                <span class="text-2xl font-bold text-white animated-number" id="breach-total">...</span>
                                <span class="text-xs text-gray-400 ml-1">total breaches</span>
                                <span class="text-lg font-medium text-white ml-3 animated-number" id="breach-rate">...</span>
                                <span class="text-xs text-gray-400 ml-1">breach rate</span>
                            </div>
                            
                            <!-- Enhanced Critical Breach Alert -->
                            <div class="critical-alert bg-gray-600 border border-gray-500 rounded-lg p-3 mb-4" id="critical-breach-alert" style="display: none;">
                                <div class="flex items-center mb-2">
                                    <h4 class="text-sm font-medium text-gray-200">SLA Breach Breakdown</h4>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                    <div class="metric-card bg-gray-500 rounded p-2 cursor-pointer hover:bg-gray-400 transition-colors transform hover:scale-105 active:scale-95" style="animation-delay: 0.1s;" onclick="showSlaBreachIncidents('critical')" title="Click to view critical SLA breach incidents">
                                        <div class="text-lg font-bold text-white animated-number" id="critical-total">...</div>
                                        <div class="text-red-300">Critical</div>
                                        <div class="text-gray-300">>4hrs over</div>
                                    </div>
                                    <div class="metric-card bg-gray-500 rounded p-2 cursor-pointer hover:bg-gray-400 transition-colors transform hover:scale-105 active:scale-95" style="animation-delay: 0.2s;" onclick="showSlaBreachIncidents('moderate')" title="Click to view moderate SLA breach incidents">
                                        <div class="text-lg font-bold text-white animated-number" id="moderate-total">...</div>
                                        <div class="text-orange-300">Moderate</div>
                                        <div class="text-gray-300">3-4hrs over</div>
                                    </div>
                                    <div class="metric-card bg-gray-500 rounded p-2" style="animation-delay: 0.4s;">
                                        <div class="text-lg font-bold text-white animated-number" id="flagged-teams">...</div>
                                        <div class="text-gray-200">Teams</div>
                                        <div class="text-gray-300">Flagged</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="height: 180px;">
                                <canvas id="breachChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Third Row - AI Insights (Full Width) -->
                    <div class="grid grid-cols-1 gap-6 mt-6">
                        <!-- AI Insights Chart - Full Width -->
                        <div class="chart-container bg-gray-700 rounded-lg p-4 relative">
                            <div class="refresh-indicator" id="ai-refresh"></div>
                            <div class="flex items-center mb-2">
                                <span class="text-xl mr-2 floating">ðŸ¤–</span>
                                <h3 class="text-lg font-medium text-blue-200 floating">AI Insights</h3>
                            </div>
                            <div class="text-xs text-gray-400 mb-2" id="ai-subtitle">FY 2026 - Data-Driven Operational Insights</div>
                            <div class="flex items-center mb-3">
                                <span class="text-2xl font-bold text-white animated-number" id="ai-insights-count">...</span>
                                <span class="text-xs text-gray-400 ml-1">key insights</span>
                            </div>
                            
                            <!-- AI Insights List - Full Width Layout -->
                            <div class="bg-gray-600 border border-gray-500 rounded-lg p-3 mb-4 max-h-96 overflow-y-auto" id="ai-insights-container">
                                <div class="space-y-3 text-xs" id="ai-insights-list">
                                    <!-- AI insights will be populated here -->
                                    <div class="loading-text" style="color: var(--text-muted);">Generating AI insights...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Team Performance Section -->
        <div class="mt-8 bg-gray-800 rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 text-white">Team Performance - All Teams (<span id="team-count">28</span>)</h2>
            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-gray-800 z-10 shadow-md">
                        <tr class="border-b border-gray-700 bg-gray-800" style="color: var(--text-muted);">
                            <th class="text-left py-3 px-2 bg-gray-800">Rank</th>
                            <th class="text-left py-3 px-2 bg-gray-800">Team</th>
                            <th class="text-right py-3 px-2 bg-gray-800">Incidents</th>
                            <th class="text-right py-3 px-2 bg-gray-800">Avg Resolution (hrs)</th>
                            <th class="text-right py-3 px-2 bg-gray-800">FCR Rate (%)</th>
                            <th class="text-right py-3 px-2 bg-gray-800">SLA Goal (%)</th>
                            <th class="text-right py-3 px-2 bg-gray-800">SLA Baseline (%)</th>
                            <th class="text-right py-3 px-2 bg-gray-800">SLA Breaches</th>
                            <th class="text-right py-3 px-2 bg-gray-800">Breach Rate (%)</th>
                            <th class="text-right py-3 px-2 bg-gray-800">Critical Breaches</th>
                        </tr>
                    </thead>
                    <tbody id="team-performance-table" class="text-white">
                        <!-- Team data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <div class="flex items-center justify-center space-x-2">
                <span>Walmart</span>
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Global Tech</span>
            </div>
                            <div class="mt-2">Â© 2024 Walmart Inc. All Rights Reserved. SENSITIVE INFORMATION FOR CLASSIFICATION</div>
                <div class="mt-1 text-xs" style="color: var(--text-disabled);">Developed by Jonathan J and Nitin G</div>
        </div>
    </div>

    <!-- Team Drill-Down Modal -->
    <div id="team-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold" id="modal-team-name" style="color: var(--modal-text);">Team Drill-Down</h3>
                        <p class="text-sm" id="modal-quarter-info" style="color: var(--modal-text-secondary);">Team-Specific Performance Analysis</p>
                    </div>
                    
                    <!-- Smart Time Period Filter for Team-Specific Drill-Down -->
                    <div class="flex items-center space-x-3 mr-4">
                        <label class="text-sm font-medium" style="color: var(--modal-text-secondary);">Time Period:</label>
                        <select id="modal-time-period-filter" class="rounded-lg px-3 py-1 text-sm border transition-colors" 
                                style="background-color: var(--modal-card-bg); color: var(--modal-text); border-color: var(--modal-border);"
                                onchange="handleModalTimePeriodChange()">
                            <option value="all">ðŸ“Š All Months (Feb-Jun 2025)</option>
                            <optgroup label="ðŸ“… Quarters">
                                <option value="Q1">Q1 (Feb-Apr 2025)</option>
                                <option value="Q2">Q2 (May-Jun 2025)</option>
                            </optgroup>
                            <optgroup label="ðŸ“† Individual Months">
                                <option value="2025-02">February 2025</option>
                                <option value="2025-03">March 2025</option>
                                <option value="2025-04">April 2025</option>
                                <option value="2025-05">May 2025</option>
                                <option value="2025-06">June 2025</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <button onclick="closeTeamDrillDown()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)';" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent';">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div id="modal-content">
                <!-- Loading State -->
                <div id="modal-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <p class="mt-4" style="color: var(--modal-text-secondary);">Loading team data...</p>
                </div>

                <!-- Team Overview Cards -->
                <div id="modal-data" class="hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-2xl font-bold" id="drill-incidents" style="color: var(--modal-text);">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Total Incidents</div>
                            <div class="text-xs text-blue-300 mt-1" id="drill-incident-trend">--</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-2xl font-bold" id="drill-fcr" style="color: var(--modal-text);">0%</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">FCR Rate</div>
                            <div class="text-xs text-purple-300 mt-1" id="drill-fcr-trend">--</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-2xl font-bold" id="drill-mttr" style="color: var(--modal-text);">0h</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Avg MTTR</div>
                            <div class="text-xs text-pink-300 mt-1" id="drill-mttr-trend">--</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="flex justify-center mb-2">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-cyan-300" id="drill-sla-goal">0%</div>
                                    <div class="text-xs" style="color: var(--modal-text-secondary);">Goal (3h)</div>
                                </div>
                            </div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">SLA Compliance</div>
                        </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Team Incident Trend -->
                        <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                            <h4 class="text-lg font-medium mb-3" style="color: var(--modal-text);">Monthly Incident Trend</h4>
                            <div style="height: 200px;">
                                <canvas id="team-incident-chart"></canvas>
                            </div>
                        </div>

                        <!-- Team Performance Metrics -->
                        <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                            <h4 class="text-lg font-medium mb-3" style="color: var(--modal-text);">Performance Metrics</h4>
                            <div style="height: 200px;">
                                <canvas id="team-metrics-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- SLA Breach Analysis -->
                    <div class="rounded-lg p-4 mb-6" style="background-color: var(--modal-card-bg);">
                        <h4 class="text-lg font-medium mb-4" style="color: var(--modal-text);">SLA Breach Analysis</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-red-400" id="drill-critical-breaches">0</div>
                                <div style="color: var(--modal-text-secondary);">Critical Breaches</div>
                                <div class="text-xs" style="color: var(--modal-text-secondary);">>4hrs over</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-orange-400" id="drill-moderate-breaches">0</div>
                                <div style="color: var(--modal-text-secondary);">Moderate Breaches</div>
                                <div class="text-xs" style="color: var(--modal-text-secondary);">3-4hrs over</div>
                            </div>
                        </div>
                    </div>

                    <!-- Highest SLA Breach Incidents Table -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-medium" style="color: var(--modal-text);">Highest SLA Breach Incidents (Top 10)</h4>
                            <div class="text-xs" style="color: var(--modal-text-secondary);">
                                Sorted by longest resolution time â°
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead style="color: var(--modal-text-secondary); border-bottom: 1px solid var(--modal-border);">
                                    <tr>
                                        <th class="text-left py-2 px-2">Incident ID</th>
                                        <th class="text-left py-2 px-2">Priority</th>
                                        <th class="text-left py-2 px-2">Created</th>
                                        <th class="text-right py-2 px-2">Resolution Time</th>
                                        <th class="text-right py-2 px-2">SLA Variance</th>
                                        <th class="text-right py-2 px-2">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-incidents-table" style="color: var(--modal-text);">
                                    <!-- Highest SLA breach incidents will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Details Modal -->
    <div id="incident-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] transition-all duration-300" style="backdrop-filter: blur(4px);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" 
                 id="incident-modal-content" style="background-color: var(--modal-bg);">
                
                <!-- Modal Header -->
                <div class="border-b p-6" style="border-color: var(--modal-border); background-color: var(--modal-header-bg);">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-2xl font-bold" style="color: var(--modal-text);" id="incident-modal-title">
                                Incident Details
                            </h3>
                            <p class="text-sm mt-1" style="color: var(--modal-text-secondary);" id="incident-modal-subtitle">
                                Comprehensive incident analysis
                            </p>
                        </div>
                        <button onclick="closeIncidentDetails()" 
                                class="transition-colors" 
                                style="color: var(--text-muted);" 
                                onmouseover="this.style.color='var(--text-primary)';" 
                                onmouseout="this.style.color='var(--text-muted)';"
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="p-6 space-y-6">
                    <!-- Loading State -->
                    <div id="incident-loading" class="text-center py-8">
                        <div class="inline-flex items-center space-x-2 text-blue-400">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400"></div>
                            <span class="text-lg font-medium">Loading incident details...</span>
                        </div>
                    </div>

                    <!-- Content Container -->
                    <div id="incident-content" class="hidden space-y-6">
                        
                        <!-- Basic Information -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                                <h4 class="text-lg font-semibold mb-3" style="color: var(--modal-text);">Basic Information</h4>
                                <div class="space-y-2" id="basic-info">
                                    <!-- Basic info will be populated here -->
                                </div>
                            </div>

                            <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                                <h4 class="text-lg font-semibold mb-3" style="color: var(--modal-text);">Timing Analysis</h4>
                                <div class="space-y-2" id="timing-analysis">
                                    <!-- Timing analysis will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                            <h4 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Incident Timeline</h4>
                            <div class="space-y-3" id="incident-timeline">
                                <!-- Timeline will be populated here -->
                            </div>
                        </div>

                        <!-- Technical Notes & Knowledge Base -->
                        <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                            <h4 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Technical Notes & Knowledge Base</h4>
                            <div class="space-y-4" id="tech-notes">
                                <!-- Tech notes will be populated here -->
                            </div>
                        </div>

                        <!-- Root Cause Analysis -->
                        <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                            <h4 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Root Cause Analysis</h4>
                            <div class="space-y-4" id="root-cause-analysis">
                                <!-- Root cause analysis will be populated here -->
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="border-t p-6" style="border-color: var(--modal-border); background-color: var(--modal-header-bg);">
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeIncidentDetails()" 
                                class="px-4 py-2 rounded-lg border transition-colors"
                                style="border-color: var(--modal-border); color: var(--modal-text); background-color: var(--modal-card-bg);">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SLA Breach Incidents Modal -->
    <div id="sla-breach-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-red-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 19c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold" id="sla-modal-title" style="color: var(--modal-text);">SLA Breach Incidents</h3>
                        <p class="text-sm" id="sla-modal-description" style="color: var(--modal-text-secondary);">Incident Analysis by Severity Level</p>
                    </div>
                    
                    <!-- Severity Badge -->
                    <div class="flex items-center space-x-3 mr-4">
                        <div id="sla-severity-badge" class="px-3 py-1 rounded-full text-sm font-medium">
                            <span id="sla-severity-text">Critical</span>
                        </div>
                    </div>
                </div>
                <button onclick="closeSlaBreachModal()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)';" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent';">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div id="sla-modal-content">
                <!-- Loading State -->
                <div id="sla-modal-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
                    <p class="mt-4" style="color: var(--modal-text-secondary);">Loading SLA breach incidents...</p>
                </div>

                <!-- SLA Breach Incidents Data -->
                <div id="sla-modal-data" class="hidden">
                    <!-- Summary Card -->
                    <div class="rounded-lg p-4 mb-6" style="background-color: var(--modal-card-bg);">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-3xl font-bold" id="sla-total-count" style="color: var(--modal-text);">0</div>
                                <div class="text-sm" style="color: var(--modal-text-secondary);">Total Incidents</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-orange-400" id="sla-avg-variance">0h</div>
                                <div class="text-sm" style="color: var(--modal-text-secondary);">Avg SLA Variance</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-purple-400" id="sla-affected-teams">0</div>
                                <div class="text-sm" style="color: var(--modal-text-secondary);">Affected Teams</div>
                            </div>
                        </div>
                    </div>

                    <!-- Incidents Table -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-medium" style="color: var(--modal-text);">Incident Details</h4>
                            <div class="text-xs" style="color: var(--modal-text-secondary);">
                                Sorted by highest SLA variance âš ï¸
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead style="color: var(--modal-text-secondary); border-bottom: 1px solid var(--modal-border);">
                                    <tr>
                                        <th class="text-left py-2 px-2">Incident ID</th>
                                        <th class="text-left py-2 px-2">Priority</th>
                                        <th class="text-left py-2 px-2">Team</th>
                                        <th class="text-left py-2 px-2">Created</th>
                                        <th class="text-right py-2 px-2">Resolution Time</th>
                                        <th class="text-right py-2 px-2">SLA Variance</th>
                                        <th class="text-left py-2 px-2">Application</th>
                                    </tr>
                                </thead>
                                <tbody id="sla-incidents-table" style="color: var(--modal-text);">
                                    <!-- Incidents will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="border-t pt-4 mt-6" style="border-color: var(--modal-border);">
                <div class="flex justify-end space-x-3">
                    <button onclick="closeSlaBreachModal()" 
                            class="px-4 py-2 rounded-lg border transition-colors"
                            style="border-color: var(--modal-border); color: var(--modal-text); background-color: var(--modal-card-bg);">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Technicians Modal -->
    <div id="technicians-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold" style="color: var(--modal-text);">All Technicians</h3>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Technicians by Region & Activity</p>
                    </div>
                </div>
                <button onclick="closeTechniciansModal()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)';" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent';">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div id="technicians-modal-content">
                <!-- Loading State -->
                <div id="technicians-modal-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <p class="mt-4" style="color: var(--modal-text-secondary);">Loading technicians data...</p>
                </div>

                <!-- Technicians Data -->
                <div id="technicians-modal-data" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-3xl font-bold text-blue-400" id="tech-total">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Total Technicians</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-3xl font-bold text-green-400" id="tech-active">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Active This Period</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-3xl font-bold text-yellow-400" id="tech-avg-incidents">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Avg Incidents/Tech</div>
                        </div>
                    </div>

                    <!-- Technicians by Region -->
                    <div id="tech-regions-container">
                        <!-- Region sections will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Locations Modal -->
    <div id="locations-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-purple-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold" style="color: var(--modal-text);">All Locations</h3>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Locations by Region & Activity</p>
                    </div>
                </div>
                <button onclick="closeLocationsModal()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)';" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent';">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div id="locations-modal-content">
                <!-- Loading State -->
                <div id="locations-modal-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500"></div>
                    <p class="mt-4" style="color: var(--modal-text-secondary);">Loading locations data...</p>
                </div>

                <!-- Locations Data -->
                <div id="locations-modal-data" class="hidden">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-3xl font-bold text-purple-400" id="loc-total">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Total Locations</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-3xl font-bold text-green-400" id="loc-active">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Active This Period</div>
                        </div>
                        <div class="rounded-lg p-4 text-center" style="background-color: var(--modal-card-bg);">
                            <div class="text-3xl font-bold text-orange-400" id="loc-avg-incidents">0</div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">Avg Incidents/Location</div>
                        </div>
                    </div>

                    <!-- Locations by Region -->
                    <div id="loc-regions-container">
                        <!-- Region sections will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MTTR Drill-Down Modal -->
    <div id="mttr-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-amber-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold" id="mttr-modal-title" style="color: var(--modal-text);">MTTR Analysis</h3>
                        <p class="text-sm" id="mttr-modal-description" style="color: var(--modal-text-secondary);">Detailed breakdown for <span id="mttr-month-name">Month</span></p>
                        <p class="text-xs mt-1 px-2 py-1 rounded" style="color: var(--modal-text-secondary); background-color: var(--modal-card-bg);">ðŸ“Š Complete dataset - All regions, teams, and time periods</p>
                    </div>
                </div>
                <button onclick="closeMTTRDrillDown()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)';" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent';">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Modal Content -->
            <div id="mttr-modal-content">
                <!-- Loading State -->
                <div id="mttr-modal-loading" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
                    <p class="mt-4" style="color: var(--modal-text-secondary);">Analyzing MTTR data...</p>
                </div>

                <!-- MTTR Analysis Data -->
                <div id="mttr-modal-data" class="hidden">
                    <!-- Month Comparison Header -->
                    <div class="rounded-lg p-4 mb-6" style="background-color: var(--modal-card-bg);">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-medium" style="color: var(--modal-text);">Month-to-Month Comparison</h4>
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2">
                                    <select id="current-month-selector" class="text-sm px-3 py-1 rounded-full bg-amber-600 text-white border-none focus:ring-2 focus:ring-amber-500 focus:outline-none cursor-pointer" onchange="updateCurrentMonth()">
                                        <option value="">Select First Month</option>
                                        <option value="2025-02">February 2025</option>
                                        <option value="2025-03">March 2025</option>
                                        <option value="2025-04">April 2025</option>
                                        <option value="2025-05">May 2025</option>
                                        <option value="2025-06">June 2025</option>
                                    </select>
                            </div>
                                <span class="text-sm" style="color: var(--modal-text-secondary);">vs</span>
                                <div class="flex items-center space-x-2">
                                    <select id="comparison-month-selector" class="text-sm px-3 py-1 rounded-full bg-blue-600 text-white border-none focus:ring-2 focus:ring-blue-500 focus:outline-none cursor-pointer" onchange="updateComparison()">
                                        <option value="">Select Second Month</option>
                                        <option value="2025-02">February 2025</option>
                                        <option value="2025-03">March 2025</option>
                                        <option value="2025-04">April 2025</option>
                                        <option value="2025-05">May 2025</option>
                                        <option value="2025-06">June 2025</option>
                                    </select>
                                    <button onclick="refreshComparison()" class="text-sm px-2 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white transition-colors" title="Refresh comparison">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                    </button>
                            </div>
                        </div>
                    </div>

                        <!-- Side-by-side comparison -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Current Month Complete Card -->
                            <div class="border border-gray-600 rounded-lg p-4">
                                <div class="text-center mb-4">
                                    <h5 class="text-lg font-semibold text-amber-400" id="current-month-title">Current Month</h5>
                            </div>
                                <div id="current-month-complete-content" style="transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;">
                                    <!-- This will be populated with complete month data -->
                                    <div class="text-center py-4">
                                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-amber-400 mx-auto"></div>
                                        <p class="text-sm text-gray-400 mt-2">Loading...</p>
                        </div>
                            </div>
                        </div>

                            <!-- Comparison Month Complete Card -->
                            <div class="border border-gray-600 rounded-lg p-4">
                                <div class="text-center mb-4">
                                    <h5 class="text-lg font-semibold text-gray-400" id="comparison-month-title">Select Month to Compare</h5>
                            </div>
                                <div id="comparison-month-complete-content" style="transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;">
                                    <!-- This will be populated with comparison month data -->
                                    <div class="text-center py-8">
                                        <p class="text-sm" style="color: var(--modal-text-secondary);">Select a month from the dropdown above to view comparison</p>
                        </div>
                    </div>
                            </div>
                        </div>
                    </div>





                    <!-- Month-to-Month Insights -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h4 class="text-lg font-medium mb-4" style="color: var(--modal-text);">Month-to-Month Analysis & Recommendations</h4>
                        <div id="month-comparison-insights" style="transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;">
                            <div class="text-center py-8">
                                <p class="text-sm" style="color: var(--modal-text-secondary);">Select a comparison month to view detailed insights and recommendations</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Drill-Down Modal -->
    <div id="incident-drilldown-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-cyan-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold" style="color: var(--modal-text);">Incident Analysis - <span id="incident-month-name"></span></h2>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Detailed breakdown of incident patterns and root causes</p>
                    </div>
                </div>
                <button onclick="closeIncidentDrillDown()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)'" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Loading State -->
            <div id="incident-modal-loading" class="text-center py-12">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background-color: var(--modal-card-bg);">
                    <svg class="animate-spin h-8 w-8 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p style="color: var(--modal-text-secondary);">Loading incident analysis...</p>
            </div>

            <!-- Modal Content -->
            <div id="incident-modal-data" class="hidden space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Total Incidents</div>
                        <div class="text-2xl font-bold text-cyan-400" id="incident-total-count">0</div>
                    </div>
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Avg Daily</div>
                        <div class="text-2xl font-bold text-cyan-400" id="incident-avg-daily">0</div>
                    </div>
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Major Incidents</div>
                        <div class="text-2xl font-bold text-red-400" id="incident-major-percentage">0%</div>
                    </div>
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Peak Hour</div>
                        <div class="text-2xl font-bold text-cyan-400" id="incident-peak-hour">0</div>
                    </div>
                </div>

                <!-- Main Analysis Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Affected Applications -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Most Affected Applications/Services</h3>
                        <div id="incident-applications-list" class="space-y-2"></div>
                    </div>

                    <!-- Top KB Articles Used -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Top KB Articles Used</h3>
                        <div id="incident-kb-articles-list" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Critical Incidents Sample -->
                <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Critical Incidents</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--modal-border);">
                                    <th class="text-left py-2 px-2" style="color: var(--modal-text-secondary);">Incident</th>
                                    <th class="text-left py-2 px-2" style="color: var(--modal-text-secondary);">Description</th>
                                    <th class="text-left py-2 px-2" style="color: var(--modal-text-secondary);">Team</th>
                                    <th class="text-right py-2 px-2" style="color: var(--modal-text-secondary);">MTTR</th>
                                </tr>
                            </thead>
                            <tbody id="incident-critical-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Drill-Down Modal -->
    <div id="applicationDrillDownModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] transition-all duration-300" style="backdrop-filter: blur(4px);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto transform transition-all duration-300 scale-95 opacity-0" 
                 id="applicationDrillDownModalContent" style="background-color: var(--modal-bg);">
                
                <!-- Modal Header -->
                <div class="border-b p-6" style="border-color: var(--modal-border); background-color: var(--modal-header-bg);">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-2xl font-bold" style="color: var(--modal-text);">
                                Application/Service Analysis
                            </h3>
                            <p class="text-sm mt-1" style="color: var(--modal-text-secondary);">
                                Detailed incident breakdown by application type
                            </p>
                        </div>
                        <button onclick="closeApplicationDrillDownModal()" 
                                class="text-gray-400 hover:text-gray-200 text-2xl font-bold p-2 rounded-lg hover:bg-gray-700 transition-colors">
                            Ã—
                        </button>
                    </div>
                </div>

                <!-- Modal Content -->
                <div class="p-6" id="applicationDrillDownContent">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- FCR Drill-Down Modal -->
    <div id="fcr-drilldown-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center modal-backdrop">
        <div class="rounded-xl p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto modal-content" style="background-color: var(--modal-bg); color: var(--modal-text);">
            <!-- Modal Header -->
            <div class="flex items-center justify-between mb-6 pb-4" style="border-bottom: 1px solid var(--modal-border);">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 rounded-lg p-2">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold" style="color: var(--modal-text);">FCR Analysis - <span id="fcr-month-name"></span></h2>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">First Contact Resolution patterns and reopen analysis</p>
                    </div>
                </div>
                <button onclick="closeFCRDrillDown()" class="transition-colors p-2 rounded-lg" style="color: var(--modal-text-secondary); background-color: transparent;" onmouseover="this.style.color='var(--modal-text)'; this.style.backgroundColor='var(--modal-card-bg)'" onmouseout="this.style.color='var(--modal-text-secondary)'; this.style.backgroundColor='transparent'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Loading State -->
            <div id="fcr-modal-loading" class="text-center py-12">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background-color: var(--modal-card-bg);">
                    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p style="color: var(--modal-text-secondary);">Loading FCR analysis...</p>
            </div>

            <!-- Modal Content -->
            <div id="fcr-modal-data" class="hidden space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">FCR Rate</div>
                        <div class="text-2xl font-bold text-blue-400" id="fcr-rate-value">0%</div>
                    </div>
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Total Incidents</div>
                        <div class="text-2xl font-bold text-blue-400" id="fcr-total-incidents">0</div>
                    </div>
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Successful FCR</div>
                        <div class="text-2xl font-bold text-green-400" id="fcr-successful">0</div>
                    </div>
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <div class="text-sm" style="color: var(--modal-text-secondary);">Reopened</div>
                        <div class="text-2xl font-bold text-red-400" id="fcr-reopened">0</div>
                    </div>
                </div>

                <!-- KB Impact Analysis -->
                <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Knowledge Base Impact on FCR</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-lg" style="background-color: var(--modal-bg);">
                            <div class="flex items-center justify-between mb-2">
                                <span style="color: var(--modal-text-secondary);">With KB Article</span>
                                <span class="text-green-400 font-bold" id="fcr-kb-rate">0%</span>
                            </div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">
                                <span id="fcr-kb-count">0</span> incidents
                            </div>
                        </div>
                        <div class="p-4 rounded-lg" style="background-color: var(--modal-bg);">
                            <div class="flex items-center justify-between mb-2">
                                <span style="color: var(--modal-text-secondary);">Without KB Article</span>
                                <span class="text-orange-400 font-bold" id="fcr-no-kb-rate">0%</span>
                            </div>
                            <div class="text-sm" style="color: var(--modal-text-secondary);">
                                <span id="fcr-no-kb-count">0</span> incidents
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Performance -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Best Performing Teams -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Best Performing Teams</h3>
                        <div id="fcr-best-teams" class="space-y-2"></div>
                    </div>

                    <!-- Worst Performing Teams -->
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Teams Needing Improvement</h3>
                        <div id="fcr-worst-teams" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Reopen Reasons -->
                <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Top Reasons for Reopens</h3>
                    <div id="fcr-reopen-reasons" class="space-y-2"></div>
                </div>

                <!-- Incident Types FCR -->
                <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">FCR by Incident Type</h3>
                    <div id="fcr-incident-types" class="space-y-2"></div>
                </div>

                <!-- Sample Reopened Incidents -->
                <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--modal-text);">Sample Reopened Incidents</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr style="border-bottom: 1px solid var(--modal-border);">
                                    <th class="text-left py-2 px-2" style="color: var(--modal-text-secondary);">Incident</th>
                                    <th class="text-left py-2 px-2" style="color: var(--modal-text-secondary);">Description</th>
                                    <th class="text-left py-2 px-2" style="color: var(--modal-text-secondary);">Team</th>
                                    <th class="text-right py-2 px-2" style="color: var(--modal-text-secondary);">Reopens</th>
                                </tr>
                            </thead>
                            <tbody id="fcr-reopened-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CACHE BUSTER TIMESTAMP: {{ timestamp }} -->
    <script>
        // ULTIMATE CACHE BUSTER - VERSION 4.0 - TIMESTAMP BASED
        console.log('ðŸš€ðŸš€ðŸš€ ULTIMATE CACHE BUSTER ACTIVE - VERSION 4.0');
        console.log('ðŸš€ðŸš€ðŸš€ TIMESTAMP:', new Date().toISOString());
        console.log('ðŸš€ðŸš€ðŸš€ TEAM DRILL-DOWN DEBUGGING ACTIVE');
        console.log('ðŸš€ðŸš€ðŸš€ CACHE BUSTER ID:', Math.random().toString(36).substr(2, 9));
        console.log('ðŸš€ðŸš€ðŸš€ HTML TEMPLATE CACHE BUSTER ACTIVE');
        console.log('ðŸš€ðŸš€ðŸš€ IF YOU SEE THIS, CACHE BUSTING IS WORKING!');
        
        // IMMEDIATE ERROR OVERRIDE - REPLACE ALL toLocaleString CALLS
        const originalToLocaleString = Number.prototype.toLocaleString;
        Number.prototype.toLocaleString = function() {
            console.log('ðŸ”§ toLocaleString called on:', this, 'type:', typeof this);
            if (this === null || this === undefined || isNaN(this)) {
                console.warn('âš ï¸ toLocaleString called on invalid value:', this);
                return '0';
            }
            return originalToLocaleString.call(this);
        };
        
        // Chart.js default configuration
        Chart.defaults.color = '#e2e8f0';
        Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';

        // Global variables to store chart instances
        let incidentChart, fcrChart, mttrChart, slaChart, breachChart;
        let currentTimePeriod = 'all'; // Replaces currentQuarter and currentMonth
        let currentLocation = 'all';
        let currentRegion = 'all';
        let currentAssignmentGroup = 'all';
        let currentDrillDownMonth = null;
        
        // Flags to prevent modal reopening immediately after closing
        let modalClosing = false;
        let fcrModalClosing = false;
        let mttrModalClosing = false;
        let incidentDrilldownModalClosing = false;
        let slaBreachModalClosing = false;
        
        // Initialize chart colors for dark mode
        window.chartGridColor = 'rgba(255, 255, 255, 0.1)';
        window.chartTickColor = '#9ca3af';

        // Helper function to parse time period into quarter and month
        function parseTimePeriod(timePeriod) {
            if (timePeriod === 'all') {
                return { quarter: 'all', month: 'all' };
            } else if (timePeriod === 'Q1' || timePeriod === 'Q2') {
                return { quarter: timePeriod, month: 'all' };
            } else if (timePeriod.match(/^\d{4}-\d{2}$/)) {
                // Month format: "2025-02", "2025-03", etc.
                return { quarter: 'all', month: timePeriod };
            }
            return { quarter: 'all', month: 'all' };
        }

        // API calls to fetch data
        async function fetchOverviewData() {
            try {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                const response = await fetch(`/api/overview?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`);
                const data = await response.json();
                updateOverviewMetrics(data);
            } catch (error) {
                console.error('Error fetching overview data:', error);
            }
        }

        async function fetchTrendsData() {
            try {
                console.log('Fetching trends data...');
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                const url = `/api/trends?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`;
                console.log('Trends API URL:', url);
                const response = await fetch(url);
                console.log('Trends API response status:', response.status);
                const data = await response.json();
                console.log('Trends API data:', data);
                updateCharts(data);
            } catch (error) {
                console.error('Error fetching trends data:', error);
            }
        }

        async function fetchTeamPerformance() {
            try {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                const response = await fetch(`/api/team_performance?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`);
                const data = await response.json();
                updateTeamPerformanceTable(data);
            } catch (error) {
                console.error('Error fetching team performance data:', error);
            }
        }

        async function fetchSLABreachData() {
            try {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                const response = await fetch(`/api/sla_breach?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`);
                const data = await response.json();
                updateCriticalBreachAlert(data);
            } catch (error) {
                console.error('Error fetching SLA breach data:', error);
            }
        }

        async function fetchRegions() {
            try {
                const response = await fetch('/api/regions');
                const data = await response.json();
                populateRegionFilters(data.regions, data.region_stats);
            } catch (error) {
                console.error('Error fetching regions data:', error);
            }
        }


        async function fetchKBTrendingData() {
            try {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                const response = await fetch(`/api/kb_trending?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`);
                const data = await response.json();
                updateKBTrendingDisplay(data);
            } catch (error) {
                console.error('Error fetching KB trending data:', error);
            }
        }

        async function fetchAIInsights() {
            try {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                const response = await fetch(`/api/ai_insights?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`);
                const data = await response.json();
                updateAIInsightsDisplay(data);
            } catch (error) {
                console.error('Error fetching AI insights:', error);
            }
        }

        // Function to refresh all data with animations
        function refreshAllData() {
            showDataRefreshIndicators();
            fetchOverviewData();
            fetchTrendsData();
            fetchTeamPerformance();
            fetchSLABreachData();
            fetchKBTrendingData();
            fetchAIInsights();
        }

        // Filter management functions
        function populateRegionFilters(regions, regionStats) {
            const mainFilter = document.getElementById('region-filter');
            const modalFilter = document.getElementById('modal-region-filter');
            
            // Clear existing options (except "All Regions")
            [mainFilter, modalFilter].forEach(select => {
                if (select) {
                    while (select.children.length > 1) {
                        select.removeChild(select.lastChild);
                    }
                }
            });
            
            // Add region options with incident counts
            regions.forEach(region => {
                if (region !== 'all') {
                    const stats = regionStats.find(s => s.region === region);
                    const count = stats ? stats.incidents : 0;
                    const percentage = stats ? stats.percentage : 0;
                    const optionText = `${region} (${count.toLocaleString()} - ${percentage}%)`;
                    
                    [mainFilter, modalFilter].forEach(select => {
                        if (select) {
                            const option = document.createElement('option');
                            option.value = region;
                            option.textContent = optionText;
                            select.appendChild(option);
                        }
                    });
                }
            });
        }

        // Location filtering functions
        let locationToRegionMapping = {};
        
        async function fetchLocations() {
            try {
                const response = await fetch('/api/locations');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading locations:', data.error);
                    return;
                }

                populateLocationFilters(data.locations);
            } catch (error) {
                console.error('Error fetching locations:', error);
            }
        }

        function populateLocationFilters(locations) {
            const locationFilter = document.getElementById('location-filter');
            
            // Clear existing options except "All Locations"
            locationFilter.innerHTML = '<option value="all">All Locations</option>';
            
            // Add location options
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.value;
                option.textContent = location.display_name;
                locationFilter.appendChild(option);
                
                // Store location to region mapping (will be updated by smart filtering)
                locationToRegionMapping[location.value] = location.region || 'all';
            });
        }

        // Store all group stats globally for smart filtering




        // Removed syncFilters function - filters are now independent between main dashboard and modals
        
        function updateMainDashboardFilters() {
            // Only update main dashboard filters and data
            const mainTimePeriod = document.getElementById('time-period');
            const mainRegion = document.getElementById('region-filter');
            
            // Update current filter values from main dashboard only
            currentTimePeriod = mainTimePeriod.value;
            currentRegion = mainRegion.value;
            
            // Update dashboard titles
            updateDashboardTitles();
            
            // Refresh only main dashboard data
            refreshAllData();
            
            // Show filter notification
            showFilterNotification();
        }

        function handleLocationChange() {
            const selectedLocation = document.getElementById('location-filter').value;
            currentLocation = selectedLocation;
            
            // Smart filtering: If specific location is selected, auto-select the corresponding region
            if (selectedLocation !== 'all') {
                fetch(`/api/location-region?location=${encodeURIComponent(selectedLocation)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.region) {
                            const regionFilter = document.getElementById('region-filter');
                            if (regionFilter.value !== data.region) {
                                regionFilter.value = data.region;
                                currentRegion = data.region;
                                showSmartFilterNotification(`ðŸŽ¯ Auto-selected ${data.region} region for this location`);
                            }
                        }
                    })
                    .catch(error => console.error('Error getting location region:', error));
            }
            
            // Update main dashboard filters and refresh data
            updateMainDashboardFilters();
        }

        function handleRegionChange() {
            const selectedRegion = document.getElementById('region-filter').value;
            currentRegion = selectedRegion;
            
            // Smart filtering: If region is selected, update location filter to show only locations in that region
            if (selectedRegion !== 'all') {
                fetch(`/api/locations?region=${selectedRegion}`)
                    .then(response => response.json())
                    .then(data => {
                        const locationFilter = document.getElementById('location-filter');
                        // Store current location selection
                        const currentLocationValue = locationFilter.value;
                        
                        // Clear existing options except "All Locations"
                        locationFilter.innerHTML = '<option value="all">All Locations</option>';
                        
                        // Add location options for this region
                        data.locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location.value;
                            option.textContent = location.display_name;
                            locationFilter.appendChild(option);
                            
                            // Update location to region mapping
                            locationToRegionMapping[location.value] = selectedRegion;
                        });
                        
                        // If previous location is still in the list, keep it selected
                        if ([...locationFilter.options].some(opt => opt.value === currentLocationValue)) {
                            locationFilter.value = currentLocationValue;
                        } else {
                            // Otherwise reset to "all"
                            locationFilter.value = 'all';
                            
                            // Show notification about filtered locations
                            showSmartFilterNotification(`ðŸ“ Showing ${data.locations.length} locations in ${selectedRegion}`);
                        }
                    })
                    .catch(error => console.error('Error fetching filtered locations:', error));
            } else {
                // Reset to all locations
                fetchLocations();
            }
            
            // Show notification about filtered locations  
            if (selectedRegion !== 'all') {
                // Region filtering notification handled by location filter logic
            }
            
            // Assignment group filter removed - using location filter instead
            
            // Update main dashboard filters and refresh data
            updateMainDashboardFilters();
        }

        function handleTimePeriodChange() {
            const timePeriodFilter = document.getElementById('time-period');
            currentTimePeriod = timePeriodFilter.value;
            
            // Show notification about the selected time period
            let periodDescription = '';
            
            if (currentTimePeriod === 'all') {
                periodDescription = 'All months (Feb-Jun 2025)';
            } else if (currentTimePeriod === 'Q1') {
                periodDescription = 'Q1 2025 (Feb-Apr)';
            } else if (currentTimePeriod === 'Q2') {
                periodDescription = 'Q2 2025 (May-Jun)';
            } else if (currentTimePeriod.match(/^\d{4}-\d{2}$/)) {
                const monthNames = {
                    '02': 'February', '03': 'March', '04': 'April', 
                    '05': 'May', '06': 'June'
                };
                const monthNum = currentTimePeriod.split('-')[1];
                periodDescription = `${monthNames[monthNum]} 2025`;
            }
            
            showSmartFilterNotification(`ðŸ“… Time period: ${periodDescription}`);
            
            // Update main dashboard filters and refresh data
            updateMainDashboardFilters();
        }



        // Modal filter handler for time period changes (team-specific drill-down)
        function handleModalTimePeriodChange() {
            // Update the team drill-down data with the new time period filter
            if (window.currentDrillDownTeam) {
                // Get the selected time period
                const modalTimePeriod = document.getElementById('modal-time-period-filter');
                const selectedTimePeriod = modalTimePeriod.value;
                
                console.log(`Time period changed to: ${selectedTimePeriod} for team: ${window.currentDrillDownTeam}`);
                
                // Update the modal time period info display
                updateModalTimePeriodInfo();
                
                // Refresh the team drill-down data with the new time period
                fetchTeamDrillDownData(window.currentDrillDownTeam);
            } else {
                console.log('No current drill-down team set');
            }
        }

        function updateModalTimePeriodInfo() {
            // Update modal time period display based on current selection
            const modalTimePeriod = document.getElementById('modal-time-period-filter');
            if (modalTimePeriod) {
                const selectedTimePeriod = modalTimePeriod.value;
                console.log(`Modal time period updated to: ${selectedTimePeriod}`);
                
                // You can add additional UI updates here if needed
                // For example, updating modal title or subtitle based on time period
            }
        }

        // Smart filter notification system
        function showSmartFilterNotification(message) {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('smart-filter-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'smart-filter-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    background-color: var(--modal-header-bg);
                    color: var(--modal-text);
                    border: 2px solid #06F27B;
                    border-radius: 8px;
                    padding: 12px 16px;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 4px 12px rgba(6, 242, 123, 0.2);
                    transform: translateX(100%);
                    opacity: 0;
                    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                    max-width: 300px;
                    backdrop-filter: blur(10px);
                `;
                document.body.appendChild(notification);
            }
            
            // Update message and show
            notification.textContent = message;
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                notification.style.opacity = '0';
            }, 3000);
        }

        // Main dashboard filter notification
        function showFilterNotification() {
            const timePeriod = document.getElementById('time-period').value;
            const region = document.getElementById('region-filter').value;
            const assignmentGroup = 'all';
            
            // Update visual indicators
            updateFilterIndicators(timePeriod, currentLocation, region, assignmentGroup);
            
            let filterParts = [];
            
            // Time period
            if (timePeriod === 'Q1') {
                filterParts.push('Q1 (Feb-Apr)');
            } else if (timePeriod === 'Q2') {
                filterParts.push('Q2 (May-Jun)');
            } else {
                filterParts.push('All Time');
            }
            
            // Region
            if (region !== 'all') {
                filterParts.push(`${region} Region`);
            }
            
            // Assignment group
            if (assignmentGroup !== 'all') {
                const groupName = assignmentGroup.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot 2 - ', '');
                filterParts.push(`${groupName} Team`);
            }
            
            const message = `ðŸ“Š Dashboard: ${filterParts.join(', ')}`;
            showSmartFilterNotification(message);
        }

        // Update visual filter indicators
        function updateFilterIndicators(timePeriod, location, region, assignmentGroup) {
            // Time period indicator
            const timePeriodIndicator = document.getElementById('time-period-indicator');
            if (timePeriod !== 'all') {
                timePeriodIndicator.style.opacity = '1';
            } else {
                timePeriodIndicator.style.opacity = '0';
            }
            
            // Location indicator
            const locationIndicator = document.getElementById('location-indicator');
            if (location !== 'all') {
                locationIndicator.style.opacity = '1';
            } else {
                locationIndicator.style.opacity = '0';
            }
            
            // Region indicator
            const regionIndicator = document.getElementById('region-indicator');
            if (region !== 'all') {
                regionIndicator.style.opacity = '1';
            } else {
                regionIndicator.style.opacity = '0';
            }
            
            // Assignment group filter removed - using location filter instead
            
            // Save filter state to localStorage
            saveFilterState(timePeriod, location, region, assignmentGroup);
        }

        // Filter state persistence
        function saveFilterState(timePeriod, location, region, assignmentGroup) {
            const filterState = {
                timePeriod: timePeriod,
                location: location,
                region: region,
                assignmentGroup: assignmentGroup,
                timestamp: Date.now()
            };
            localStorage.setItem('dashboardFilters', JSON.stringify(filterState));
        }

        function loadFilterState() {
            try {
                const saved = localStorage.getItem('dashboardFilters');
                if (saved) {
                    const filterState = JSON.parse(saved);
                    
                    // Check if saved state is not too old (24 hours)
                    const hoursSinceLastUse = (Date.now() - filterState.timestamp) / (1000 * 60 * 60);
                    if (hoursSinceLastUse < 24) {
                        return filterState;
                    }
                }
            } catch (error) {
                console.warn('Failed to load filter state:', error);
            }
            return null;
        }

        function applyFilterState(filterState) {
            if (!filterState) return;
            
            // Apply saved filters to UI
            const timePeriodFilter = document.getElementById('time-period-filter');
            const locationFilter = document.getElementById('location-filter');
            const regionFilter = document.getElementById('region-filter');
            
            if (timePeriodFilter && filterState.timePeriod) {
                timePeriodFilter.value = filterState.timePeriod;
            }
            if (locationFilter && filterState.location) {
                locationFilter.value = filterState.location;
            }
            if (regionFilter && filterState.region) {
                regionFilter.value = filterState.region;
            }
            
            // Update current variables
            currentTimePeriod = filterState.timePeriod || 'all';
            currentLocation = filterState.location || 'all';
            currentRegion = filterState.region || 'all';
            
            // Update visual indicators
            updateFilterIndicators(currentTimePeriod, currentLocation, currentRegion, 'all');
            
            console.log('âœ… Restored filter state:', filterState);
        }

        // Helper function to get current filter context
        function getFilterContext() {
            const timePeriod = currentTimePeriod === 'all' ? 'All Time' : currentTimePeriod;
            const region = currentRegion === 'all' ? 'All Regions' : currentRegion;
            const team = currentAssignmentGroup === 'all' ? 'All Teams' : currentAssignmentGroup;
            
            return { timePeriod, region, team };
        }

        // Helper function to get expected incident count from chart data
        function getExpectedIncidentCountFromChart(monthDate) {
            try {
                // Get the incident chart instance
                if (incidentChart && incidentChart.data && incidentChart.data.datasets) {
                    const dataset = incidentChart.data.datasets[0];
                    const labels = incidentChart.data.labels;
                    
                    // Find the index for the given month
                    const monthIndex = labels.findIndex(label => {
                        // Convert month date (YYYY-MM) to short month name for comparison
                        const [year, month] = monthDate.split('-');
                        const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                        const shortMonth = date.toLocaleDateString('en-US', { month: 'short' });
                        return label === shortMonth;
                    });
                    
                    if (monthIndex !== -1 && dataset.data[monthIndex] !== undefined) {
                        return dataset.data[monthIndex];
                    }
                }
                return null;
            } catch (error) {
                console.error('Error getting expected incident count from chart:', error);
                return null;
            }
        }
        
        // Helper function to get expected FCR rate from chart data
        function getExpectedFCRRateFromChart(monthDate) {
            try {
                // Get the FCR chart instance
                if (fcrChart && fcrChart.data && fcrChart.data.datasets) {
                    const dataset = fcrChart.data.datasets[0];
                    const labels = fcrChart.data.labels;
                    
                    // Find the index for the given month
                    const monthIndex = labels.findIndex(label => {
                        // Convert month date (YYYY-MM) to short month name for comparison
                        const [year, month] = monthDate.split('-');
                        const date = new Date(parseInt(year), parseInt(month) - 1, 1);
                        const shortMonth = date.toLocaleDateString('en-US', { month: 'short' });
                        return label === shortMonth;
                    });
                    
                    if (monthIndex !== -1 && dataset.data[monthIndex] !== undefined) {
                        return dataset.data[monthIndex];
                    }
                }
                return null;
            } catch (error) {
                console.error('Error getting expected FCR rate from chart:', error);
                return null;
            }
        }
        
        // Helper function to get team data from main table for validation
        function getTeamDataFromMainTable(teamName) {
            const teamRows = document.querySelectorAll('#team-performance-table tr');
            for (let row of teamRows) {
                const teamCell = row.querySelector('.team-name');
                if (teamCell && teamCell.textContent.trim() === teamName) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 9) {
                        return {
                            team: teamName,
                            incidents: parseInt(cells[2].textContent.replace(/,/g, '')) || 0,
                            avgResolutionTime: parseFloat(cells[3].textContent) || 0,
                            fcrRate: parseFloat(cells[4].textContent.replace('%', '')) || 0,
                            slaGoalCompliance: parseFloat(cells[5].textContent.replace('%', '')) || 0,
                            slaComplianceMttr: parseFloat(cells[6].textContent.replace('%', '')) || 0,
                            slaBreaches: parseInt(cells[7].textContent.replace(/,/g, '')) || 0,
                            slaBreachRate: parseFloat(cells[8].textContent.replace('%', '')) || 0,
                            criticalBreaches: parseInt(cells[9].textContent.replace(/,/g, '')) || 0
                        };
                    }
                    break;
                }
            }
            return null;
        }
        
        // Drill-down scope notifications
        function showDrillDownNotification(type, scope, filterContext = null) {
            let message = '';
            switch(type) {
                case 'month':
                    message = `ðŸ“… ${scope} - Complete Data (All Teams & Regions)`;
                    break;
                case 'team':
                    message = `ðŸ¢ ${scope} Team Performance`;
                    break;
                case 'sla_breach':
                    if (filterContext) {
                        const filters = [];
                        if (filterContext.timePeriod !== 'All Time') filters.push(filterContext.timePeriod);
                        if (filterContext.region !== 'All Regions') filters.push(filterContext.region);
                        if (filterContext.team !== 'All Teams') filters.push(filterContext.team);
                        
                        const filterText = filters.length > 0 ? ` (${filters.join(', ')})` : ' (All Data)';
                        message = `ðŸš¨ ${scope} SLA Breaches${filterText}`;
                    } else {
                        message = `ðŸš¨ ${scope} SLA Breaches`;
                    }
                    break;
                default:
                    message = `ðŸ“Š ${scope} Data`;
            }
            showSmartFilterNotification(message);
        }

        // Technicians Modal Functions
        function openTechniciansModal() {
            console.log('ðŸ‘¥ Opening Technicians Modal');
            const modal = document.getElementById('technicians-modal');
            const modalLoading = document.getElementById('technicians-modal-loading');
            const modalData = document.getElementById('technicians-modal-data');
            
            if (!modal) {
                console.error('Technicians modal element not found!');
                return;
            }
            
            console.log('Modal elements found, showing modal...');
            // Show modal and loading state
            modal.classList.remove('hidden');
            modalLoading.classList.remove('hidden');
            modalData.classList.add('hidden');
            
            // Fetch technicians data
            console.log('Fetching technicians data...');
            const { quarter, month } = parseTimePeriod(currentTimePeriod);
            const queryParams = new URLSearchParams({
                quarter: quarter,
                month: month,
                region: currentRegion,
                assignment_group: currentAssignmentGroup
            });
            
            const apiUrl = `/api/technicians?${queryParams}`;
            console.log('Technicians API URL:', apiUrl);
            
            fetch(apiUrl)
                .then(response => {
                    console.log('Technicians API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Technicians API data:', data);
                    populateTechniciansModal(data);
                })
                .catch(error => {
                    console.error('Error fetching technicians data:', error);
                    console.error('Error details:', error.message, error.stack);
                    modalLoading.innerHTML = `<p class="text-red-400">Error loading technicians data: ${error.message}</p>`;
                });
        }

        function populateTechniciansModal(data) {
            // Update summary cards
            document.getElementById('tech-total').textContent = data.total_technicians || 0;
            document.getElementById('tech-active').textContent = data.active_technicians || 0;
            document.getElementById('tech-avg-incidents').textContent = (data.avg_incidents_per_tech || 0).toFixed(1);
            
            // Populate regions container
            const container = document.getElementById('tech-regions-container');
            container.innerHTML = '';
            
            data.regions.forEach(region => {
                const regionDiv = document.createElement('div');
                regionDiv.className = 'mb-6';
                regionDiv.innerHTML = `
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h4 class="text-lg font-medium mb-3 text-blue-400">${region.name} Region</h4>
                        <div class="text-sm text-gray-400 mb-3">${region.technicians.length} technicians</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-64 overflow-y-auto">
                            ${region.technicians.map(tech => `
                                <div class="flex justify-between items-center p-2 rounded" style="background-color: var(--modal-bg);">
                                    <span class="font-medium" style="color: var(--modal-text);">${tech.name}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-blue-300">${tech.incidents} incidents</div>
                                        <div class="text-xs" style="color: var(--modal-text-secondary);">${tech.percentage}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(regionDiv);
            });
            
            // Show data and hide loading
            document.getElementById('technicians-modal-loading').classList.add('hidden');
            document.getElementById('technicians-modal-data').classList.remove('hidden');
        }

        function closeTechniciansModal() {
            const modal = document.getElementById('technicians-modal');
            modal.classList.add('hidden');
        }

        // Locations Modal Functions
        function openLocationsModal() {
            console.log('ðŸ“ Opening Locations Modal');
            const modal = document.getElementById('locations-modal');
            const modalLoading = document.getElementById('locations-modal-loading');
            const modalData = document.getElementById('locations-modal-data');
            
            if (!modal) {
                console.error('Locations modal element not found!');
                return;
            }
            
            console.log('Modal elements found, showing modal...');
            // Show modal and loading state
            modal.classList.remove('hidden');
            modalLoading.classList.remove('hidden');
            modalData.classList.add('hidden');
            
            // Fetch locations data
            console.log('Fetching locations data...');
            const { quarter, month } = parseTimePeriod(currentTimePeriod);
            const queryParams = new URLSearchParams({
                quarter: quarter,
                month: month,
                region: currentRegion,
                assignment_group: currentAssignmentGroup
            });
            
            const apiUrl = `/api/locations?${queryParams}`;
            console.log('Locations API URL:', apiUrl);
            
            fetch(apiUrl)
                .then(response => {
                    console.log('Locations API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Locations API data:', data);
                    populateLocationsModal(data);
                })
                .catch(error => {
                    console.error('Error fetching locations data:', error);
                    console.error('Error details:', error.message, error.stack);
                    modalLoading.innerHTML = `<p class="text-red-400">Error loading locations data: ${error.message}</p>`;
                });
        }

        function populateLocationsModal(data) {
            // Update summary cards
            document.getElementById('loc-total').textContent = data.total_locations || 0;
            document.getElementById('loc-active').textContent = data.total_locations || 0;
            document.getElementById('loc-avg-incidents').textContent = '0.0';
            
            // Populate regions container
            const container = document.getElementById('loc-regions-container');
            container.innerHTML = '';
            
            // Create a simple list of locations
            const regionDiv = document.createElement('div');
            regionDiv.className = 'mb-6';
            regionDiv.innerHTML = `
                <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                    <h4 class="text-lg font-medium mb-3 text-purple-400">All Locations</h4>
                    <div class="space-y-2">
                        ${data.locations.map(location => `
                            <div class="flex justify-between items-center p-2 rounded" style="background-color: var(--modal-bg);">
                                <span style="color: var(--modal-text);">${location.display_name}</span>
                                <span class="text-sm" style="color: var(--modal-text-secondary);">Active</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.appendChild(regionDiv);
            
            // Hide loading and show data
            document.getElementById('locations-modal-loading').classList.add('hidden');
            document.getElementById('locations-modal-data').classList.remove('hidden');
        }
        
        // Skip the rest of the original function
        if (false) { // Disable the original code
            data.regions.forEach(region => {
                const regionDiv = document.createElement('div');
                regionDiv.className = 'mb-6';
                regionDiv.innerHTML = `
                    <div class="rounded-lg p-4" style="background-color: var(--modal-card-bg);">
                        <h4 class="text-lg font-medium mb-3 text-purple-400">${region.name} Region</h4>
                        <div class="text-sm text-gray-400 mb-3">${region.locations.length} locations</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-64 overflow-y-auto">
                            ${region.locations.map(loc => `
                                <div class="flex justify-between items-center p-2 rounded" style="background-color: var(--modal-bg);">
                                    <span class="font-medium" style="color: var(--modal-text);">${loc.name}</span>
                                    <div class="text-right">
                                        <div class="text-sm font-bold text-purple-300">${loc.incidents} incidents</div>
                                        <div class="text-xs" style="color: var(--modal-text-secondary);">${loc.percentage}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(regionDiv);
            });
            
            // Show data and hide loading
            document.getElementById('locations-modal-loading').classList.add('hidden');
            document.getElementById('locations-modal-data').classList.remove('hidden');
        }

        function closeLocationsModal() {
            const modal = document.getElementById('locations-modal');
            modal.classList.add('hidden');
        }

        // Walmart-compliant animation functions
        function showDataRefreshIndicators() {
            const indicators = ['incident-refresh', 'fcr-refresh', 'mttr-refresh', 'sla-refresh', 'breach-refresh', 'kb-refresh', 'ai-refresh'];
            indicators.forEach((id, index) => {
                setTimeout(() => {
                    const indicator = document.getElementById(id);
                    if (indicator) {
                        indicator.style.animation = 'refreshPulse 0.5s ease-in-out';
                        setTimeout(() => {
                            indicator.style.animation = '';
                        }, 500);
                    }
                }, index * 100);
            });
        }

        function animateNumberChange(elementId, newValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Parse the current and target values
            const currentText = element.textContent;
            let currentValue = 0; // Always start from 0 for a clean animation
            const targetValue = parseFloat(newValue.toString().replace(/[^\d.]/g, '')) || 0;
            
            // Don't animate if target value is 0 or very small
            if (targetValue < 0.1) {
                if (suffix === 'total') {
                    element.textContent = targetValue.toLocaleString() + ' ' + suffix;
                } else {
                    element.textContent = newValue + suffix;
                }
                return;
            }
            
            // Add subtle visual indicator that numbers are updating
            element.classList.add('number-pulse');
            
            // Use easeOutQuint for smooth, professional animation
            // This creates a quick start and gentle finish
            const duration = 1200; // Slightly longer for smoother effect
            const steps = 40;     // More steps for smoother animation
            let currentStep = 0;
            
            const interval = setInterval(() => {
                currentStep++;
                
                // Use easeOutQuint function for smooth animation
                // t: current time, b: start value, c: change in value, d: duration
                const t = currentStep;
                const b = currentValue;
                const c = targetValue - currentValue;
                const d = steps;
                
                // easeOutQuint: time = 1-(1-t)^5
                const time = 1 - Math.pow(1 - (t/d), 5);
                const displayValue = b + (c * time);
                
                if (currentStep >= steps) {
                    // Final value - ensure exact formatting
                    if (suffix === 'total') {
                        element.textContent = targetValue.toLocaleString() + ' ' + suffix;
                    } else if (suffix.includes('%')) {
                        element.textContent = targetValue.toFixed(1) + suffix;
                    } else {
                        element.textContent = newValue + suffix;
                    }
                    
                    clearInterval(interval);
                    setTimeout(() => {
                        element.classList.remove('number-pulse');
                    }, 500); // Shorter pulse effect
                } else {
                    // During animation
                    if (suffix.includes('%')) {
                        // Percentage values - show one decimal place
                        element.textContent = displayValue.toFixed(1) + suffix;
                    } else if (suffix === 'total') {
                        // Format with commas and space before 'total'
                        element.textContent = Math.round(displayValue).toLocaleString() + ' ' + suffix;
                    } else if (suffix === 'h') {
                        // Hours - show one decimal place
                        element.textContent = displayValue.toFixed(1) + suffix;
                    } else {
                        // Other values - round to whole numbers during animation
                        element.textContent = Math.round(displayValue) + suffix;
                    }
                }
            }, duration / steps);
        }

        function triggerChartAnimation(chartId) {
            const chartElement = document.getElementById(chartId);
            if (chartElement) {
                chartElement.style.animation = 'none';
                setTimeout(() => {
                    chartElement.style.animation = 'walmartFadeInUp 0.6s ease-out';
                }, 10);
            }
        }

        function addHoverEffects() {
            // Add enhanced hover effects to metric cards
            const metricCards = document.querySelectorAll('.metric-card');
            metricCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'translateY(-3px) scale(1.02)';
                    card.style.boxShadow = '0 8px 25px rgba(6, 242, 123, 0.15)';
                });
                
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'translateY(0) scale(1)';
                    card.style.boxShadow = '';
                });
            });
        }

        function updateCriticalBreachAlert(data) {
            const alertSection = document.getElementById('critical-breach-alert');
            const severity = data.severity_breakdown;
            
            // Update severity counts with staggered animations (with defensive programming)
            animateNumberChange('critical-total', (severity.critical_breaches || 0).toLocaleString());
            setTimeout(() => animateNumberChange('moderate-total', (severity.moderate_breaches || 0).toLocaleString()), 200);
            
            // Count teams with critical breaches
            const { quarter, month } = parseTimePeriod(currentTimePeriod);
            fetch(`/api/team_performance?quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`)
                .then(response => response.json())
                .then(teamData => {
                    const flaggedTeams = teamData.filter(team => team.critical_breaches > 0).length;
                    setTimeout(() => animateNumberChange('flagged-teams', (flaggedTeams || 0).toLocaleString()), 600);
                })
                .catch(error => console.error('Error fetching team data for flags:', error));
            
            // Show/hide alert with animation based on critical breaches
            if (severity.critical_breaches > 0) {
                alertSection.style.display = 'block';
                alertSection.style.animation = 'walmartFadeInUp 0.5s ease-out';
            } else {
                alertSection.style.animation = 'walmartFadeInUp 0.3s ease-out reverse';
                setTimeout(() => {
                    alertSection.style.display = 'none';
                }, 300);
            }
        }

        function updateOverviewMetrics(data) {
            // Animate header stats with staggered timing
            animateNumberChange('technicians', data.technicians);
            setTimeout(() => animateNumberChange('customers', data.customers, '+'), 100);
            
            // Update chart totals with synchronized timing (no staggering) for consistent behavior
            setTimeout(() => {
                // Format incident total with space (no comma)
                const formattedIncidentTotal = (data.total_incidents || 0).toLocaleString();
                document.getElementById('incident-total').textContent = formattedIncidentTotal;
                // Add incident delta percentage with proper animation
                animateNumberChange('incident-delta', data.incident_change, '%');
                animateNumberChange('fcr-total', data.fcr_rate, '%');
                animateNumberChange('mttr-total', data.avg_resolution_time, 'h');
                animateNumberChange('sla-goal', data.sla_goal_compliance, '%');
            animateNumberChange('sla-baseline', data.sla_compliance_mttr, '%');
                animateNumberChange('breach-total', (data.sla_breaches || 0).toLocaleString());
                animateNumberChange('breach-rate', data.sla_breach_rate, '%');
            }, 300);
        }

        function updateKBTrendingDisplay(data) {
            if (data.status !== 'success') {
                console.error('KB trending data error:', data.error);
                return;
            }
            
            // Update summary metrics
            animateNumberChange('kb-total', data.summary.unique_kb_articles);
            animateNumberChange('kb-coverage', data.summary.kb_coverage_percentage.toFixed(1), '%');
            
            // Update top KB articles list with meaningful issue descriptions
            const articlesContainer = document.getElementById('kb-articles-container');
            if (articlesContainer && data.top_kb_articles) {
                let articlesHTML = '';
                data.top_kb_articles.slice(0, 10).forEach((article, index) => {
                    const barWidth = (article.percentage / data.top_kb_articles[0].percentage * 100);
                    articlesHTML += `
                        <div class="p-3 bg-gray-500 rounded-lg transition-colors hover:bg-gray-400" style="animation-delay: ${index * 0.1}s;">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <div class="text-white font-medium text-sm">${article.issue_description}</div>
                                    <div class="text-gray-300 text-xs mt-1">KB: ${article.kb_id}</div>
                                </div>
                                <div class="ml-3 text-right">
                                    <div class="text-white font-bold">${article.count}</div>
                                    <div class="text-gray-300 text-xs">${article.percentage}%</div>
                                </div>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-1">
                                <div class="bg-yellow-400 h-1 rounded-full transition-all duration-500" style="width: ${barWidth}%;"></div>
                            </div>
                        </div>
                    `;
                });
                articlesContainer.innerHTML = articlesHTML;
            }
        }

        function updateAIInsightsDisplay(data) {
            if (data.status !== 'success') {
                console.error('AI insights data error:', data.error);
                return;
            }
            
            // Update summary metrics
            animateNumberChange('ai-insights-count', data.insights_count);
            
            // Update insights list
            const insightsContainer = document.getElementById('ai-insights-list');
            if (insightsContainer && data.insights) {
                let insightsHTML = '';
                
                // Add filter context information at the top if filters are active
                if (data.data_summary && (data.data_summary.analysis_period !== 'all' || data.data_summary.region_filter !== 'all')) {
                    let filterInfo = [];
                    if (data.data_summary.analysis_period !== 'all') {
                        const quarterText = data.data_summary.analysis_period === 'Q1' ? 'Q1 (Feb-Apr)' : 
                                           data.data_summary.analysis_period === 'Q2' ? 'Q2 (May-Jun)' : data.data_summary.analysis_period;
                        filterInfo.push(`ðŸ“… ${quarterText}`);
                    }
                    if (data.data_summary.region_filter !== 'all') {
                        filterInfo.push(`ðŸŒ ${data.data_summary.region_filter}`);
                    }
                    
                    if (filterInfo.length > 0) {
                        insightsHTML += `
                            <div class="mb-3 p-2 bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg">
                                <div class="flex items-center text-xs">
                                    <span class="text-blue-300 font-medium mr-2">ðŸ” Active Filters:</span>
                                    <span class="text-blue-200">${filterInfo.join(' â€¢ ')}</span>
                                </div>
                                <div class="text-xs text-blue-200 mt-1">
                                    Analyzing ${(data.data_summary.total_incidents || 0).toLocaleString()} incidents
                                </div>
                            </div>
                        `;
                    }
                }
                
                data.insights.forEach((insight, index) => {
                    const severityColor = insight.severity === 'high' ? 'text-red-300' : 
                                        insight.severity === 'medium' ? 'text-orange-300' : 'text-green-300';
                    const severityIcon = insight.severity === 'high' ? 'âš ï¸' : 
                                        insight.severity === 'medium' ? 'ðŸ“Š' : 'âœ…';
                    
                    insightsHTML += `
                        <div class="p-3 bg-gray-500 rounded-lg border-l-4 border-${insight.severity === 'high' ? 'red' : insight.severity === 'medium' ? 'orange' : 'green'}-400 transition-all hover:bg-gray-400" style="animation-delay: ${index * 0.1}s;">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center">
                                    <span class="mr-2">${severityIcon}</span>
                                    <span class="text-white font-medium text-sm">${insight.title}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs ${severityColor} font-medium">${insight.category}</span>
                                    <span class="text-xs text-gray-300">${insight.confidence}%</span>
                                </div>
                            </div>
                            <p class="text-gray-200 text-xs mb-2 leading-relaxed">${insight.description}</p>
                            <div class="mt-2 p-2 bg-gray-600 rounded text-xs">
                                <span class="text-blue-300 font-medium">ðŸ’¡ Recommendation:</span>
                                <span class="text-gray-200 ml-1">${insight.recommendation}</span>
                            </div>
                        </div>
                    `;
                });
                insightsContainer.innerHTML = insightsHTML;
            }
        }

        function updateChartsForTheme() {
            // Update incident chart colors only
            if (incidentChart) {
                const incidentColors = currentTheme === 'dark' ? {
                    border: '#06d6a0',  // Bright cyan/teal for dark mode visibility
                    background: 'rgba(6, 214, 160, 0.1)',
                    point: '#06d6a0',
                    pointBorder: '#05b085'
                } : {
                    border: '#0891b2',  // Cyan-600 for light mode
                    background: 'rgba(8, 145, 178, 0.1)',
                    point: '#0891b2',
                    pointBorder: '#0e7490'
                };
                
                incidentChart.data.datasets[0].borderColor = incidentColors.border;
                incidentChart.data.datasets[0].backgroundColor = incidentColors.background;
                incidentChart.data.datasets[0].pointBackgroundColor = incidentColors.point;
                incidentChart.data.datasets[0].pointBorderColor = incidentColors.pointBorder;
                incidentChart.options.scales.y.grid.color = window.chartGridColor;
                incidentChart.options.scales.y.ticks.color = window.chartTickColor;
                incidentChart.options.scales.x.grid.color = window.chartGridColor;
                incidentChart.options.scales.x.ticks.color = window.chartTickColor;
                incidentChart.update('none'); // Update without animation
            }

            // Update other charts grid colors
            [fcrChart, mttrChart, slaChart, breachChart].forEach(chart => {
                if (chart) {
                    chart.options.scales.y.grid.color = window.chartGridColor;
                    chart.options.scales.y.ticks.color = window.chartTickColor;
                    chart.options.scales.x.grid.color = window.chartGridColor;
                    chart.options.scales.x.ticks.color = window.chartTickColor;
                    chart.update('none'); // Update without animation
                }
            });
        }

        function updateCharts(data) {
            console.log('updateCharts called with data:', data);
            if (!data || !data.incident_trends || !data.incident_trends.data) {
                console.error('Invalid data structure for charts:', data);
                return;
            }
            const months = data.incident_trends.data.map(d => {
                // Parse YYYY-MM format more explicitly to avoid timezone issues
                const [year, month] = d.month.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, 1); // month is 0-indexed in Date constructor
                return date.toLocaleDateString('en-US', { month: 'short' });
            });

            // Total incidents now exclusively updated in updateOverviewMetrics() for consistent animation
            // No fallback logic here to prevent race conditions and ensure smooth animations

            // Incident Chart
            console.log('Creating incident chart...');
            const incidentChartElement = document.getElementById('incidentChart');
            if (!incidentChartElement) {
                console.error('incidentChart canvas element not found!');
                return;
            }
            const incidentCtx = incidentChartElement.getContext('2d');
            if (incidentChart) {
                console.log('Destroying existing incident chart');
                incidentChart.destroy();
            }
            
            // Dynamic colors based on theme for better visibility
            const incidentColors = currentTheme === 'dark' ? {
                border: '#06d6a0',  // Bright cyan/teal for dark mode visibility
                background: 'rgba(6, 214, 160, 0.1)',
                point: '#06d6a0',
                pointBorder: '#05b085'
            } : {
                border: '#0891b2',  // Cyan-600 for light mode
                background: 'rgba(8, 145, 178, 0.1)',
                point: '#0891b2',
                pointBorder: '#0e7490'
            };
            
            console.log('Creating new Chart.js instance for incidents');
            console.log('Chart data:', {
                labels: months,
                data: data.incident_trends.data.map(d => d.value)
            });
            incidentChart = new Chart(incidentCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        data: data.incident_trends.data.map(d => d.value),
                        borderColor: incidentColors.border,
                        backgroundColor: incidentColors.background,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: incidentColors.point,
                        pointBorderColor: incidentColors.pointBorder,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: incidentColors.pointBorder,
                        pointHoverBorderColor: incidentColors.point,
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'Click for detailed analysis';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { 
                                color: window.chartTickColor || '#9ca3af',
                                precision: 0
                            }
                        },
                        x: { 
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: window.chartTickColor || '#9ca3af' }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0 && !modalClosing && !incidentDrilldownModalClosing) {
                            const index = elements[0].index;
                            const monthLabel = months[index];
                            const monthValue = data.incident_trends.data[index];
                            
                            // Convert month label to date format (e.g., "Feb" -> "2025-02")
                            const monthMap = {
                                'Feb': '2025-02',
                                'Mar': '2025-03',
                                'Apr': '2025-04',
                                'May': '2025-05',
                                'Jun': '2025-06'
                            };
                            
                            const monthDate = monthMap[monthLabel];
                            if (monthDate) {
                                incidentDrilldownModalClosing = false; // Reset flag before opening
                                openIncidentDrillDown(monthDate, monthLabel, monthValue.value);
                            }
                        }
                    },
                    onHover: function(event, elements) {
                        const canvas = document.getElementById('incidentChart');
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            // FCR Chart
            const fcrCtx = document.getElementById('fcrChart').getContext('2d');
            if (fcrChart) fcrChart.destroy();
            fcrChart = new Chart(fcrCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        data: data.fcr_trends.data.map(d => d.value),
                        borderColor: '#4a90e2',  // Supporting blue (20% usage)
                        backgroundColor: 'rgba(74, 144, 226, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#4a90e2',  // Supporting blue
                        pointBorderColor: '#357abd',  // Darker supporting blue
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#357abd',
                        pointHoverBorderColor: '#4a90e2',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'Click for detailed analysis';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            min: 90,
                            max: 100,
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { 
                                color: window.chartTickColor || '#9ca3af',
                                stepSize: 0.1,
                                precision: 1,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: { 
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: window.chartTickColor || '#9ca3af' }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0 && !modalClosing && !fcrModalClosing) {
                            const index = elements[0].index;
                            const monthLabel = months[index];
                            const monthValue = data.fcr_trends.data[index];
                            
                            // Convert month label to date format (e.g., "Feb" -> "2025-02")
                            const monthMap = {
                                'Feb': '2025-02',
                                'Mar': '2025-03',
                                'Apr': '2025-04',
                                'May': '2025-05',
                                'Jun': '2025-06'
                            };
                            
                            const monthDate = monthMap[monthLabel];
                            if (monthDate) {
                                fcrModalClosing = false; // Reset flag before opening
                                openFCRDrillDown(monthDate, monthLabel, monthValue.value);
                            }
                        }
                    },
                    onHover: function(event, elements) {
                        const canvas = document.getElementById('fcrChart');
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            // MTTR Chart with Click Interaction
            const mttrCtx = document.getElementById('mttrChart').getContext('2d');
            if (mttrChart) mttrChart.destroy();
            mttrChart = new Chart(mttrCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        data: data.mttr_trends.data.map(d => d.value),
                        borderColor: '#f5a623',  // Supporting amber (15% usage)
                        backgroundColor: 'rgba(245, 166, 35, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f5a623',  // Supporting amber
                        pointBorderColor: '#e8941a',  // Darker amber
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#e8941a',
                        pointHoverBorderColor: '#f5a623',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                targetLine: {
                                    type: 'line',
                                    yMin: 3.2,  // 3 hours 12 minutes = 3.2 hours
                                    yMax: 3.2,
                                    borderColor: '#06F27B',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'TARGET: 3hrs 12min',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(6, 242, 123, 0.8)',
                                        color: 'white',
                                        font: { size: 10, weight: 'bold' },
                                        padding: 3
                                    }
                                },
                                baselineLine: {
                                    type: 'line',
                                    yMin: 4.0,  // 4 hours baseline
                                    yMax: 4.0,
                                    borderColor: '#EF4444',
                                    borderWidth: 2,
                                    label: {
                                        content: 'BASELINE: 4hrs',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                                        color: 'white',
                                        font: { size: 10, weight: 'bold' },
                                        padding: 3
                                    }
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'Click for detailed analysis';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { 
                                color: window.chartTickColor || '#9ca3af',
                                stepSize: 0.1,
                                precision: 1,
                                callback: function(value) {
                                    return value + 'h';
                                }
                            }
                        },
                        x: { 
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: window.chartTickColor || '#9ca3af' }
                        }
                    },
                    onClick: function(event, elements) {
                        if (elements.length > 0 && !modalClosing && !mttrModalClosing) {
                            const index = elements[0].index;
                            const monthLabel = months[index];
                            const monthValue = data.mttr_trends.data[index];
                            
                            // Convert month label to date format (e.g., "Feb" -> "2025-02")
                            const monthMap = {
                                'Feb': '2025-02',
                                'Mar': '2025-03',
                                'Apr': '2025-04',
                                'May': '2025-05',
                                'Jun': '2025-06'
                            };
                            
                            const monthDate = monthMap[monthLabel];
                            if (monthDate) {
                                mttrModalClosing = false; // Reset flag before opening
                                openMTTRDrillDown(monthDate, monthLabel, monthValue.value);
                            }
                        }
                    },
                    onHover: function(event, elements) {
                        const canvas = document.getElementById('mttrChart');
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });

            // Add custom hover effects for MTTR chart annotation lines
            const mttrCanvas = document.getElementById('mttrChart');
            if (mttrCanvas && mttrChart) {
                // Create custom tooltip div
                let mttrTooltip = document.getElementById('mttr-line-tooltip');
                if (!mttrTooltip) {
                    mttrTooltip = document.createElement('div');
                    mttrTooltip.id = 'mttr-line-tooltip';
                    mttrTooltip.style.cssText = `
                        position: absolute;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: bold;
                        pointer-events: none;
                        z-index: 1000;
                        opacity: 0;
                        transition: opacity 0.2s;
                        white-space: nowrap;
                    `;
                    document.body.appendChild(mttrTooltip);
                }
                
                let mttrHoveredLine = null;
                
                mttrCanvas.addEventListener('mousemove', function(event) {
                    const rect = mttrCanvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    // Get chart area
                    const chartArea = mttrChart.chartArea;
                    if (!chartArea) return;
                    
                    // Calculate y-position for our reference lines (in chart coordinates)
                    const yAxis = mttrChart.scales.y;
                    const targetY = yAxis.getPixelForValue(3.2);  // 3.2 hours
                    const baselineY = yAxis.getPixelForValue(4.0);  // 4 hours
                    
                    // Check if mouse is near any line (within 8 pixels)
                    let newHoveredLine = null;
                    let tooltipText = '';
                    
                    if (Math.abs(y - targetY) <= 8 && x >= chartArea.left && x <= chartArea.right) {
                        newHoveredLine = 'target';
                        tooltipText = 'SLA Target: 3 hours 12 minutes';
                        mttrCanvas.style.cursor = 'pointer';
                    } else if (Math.abs(y - baselineY) <= 8 && x >= chartArea.left && x <= chartArea.right) {
                        newHoveredLine = 'baseline';
                        tooltipText = 'SLA Baseline';
                        mttrCanvas.style.cursor = 'pointer';
                    } else {
                        mttrCanvas.style.cursor = 'default';
                    }
                    
                    // Show/hide tooltip
                    if (newHoveredLine) {
                        mttrTooltip.textContent = tooltipText;
                        mttrTooltip.style.left = (event.pageX + 10) + 'px';
                        mttrTooltip.style.top = (event.pageY - 30) + 'px';
                        mttrTooltip.style.opacity = '1';
                    } else {
                        mttrTooltip.style.opacity = '0';
                    }
                    
                    // Only update if hover state changed
                    if (newHoveredLine !== mttrHoveredLine) {
                        mttrHoveredLine = newHoveredLine;
                        
                        // Update annotation styles
                        const annotations = mttrChart.options.plugins.annotation.annotations;
                        
                        // Target line
                        if (annotations.targetLine) {
                            if (mttrHoveredLine === 'target') {
                                annotations.targetLine.borderWidth = 4;
                                annotations.targetLine.borderColor = 'rgba(6, 242, 123, 1)';
                                annotations.targetLine.label.backgroundColor = 'rgba(6, 242, 123, 1)';
                                annotations.targetLine.label.font.size = 12;
                            } else {
                                annotations.targetLine.borderWidth = 2;
                                annotations.targetLine.borderColor = '#06F27B';
                                annotations.targetLine.label.backgroundColor = 'rgba(6, 242, 123, 0.8)';
                                annotations.targetLine.label.font.size = 10;
                            }
                        }
                        
                        // Baseline line
                        if (annotations.baselineLine) {
                            if (mttrHoveredLine === 'baseline') {
                                annotations.baselineLine.borderWidth = 4;
                                annotations.baselineLine.borderColor = 'rgba(239, 68, 68, 1)';
                                annotations.baselineLine.label.backgroundColor = 'rgba(239, 68, 68, 1)';
                                annotations.baselineLine.label.font.size = 12;
                            } else {
                                annotations.baselineLine.borderWidth = 2;
                                annotations.baselineLine.borderColor = '#EF4444';
                                annotations.baselineLine.label.backgroundColor = 'rgba(239, 68, 68, 0.8)';
                                annotations.baselineLine.label.font.size = 10;
                            }
                        }
                        
                        // Update the chart with animation disabled for smooth hover
                        mttrChart.update('none');
                    }
                });

                // Reset on mouse leave
                mttrCanvas.addEventListener('mouseleave', function() {
                    // Hide tooltip
                    if (mttrTooltip) {
                        mttrTooltip.style.opacity = '0';
                    }
                    
                    if (mttrHoveredLine !== null) {
                        mttrHoveredLine = null;
                        mttrCanvas.style.cursor = 'default';
                        
                        const annotations = mttrChart.options.plugins.annotation.annotations;
                        
                        // Reset target line
                        if (annotations.targetLine) {
                            annotations.targetLine.borderWidth = 2;
                            annotations.targetLine.borderColor = '#06F27B';
                            annotations.targetLine.label.backgroundColor = 'rgba(6, 242, 123, 0.8)';
                            annotations.targetLine.label.font.size = 10;
                        }
                        
                        // Reset baseline line
                        if (annotations.baselineLine) {
                            annotations.baselineLine.borderWidth = 2;
                            annotations.baselineLine.borderColor = '#EF4444';
                            annotations.baselineLine.label.backgroundColor = 'rgba(239, 68, 68, 0.8)';
                            annotations.baselineLine.label.font.size = 10;
                        }
                        
                        mttrChart.update('none');
                    }
                });
            }

            // SLA Compliance Chart has been removed from dashboard

            // SLA Breach Chart
            const breachCtx = document.getElementById('breachChart').getContext('2d');
            if (breachChart) breachChart.destroy();
            // Breach total now updated in updateOverviewMetrics() for consistent animation
            
            breachChart = new Chart(breachCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        data: data.breach_trends.data.map(d => d.value),
                        borderColor: '#605E63',  // Granite Gray (15% - data gridding)
                        backgroundColor: 'rgba(96, 94, 99, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#605E63',  // Granite Gray
                        pointBorderColor: '#4a4850',  // Darker Granite Gray
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { 
                                color: window.chartTickColor || '#9ca3af',
                                precision: 0
                            }
                        },
                        x: { 
                            grid: { color: window.chartGridColor || 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: window.chartTickColor || '#9ca3af' }
                        }
                    }
                }
            });

            // FCR, MTTR, and SLA totals are now updated in updateOverviewMetrics() function
            // They show the overall totals for all regions respecting the quarter filter
        }



        function updateTeamPerformanceTable(data) {
            const tbody = document.getElementById('team-performance-table');
            tbody.innerHTML = '';
            
            // Store team data for potential refresh after modal close
            window.lastTeamPerformanceData = data;
            
            // Update team count dynamically
            document.getElementById('team-count').textContent = data.length;
            
            data.forEach((team, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 hover:bg-gray-700 transition-colors';
                
                row.innerHTML = `
                    <td class="py-2 px-2 text-gray-400">${index + 1}</td>
                    <td class="py-2 px-2 ${(team.critical_breaches || 0) > 0 ? 'text-red-300 font-semibold' : ''} cursor-pointer team-name hover:text-blue-400 transition-colors" 
                        title="Click for detailed drill-down">${team.team || 'Unknown'}</td>
                    <td class="text-right py-2 px-2">${(team.incidents || 0).toLocaleString()}</td>
                    <td class="text-right py-2 px-2">${(team.avg_resolution_time || 0).toFixed(1)}</td>
                    <td class="text-right py-2 px-2">${(team.fcr_rate || 0).toFixed(1)}%</td>
                    <td class="text-right py-2 px-2">${(team.sla_goal_compliance || 0).toFixed(1)}%</td>
                    <td class="text-right py-2 px-2">${(team.sla_compliance_mttr || 0).toFixed(1)}%</td>
                    <td class="text-right py-2 px-2">${(team.sla_breaches || 0).toLocaleString()}</td>
                    <td class="text-right py-2 px-2">${(team.sla_breach_rate || 0).toFixed(1)}%</td>
                    <td class="text-right py-2 px-2 ${(team.critical_breaches || 0) > 0 ? 'text-red-400 font-bold' : ''}">${(team.critical_breaches || 0).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add direct click listeners to team name cells as backup
            console.log('Adding direct click listeners to team cells');
            const teamCells = tbody.querySelectorAll('.team-name');
            console.log(`Found ${teamCells.length} team cells`);
            teamCells.forEach((cell, index) => {
                console.log(`Adding listener to cell ${index}: ${cell.textContent.trim()}`);
                cell.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const teamName = this.textContent.trim();
                    console.log(`Direct click on team: ${teamName}`);

                    animateTeamClick(this);
                    openTeamDrillDown(teamName);
                });
                
                // Add visual indicator that the cell is clickable
                cell.style.border = '1px solid rgba(6, 242, 123, 0.3)';
                cell.style.borderRadius = '4px';
            });
        }

        // Walmart Brand Theme Toggle Functionality
        let currentTheme = 'dark'; // Start with dark mode (Blue Ink)

        function toggleTheme() {
            const root = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            
            if (currentTheme === 'dark') {
                // Switch to light mode
                root.setAttribute('data-theme', 'light');
                themeIcon.textContent = 'â˜€ï¸';
                localStorage.setItem('walmartTheme', 'light');
                currentTheme = 'light';
                
                // Update Chart.js defaults for light mode (Walmart colors)
                Chart.defaults.color = '#041F41';  // Blue Ink
                Chart.defaults.backgroundColor = 'rgba(4, 31, 65, 0.1)';
                Chart.defaults.borderColor = 'rgba(96, 94, 99, 0.2)';  // Granite Gray
                
                // Update chart grid colors for light theme
                window.chartGridColor = 'rgba(96, 94, 99, 0.1)';      // Granite Gray
                window.chartTickColor = '#605E63';                    // Granite Gray
                
            } else {
                // Switch to dark mode (Blue Ink canvas)
                root.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'ðŸŒ™';
                localStorage.setItem('walmartTheme', 'dark');
                currentTheme = 'dark';
                
                // Update Chart.js defaults for dark mode (Blue Ink background)
                Chart.defaults.color = '#FFFFFF';  // White text on Blue Ink
                Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                Chart.defaults.borderColor = 'rgba(185, 187, 197, 0.2)';  // Gray
                
                // Update chart grid colors for dark theme
                window.chartGridColor = 'rgba(185, 187, 197, 0.1)';   // Gray
                window.chartTickColor = '#B9BBC5';                    // Gray
            }
            
            // Update chart colors without refreshing data to prevent number flashing
            if (incidentChart || fcrChart || mttrChart || slaChart || breachChart) {
                updateChartsForTheme();
            }
            
            // Update modal theme if open
            updateModalTheme();
        }

        function initializeWalmartTheme() {
            const savedTheme = localStorage.getItem('walmartTheme') || 'dark';
            const root = document.documentElement;
            
            if (savedTheme === 'light') {
                root.setAttribute('data-theme', 'light');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
                currentTheme = 'light';
                
                // Set light mode chart colors
                Chart.defaults.color = '#041F41';
                window.chartGridColor = 'rgba(96, 94, 99, 0.1)';
                window.chartTickColor = '#605E63';
            } else {
                root.setAttribute('data-theme', 'dark');
                document.getElementById('theme-icon').textContent = 'ðŸŒ™';
                currentTheme = 'dark';
                
                // Set dark mode chart colors
                Chart.defaults.color = '#FFFFFF';
                window.chartGridColor = 'rgba(185, 187, 197, 0.1)';
                window.chartTickColor = '#B9BBC5';
            }
        }

        // Team drill-down modal functions
        let teamIncidentChart = null;
        let teamMetricsChart = null;
        window.currentDrillDownTeam = null; // Initialize global variable
        
        // Simple function to check if team modal can be opened
        function canOpenTeamModal() {
            const modal = document.getElementById('team-modal');
            return modal.classList.contains('hidden');
        }

        function animateTeamClick(element) {
            // Create a ripple effect on team click
            element.style.transform = 'scale(0.95)';
            element.style.boxShadow = '0 0 20px rgba(6, 242, 123, 0.4)';
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                element.style.boxShadow = 'none';
            }, 150);
            
            // Add a brief glow effect
            element.style.backgroundColor = 'rgba(6, 242, 123, 0.1)';
            setTimeout(() => {
                element.style.backgroundColor = 'transparent';
            }, 300);
        }

        function openTeamDrillDown(teamName) {
            console.log(`Opening team drill-down for: ${teamName}`);
            
            // Simple check - can we open the modal?
            if (!canOpenTeamModal()) {
                console.log('Team modal is already open');
                return;
            }
            const modal = document.getElementById('team-modal');
            console.log('Modal element found:', modal);
            
            if (!modal) {
                console.error('Team modal not found!');
                alert('ERROR: Team modal element not found!');
                return;
            }
            
            const modalContent = modal.querySelector('.modal-content');
            const modalTeamName = document.getElementById('modal-team-name');
            const modalQuarterInfo = document.getElementById('modal-quarter-info');
            const modalLoading = document.getElementById('modal-loading');
            const modalData = document.getElementById('modal-data');
            const modalTimePeriodFilter = document.getElementById('modal-time-period-filter');
            
            console.log('Modal elements debug:', {
                modalContent: !!modalContent,
                modalTeamName: !!modalTeamName,
                modalQuarterInfo: !!modalQuarterInfo,
                modalLoading: !!modalLoading,
                modalData: !!modalData,
                modalTimePeriodFilter: !!modalTimePeriodFilter,
                teamName: teamName,
                timestamp: new Date().toISOString()
            });
            
            // Additional debugging for null elements
            if (!modalTeamName) {
                console.error('modalTeamName is null! Element with id "modal-team-name" not found.');
            }
            if (!modalQuarterInfo) {
                console.error('modalQuarterInfo is null! Element with id "modal-quarter-info" not found.');
            }
            
            // Set team name and quarter info (handle edge cases)
            if (modalTeamName) {
                modalTeamName.textContent = `${teamName.trim()} - Performance Drill-Down`;
            }
            updateModalQuarterInfo();
            
            // Set initial time period filter to match current dashboard filter
            if (modalTimePeriodFilter) {
                const currentTimePeriod = document.getElementById("time-period-filter")?.value || "all";
                modalTimePeriodFilter.value = currentTimePeriod;
            }
            
            // Reset animation classes
            modal.classList.remove('closing');
            modalContent.classList.remove('closing');
            
            // Show modal with animation
            console.log('About to show modal...');
            modal.classList.remove('hidden');
            console.log('Modal hidden class removed');
            
            if (modalLoading) {
            modalLoading.classList.remove('hidden');
                console.log('Modal loading shown');
            }
            if (modalData) {
            modalData.classList.add('hidden');
                console.log('Modal data hidden');
            }
            
            // Add entrance animation with slight delay for smoother effect
            requestAnimationFrame(() => {
                modal.classList.add('modal-backdrop');
                modalContent.classList.add('modal-content');
                console.log('Modal animation classes added');
            });
            
            // Store current team for filter updates
            window.currentDrillDownTeam = teamName;
            
            // Add staggered animation for loading elements
            setTimeout(() => {
                const loadingSpinner = modalLoading.querySelector('.animate-spin');
                if (loadingSpinner) {
                    loadingSpinner.style.animation = 'walmartSpin 1s linear infinite, walmartFadeInUp 0.3s ease-out';
                }
            }, 200);
            
            // Fetch team drill-down data with slight delay for animation
            setTimeout(() => {
                fetchTeamDrillDownData(teamName);
            }, 800);
        }

        function closeTeamDrillDown() {
            console.log('Closing team drill-down modal');
            const modal = document.getElementById('team-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Add closing animation classes
            modal.classList.add('closing');
            modalContent.classList.add('closing');
            
            // Immediately hide modal and cleanup
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('closing');
                modalContent.classList.remove('closing');
                
                // Clear current drill-down team
                window.currentDrillDownTeam = null;
                
                // Destroy existing charts
                if (teamIncidentChart) {
                    teamIncidentChart.destroy();
                    teamIncidentChart = null;
                }
                if (teamMetricsChart) {
                    teamMetricsChart.destroy();
                    teamMetricsChart = null;
                }
                
                console.log('Team modal closed and cleaned up');
            }, 300); // Match the animation duration
        }

        // MTTR Drill-Down Functions
        function openMTTRCompareMode() {
            console.log('Opening MTTR Compare Mode');
            
            // Force reset flags if they've been stuck for too long
            const now = Date.now();
            if (!window.lastMTTRCloseTime) window.lastMTTRCloseTime = 0;
            if (now - window.lastMTTRCloseTime > 3000) { // If more than 3 seconds since last close
                mttrModalClosing = false;
                modalClosing = false;
                console.log('Force reset modal flags due to timeout');
            }
            
            // Prevent opening if modal is in closing state
            if (mttrModalClosing || modalClosing) {
                console.log('Modal opening prevented - in closing state');
                return;
            }
            
            const modal = document.getElementById('mttr-modal');
            const modalContent = modal.querySelector('.modal-content');
            const modalLoading = document.getElementById('mttr-modal-loading');
            const modalData = document.getElementById('mttr-modal-data');
            const monthNameSpan = document.getElementById('mttr-month-name');
            
            // Set title for comparison mode
            if (monthNameSpan) monthNameSpan.textContent = 'Comparison Mode';
            
            // Update modal title and description for comparison mode
            document.getElementById('mttr-modal-title').textContent = 'MTTR Month-to-Month Comparison';
            document.getElementById('mttr-modal-description').innerHTML = 'Select and compare any two months to analyze performance trends';
            
            // Reset animation classes and modal state
            modal.classList.remove('closing', 'hidden');
            modalContent.classList.remove('closing');
            modal.style.display = 'flex';
            
            // Reset content visibility
            if (modalLoading) modalLoading.classList.remove('hidden');
            if (modalData) modalData.classList.add('hidden');
            
            // Add entrance animation
            requestAnimationFrame(() => {
                modal.classList.add('modal-backdrop');
                modalContent.classList.add('modal-content');
            });
            
            console.log('MTTR comparison modal opened successfully');
            
            // Load comparison mode interface with blank state
            setTimeout(() => {
                loadBlankComparisonInterface();
            }, 800);
        }

        function loadBlankComparisonInterface() {
            // Hide loading and show the comparison interface
            document.getElementById('mttr-modal-loading').classList.add('hidden');
            const modalData = document.getElementById('mttr-modal-data');
            modalData.classList.remove('hidden');
            
            // Reset both month titles to blank state
            document.getElementById('current-month-title').textContent = 'Select First Month';
            document.getElementById('comparison-month-title').textContent = 'Select Second Month';
            
            // Set up blank content for both month cards
            const blankContent = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">ðŸ“Š</div>
                    <p class="text-lg font-medium mb-2" style="color: var(--modal-text);">Choose a month to analyze</p>
                    <p class="text-sm" style="color: var(--modal-text-secondary);">Select from the dropdown above to view detailed MTTR data</p>
                </div>
            `;
            
            document.getElementById('current-month-complete-content').innerHTML = blankContent;
            document.getElementById('comparison-month-complete-content').innerHTML = blankContent;
            
            // Reset month selector to show all options as available
            setupBlankMonthSelectors();
            
            // Clear insights section
            document.getElementById('month-comparison-insights').innerHTML = `
                <div class="text-center py-8">
                    <div class="text-4xl mb-4">ðŸ”</div>
                    <p class="text-lg font-medium mb-2" style="color: var(--modal-text);">Ready for Comparison</p>
                    <p class="text-sm" style="color: var(--modal-text-secondary);">Select two months above to view detailed insights and recommendations</p>
                </div>
            `;
            
            // Clear global data
            window.currentMTTRData = null;
            window.currentMTTRMonth = null;
            window.currentMTTRLabel = null;
            
            // Add entrance animations
            const animationSections = modalData.querySelectorAll('.rounded-lg');
            animationSections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                section.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, 100 + (index * 100));
            });
        }

        function openMTTRDrillDown(monthDate, monthLabel, avgMTTR) {
            console.log(`Opening MTTR drill-down for ${monthLabel} (${monthDate})`);
            console.log(`Modal flags - mttrModalClosing: ${mttrModalClosing}, modalClosing: ${modalClosing}`);
            
            // Force reset flags if they've been stuck for too long
            const now = Date.now();
            if (!window.lastMTTRCloseTime) window.lastMTTRCloseTime = 0;
            if (now - window.lastMTTRCloseTime > 3000) { // If more than 3 seconds since last close
                mttrModalClosing = false;
                modalClosing = false;
                console.log('Force reset modal flags due to timeout');
            }
            
            // Prevent opening if modal is in closing state
            if (mttrModalClosing || modalClosing) {
                console.log('Modal opening prevented - in closing state');
                return;
            }
            
            const modal = document.getElementById('mttr-modal');
            const modalContent = modal.querySelector('.modal-content');
            const modalLoading = document.getElementById('mttr-modal-loading');
            const modalData = document.getElementById('mttr-modal-data');
            const monthNameSpan = document.getElementById('mttr-month-name');
            
            // Set month name
            if (monthNameSpan) monthNameSpan.textContent = monthLabel + ' 2025';
            
            // Reset animation classes and modal state
            modal.classList.remove('closing', 'hidden');
            modalContent.classList.remove('closing');
            modal.style.display = 'flex';
            
            // Reset content visibility
            if (modalLoading) modalLoading.classList.remove('hidden');
            if (modalData) modalData.classList.add('hidden');
            
            // Add entrance animation
            requestAnimationFrame(() => {
                modal.classList.add('modal-backdrop');
                modalContent.classList.add('modal-content');
            });
            
            console.log('MTTR modal opened successfully');
            
            // Fetch MTTR drill-down data
            setTimeout(() => {
                fetchMTTRDrillDownData(monthDate, monthLabel);
            }, 800);
        }

        function closeMTTRDrillDown() {
            console.log('Closing MTTR drill-down modal');
            const modal = document.getElementById('mttr-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Set specific MTTR modal flag to prevent immediate reopening
            mttrModalClosing = true;
            modalClosing = true;
            
            // Track close time for timeout reset logic
            window.lastMTTRCloseTime = Date.now();
            
            // Add closing animation classes
            modal.classList.add('closing');
            modalContent.classList.add('closing');
            
            // Wait for animation to complete before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('closing');
                modalContent.classList.remove('closing');
                modal.style.display = 'none'; // Ensure it's fully hidden
                
                // Reset modal content to loading state for next time
                const modalLoading = document.getElementById('mttr-modal-loading');
                const modalData = document.getElementById('mttr-modal-data');
                if (modalLoading) modalLoading.classList.remove('hidden');
                if (modalData) modalData.classList.add('hidden');
                
                // Clear any existing content
                const monthNameSpan = document.getElementById('mttr-month-name');
                if (monthNameSpan) monthNameSpan.textContent = 'Month';
                
                // Reset flags after a shorter delay
                setTimeout(() => {
                    modalClosing = false;
                    mttrModalClosing = false;
                    console.log('MTTR modal flags reset - ready for next click');
                }, 500); // Reduced to 500ms
            }, 300);
        }

        function setupBlankMonthSelectors() {
            // Reset the current month selector (we'll add this)
            const currentMonthSelector = document.getElementById('current-month-selector');
            const comparisonMonthSelector = document.getElementById('comparison-month-selector');
            
            if (currentMonthSelector) {
                currentMonthSelector.value = '';
                // Enable all options
                const options = currentMonthSelector.querySelectorAll('option');
                options.forEach(option => {
                    option.disabled = false;
                    option.textContent = option.textContent.replace(' (Current)', '').replace(' (Selected)', '');
                });
            }
            
            if (comparisonMonthSelector) {
                comparisonMonthSelector.value = '';
                // Enable all options
                const options = comparisonMonthSelector.querySelectorAll('option');
                options.forEach(option => {
                    option.disabled = false;
                    option.textContent = option.textContent.replace(' (Current)', '').replace(' (Selected)', '');
                });
            }
        }

        async function fetchMTTRDrillDownData(monthDate, monthLabel) {
            try {
                // For drill-down, we want complete month data without dashboard filters
                // This allows meaningful month-to-month comparisons across all data
                const response = await fetch(`/api/mttr_drilldown?month=${monthDate}`);
                
                // Show notification about data scope
                showDrillDownNotification('month', monthLabel);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Store current month data globally for comparison
                window.currentMTTRData = data;
                window.currentMTTRMonth = monthDate;
                window.currentMTTRLabel = monthLabel;
                
                populateMTTRDrillDown(data);
                
                // Auto-populate the first month selector with the clicked month
                const currentMonthSelector = document.getElementById('current-month-selector');
                if (currentMonthSelector) {
                    currentMonthSelector.value = monthDate;
                    // Trigger the change event to load the month data
                    updateCurrentMonth();
                }
                
                // Set up comparison month selector (exclude current month)
                setupMonthSelector(monthDate);
                
            } catch (error) {
                console.error('Error fetching MTTR drill-down data:', error);
                document.getElementById('mttr-modal-loading').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load MTTR analysis</p>
                        <p class="text-sm mt-2" style="color: var(--modal-text-secondary);">${error.message}</p>
                        <button onclick="fetchMTTRDrillDownData('${monthDate}', '${monthLabel}')" class="mt-4 px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function setupMonthSelector(currentMonth) {
            const selector = document.getElementById('comparison-month-selector');
            const options = selector.querySelectorAll('option');
            
            // Update month labels
            const currentMonthLabel = document.getElementById('current-month-label');
            if (currentMonthLabel && window.currentMTTRLabel) {
                currentMonthLabel.textContent = window.currentMTTRLabel;
            }
            
            // Enable/disable options based on current month
            options.forEach(option => {
                if (option.value === currentMonth) {
                    option.disabled = true;
                    option.textContent += ' (Current)';
                } else {
                    option.disabled = false;
                    option.textContent = option.textContent.replace(' (Current)', '');
                }
            });
            
            // Reset selector
            selector.value = '';
            
            // Clear previous comparison data
            clearComparisonData();
        }

        async function updateCurrentMonth() {
            const selector = document.getElementById('current-month-selector');
            const selectedMonth = selector.value;
            
            if (!selectedMonth) {
                // Reset to blank state
                document.getElementById('current-month-title').textContent = 'Select First Month';
                document.getElementById('current-month-complete-content').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ðŸ“Š</div>
                        <p class="text-lg font-medium mb-2" style="color: var(--modal-text);">Choose a month to analyze</p>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Select from the dropdown above to view detailed MTTR data</p>
                    </div>
                `;
                window.currentMTTRData = null;
                updateComparisonInsights();
                return;
            }
            
            try {
                // Show loading state for current month
                document.getElementById('current-month-title').textContent = 'Loading...';
                document.getElementById('current-month-complete-content').innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-400 mx-auto mb-3"></div>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Loading month data...</p>
                    </div>
                `;
                
                const response = await fetch(`/api/mttr_drilldown?month=${selectedMonth}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const currentData = await response.json();
                
                // Store current month data
                window.currentMTTRData = currentData;
                window.currentMTTRMonth = selectedMonth;
                window.currentMTTRLabel = currentData.month_name;
                
                // Update current month display
                document.getElementById('current-month-title').textContent = currentData.month_name;
                const currentContent = generateCompleteMonthContent(currentData);
                document.getElementById('current-month-complete-content').innerHTML = currentContent;
                
                // Update insights if comparison month is also selected
                updateComparisonInsights();
                
            } catch (error) {
                console.error('Error fetching current month data:', error);
                document.getElementById('current-month-title').textContent = 'Error Loading';
                document.getElementById('current-month-complete-content').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load month data</p>
                    </div>
                `;
            }
        }

        async function updateComparison() {
            const selector = document.getElementById('comparison-month-selector');
            const selectedMonth = selector.value;
            
            if (!selectedMonth) {
                // Reset to blank state
                document.getElementById('comparison-month-title').textContent = 'Select Second Month';
                document.getElementById('comparison-month-complete-content').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">ðŸ“Š</div>
                        <p class="text-lg font-medium mb-2" style="color: var(--modal-text);">Choose a month to analyze</p>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Select from the dropdown above to view detailed MTTR data</p>
                    </div>
                `;
                updateComparisonInsights();
                return;
            }
            
            try {
                // Show loading state for comparison
                document.getElementById('comparison-month-title').textContent = 'Loading...';
                document.getElementById('comparison-month-complete-content').innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto mb-3"></div>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Loading month data...</p>
                    </div>
                `;
                
                const response = await fetch(`/api/mttr_drilldown?month=${selectedMonth}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const comparisonData = await response.json();
                
                // Update comparison month display
                document.getElementById('comparison-month-title').textContent = comparisonData.month_name;
                const comparisonContent = generateCompleteMonthContent(comparisonData);
                document.getElementById('comparison-month-complete-content').innerHTML = comparisonContent;
                
                // Update insights if both months are selected
                if (window.currentMTTRData) {
                    const insights = generateComparisonInsights(window.currentMTTRData, comparisonData);
                    document.getElementById('month-comparison-insights').innerHTML = insights;
                } else {
                    updateComparisonInsights();
                }
                
            } catch (error) {
                console.error('Error fetching comparison data:', error);
                document.getElementById('comparison-month-title').textContent = 'Error Loading';
                document.getElementById('comparison-month-complete-content').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load month data</p>
                    </div>
                `;
            }
        }

        function refreshComparison() {
            const selector = document.getElementById('comparison-month-selector');
            if (selector.value) {
                updateComparison();
            }
        }

        function clearComparisonData() {
            const comparisonContent = document.getElementById('comparison-month-complete-content');
            const insightsContent = document.getElementById('month-comparison-insights');
            
            document.getElementById('comparison-month-title').textContent = 'Select Month to Compare';
            
            // Set default content
            comparisonContent.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-sm" style="color: var(--modal-text-secondary);">Select a month from the dropdown above to view comparison</p>
                </div>
            `;
            
            insightsContent.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-sm" style="color: var(--modal-text-secondary);">Select a comparison month to view detailed insights and recommendations</p>
                </div>
            `;
            
            // Ensure content is visible
            comparisonContent.style.opacity = '1';
            insightsContent.style.opacity = '1';
            comparisonContent.style.transform = 'translateY(0)';
            insightsContent.style.transform = 'translateY(0)';
        }

        function setComparisonLoading(loading) {
            const comparisonContent = document.getElementById('comparison-month-complete-content');
            const insightsContent = document.getElementById('month-comparison-insights');
            
            if (loading) {
                document.getElementById('comparison-month-title').textContent = 'Loading...';
                
                // Set loading content with initial opacity
                comparisonContent.style.opacity = '0';
                insightsContent.style.opacity = '0';
                comparisonContent.style.transform = 'translateY(-10px)';
                insightsContent.style.transform = 'translateY(-10px)';
                
                comparisonContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-amber-400 mx-auto mb-3"></div>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Loading comparison data...</p>
                    </div>
                `;
                insightsContent.innerHTML = `
                    <div class="text-center py-8">
                        <div class="animate-pulse text-sm" style="color: var(--modal-text-secondary);">
                            <div class="inline-flex items-center">
                                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-amber-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Analyzing changes...
                            </div>
                        </div>
                    </div>
                `;
                
                // Fade in loading content
                setTimeout(() => {
                    comparisonContent.style.transition = 'opacity 0.3s ease-out';
                    insightsContent.style.transition = 'opacity 0.3s ease-out';
                    comparisonContent.style.opacity = '0.8';
                    insightsContent.style.opacity = '0.8';
                    comparisonContent.style.transform = 'translateY(0)';
                    insightsContent.style.transform = 'translateY(0)';
                }, 50);
            }
        }

        function populateComparisonCompleteContent(comparisonData) {
            const comparisonContent = document.getElementById('comparison-month-complete-content');
            const insightsContent = document.getElementById('month-comparison-insights');
            
            // Update comparison month title
            document.getElementById('comparison-month-title').textContent = comparisonData.month_name;
            
            // Generate complete content for comparison month
            const completeContent = generateCompleteMonthContent(comparisonData);
            
            // Update comparison insights
            const insights = generateComparisonInsights(window.currentMTTRData, comparisonData);
            
            // Update the content directly (the loading state was already showing)
            comparisonContent.innerHTML = completeContent;
            insightsContent.innerHTML = insights;
            
            // Now fade in the new content
            comparisonContent.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            insightsContent.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            comparisonContent.style.opacity = '1';
            insightsContent.style.opacity = '1';
            comparisonContent.style.transform = 'translateY(0)';
        }

        function updateComparisonInsights(comparisonData = null) {
            const insightsContainer = document.getElementById('month-comparison-insights');
            
            // Check if we have both months selected
            const currentMonthSelector = document.getElementById('current-month-selector');
            const comparisonMonthSelector = document.getElementById('comparison-month-selector');
            
            const hasCurrentMonth = currentMonthSelector && currentMonthSelector.value && window.currentMTTRData;
            const hasComparisonMonth = comparisonMonthSelector && comparisonMonthSelector.value;
            
            if (!hasCurrentMonth && !hasComparisonMonth) {
                insightsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">ðŸ”</div>
                        <p class="text-lg font-medium mb-2" style="color: var(--modal-text);">Ready for Comparison</p>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Select two months above to view detailed insights and recommendations</p>
                    </div>
                `;
            } else if (!hasCurrentMonth || !hasComparisonMonth) {
                const selectedCount = (hasCurrentMonth ? 1 : 0) + (hasComparisonMonth ? 1 : 0);
                insightsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">ðŸ“Š</div>
                        <p class="text-lg font-medium mb-2" style="color: var(--modal-text);">${selectedCount}/2 Months Selected</p>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">Select ${selectedCount === 0 ? 'two months' : 'one more month'} to generate comparison insights</p>
                    </div>
                `;
            } else if (comparisonData && window.currentMTTRData) {
                // Both months selected, generate insights
                const insights = generateComparisonInsights(window.currentMTTRData, comparisonData);
                insightsContainer.innerHTML = insights;
            }
        }

        function generateComparisonInsights(currentData, comparisonData) {
            const current = currentData.summary;
            const comparison = comparisonData.summary;
            const currentGoals = currentData.goal_analysis || {};
            const comparisonGoals = comparisonData.goal_analysis || {};
            
            // Calculate changes
            const incidentChange = current.total_incidents - comparison.total_incidents;
            const mttrChange = current.avg_mttr_hours - comparison.avg_mttr_hours;
            const slaGoalChange = (currentGoals.sla_goal_rate || 0) - (comparisonGoals.sla_goal_rate || 0);
            const exceedingChange = (currentGoals.exceeding_goals?.count || 0) - (comparisonGoals.exceeding_goals?.count || 0);
            const missingChange = (currentGoals.missing_goals?.count || 0) - (comparisonGoals.missing_goals?.count || 0);
            
            // Generate insights and recommendations
            let keyChanges = [];
            let whyItHappened = [];
            let nextSteps = [];
            
            // Incident Volume Analysis
            if (Math.abs(incidentChange) > 50) {
                const direction = incidentChange > 0 ? 'increased' : 'decreased';
                const percent = Math.abs((incidentChange / comparison.total_incidents) * 100).toFixed(1);
                keyChanges.push(`ðŸ“Š Incident volume ${direction} by ${Math.abs(incidentChange)} incidents (${percent}%)`);
                
                if (incidentChange > 0) {
                    whyItHappened.push('Higher incident volume may indicate system instability, new deployments, or increased user activity');
                    nextSteps.push('ðŸ” Investigate root causes of increased incidents and implement preventive measures');
                } else {
                    whyItHappened.push('Lower incident volume suggests improved system stability or effective preventive measures');
                    nextSteps.push('âœ… Document and replicate successful practices that led to incident reduction');
                }
            }
            
            // MTTR Analysis
            if (Math.abs(mttrChange) > 0.2) {
                const direction = mttrChange > 0 ? 'increased' : 'improved';
                const percent = Math.abs((mttrChange / comparison.avg_mttr_hours) * 100).toFixed(1);
                keyChanges.push(`â±ï¸ Average MTTR ${direction} by ${Math.abs(mttrChange).toFixed(1)} hours (${percent}%)`);
                
                if (mttrChange > 0) {
                    whyItHappened.push('Longer resolution times may be due to complex incidents, knowledge gaps, or resource constraints');
                    nextSteps.push('ðŸŽ¯ Focus on knowledge sharing, automation, and team training to reduce resolution times');
                } else {
                    whyItHappened.push('Faster resolution times indicate improved processes, better knowledge base usage, or team efficiency');
                    nextSteps.push('ðŸš€ Scale successful resolution practices across all teams');
                }
            }
            
            // SLA Goal Performance
            if (Math.abs(slaGoalChange) > 2) {
                const direction = slaGoalChange > 0 ? 'improved' : 'declined';
                keyChanges.push(`ðŸŽ¯ SLA goal achievement ${direction} by ${Math.abs(slaGoalChange).toFixed(1)} percentage points`);
                
                if (slaGoalChange < 0) {
                    whyItHappened.push('SLA performance decline may be linked to increased complexity or insufficient resources');
                    nextSteps.push('âš¡ Implement SLA recovery plan and prioritize critical incident resolution');
                } else {
                    whyItHappened.push('SLA improvement reflects better incident management and team performance');
                    nextSteps.push('ðŸ“ˆ Maintain current practices and set more ambitious targets');
                }
            }
            
            // Performance Categories Analysis
            if (Math.abs(exceedingChange) > 10 || Math.abs(missingChange) > 10) {
                if (exceedingChange > 0) {
                    keyChanges.push(`ðŸŒŸ ${exceedingChange} more incidents resolved exceptionally fast (â‰¤2h)`);
                    whyItHappened.push('Increased fast resolutions suggest improved first-line support and knowledge base effectiveness');
                    nextSteps.push('ðŸ† Recognize high-performing teams and share their best practices');
                }
                
                if (missingChange > 0) {
                    keyChanges.push(`âš ï¸ ${missingChange} more incidents missed SLA goals (>3.2h)`);
                    whyItHappened.push('More SLA misses may indicate resource constraints or complex incident patterns');
                    nextSteps.push('ðŸ”§ Review escalation procedures and consider additional training or resources');
                }
            }
            
            // Team Performance Analysis
            const currentTopTeam = currentData.best_performing_teams[0];
            const comparisonTopTeam = comparisonData.best_performing_teams[0];
            
            if (currentTopTeam && comparisonTopTeam) {
                if (currentTopTeam.team !== comparisonTopTeam.team) {
                    keyChanges.push(`ðŸ‘‘ Leadership changed: ${currentTopTeam.team.replace('AEDT - Enterprise Tech Spot - ', '')} is now top performer`);
                    whyItHappened.push('Team performance shifts may reflect changes in workload distribution or process improvements');
                    nextSteps.push('ðŸ¤ Facilitate knowledge transfer between high and low performing teams');
                }
            }
            
            // Default insights if no significant changes
            if (keyChanges.length === 0) {
                keyChanges.push('ðŸ“Š Performance remains relatively stable between these months');
                whyItHappened.push('Consistent performance indicates mature processes and stable operations');
                nextSteps.push('ðŸ”„ Continue monitoring trends and look for incremental improvement opportunities');
            }
            
            return `
                <div class="space-y-6">
                    <!-- Key Changes -->
                    <div>
                        <h6 class="text-sm font-semibold mb-3 flex items-center" style="color: var(--modal-text);">
                            <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                            What Changed
                        </h6>
                        <div class="space-y-2">
                            ${keyChanges.map(change => `
                                <div class="p-3 rounded text-sm" style="background-color: var(--modal-bg); color: var(--modal-text);">
                                    ${change}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Why It Happened -->
                    <div>
                        <h6 class="text-sm font-semibold mb-3 flex items-center" style="color: var(--modal-text);">
                            <span class="w-2 h-2 bg-amber-500 rounded-full mr-2"></span>
                            Why It Happened
                        </h6>
                        <div class="space-y-2">
                            ${whyItHappened.map(reason => `
                                <div class="p-3 rounded text-sm" style="background-color: var(--modal-bg); color: var(--modal-text-secondary);">
                                    ${reason}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Next Steps -->
                    <div>
                        <h6 class="text-sm font-semibold mb-3 flex items-center" style="color: var(--modal-text);">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                            Recommended Next Steps
                        </h6>
                        <div class="space-y-2">
                            ${nextSteps.map(step => `
                                <div class="p-3 rounded text-sm" style="background-color: var(--modal-bg); color: var(--modal-text);">
                                    ${step}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Summary Score -->
                    <div class="p-4 rounded-lg border-l-4" style="background-color: var(--modal-bg); border-color: ${slaGoalChange >= 0 ? '#10b981' : '#ef4444'};">
                        <h6 class="text-sm font-semibold mb-2" style="color: var(--modal-text);">Performance Trend</h6>
                        <div class="flex items-center justify-between">
                            <span class="text-sm" style="color: var(--modal-text-secondary);">
                                ${currentData.month_name} vs ${comparisonData.month_name}
                            </span>
                            <span class="text-lg font-bold" style="color: ${slaGoalChange >= 0 ? '#10b981' : '#ef4444'};">
                                ${slaGoalChange >= 0 ? 'ðŸ“ˆ Improving' : 'ðŸ“‰ Needs Attention'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateCompleteMonthContent(data) {
            const goalAnalysis = data.goal_analysis || {};
            const slaGoalRate = goalAnalysis.sla_goal_rate || 0;
            const slaBaselineRate = goalAnalysis.sla_baseline_rate || 0;
            const exceedingGoals = goalAnalysis.exceeding_goals || {};
            const meetingGoals = goalAnalysis.meeting_goals || {};
            const missingGoals = goalAnalysis.missing_goals || {};
            
            return `
                <!-- Summary Stats -->
                <div class="grid grid-cols-2 gap-4 text-center mb-6">
                    <div>
                        <div class="text-2xl font-bold" style="color: var(--modal-text);">${(data.summary.total_incidents || 0).toLocaleString()}</div>
                        <div class="text-xs" style="color: var(--modal-text-secondary);">Total Incidents</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-amber-400">${data.summary.avg_mttr_hours}h</div>
                        <div class="text-xs" style="color: var(--modal-text-secondary);">Average MTTR</div>
                    </div>
                </div>

                <!-- Goal Achievement -->
                <div class="mb-6">
                    <h6 class="text-sm font-medium mb-3" style="color: var(--modal-text);">Goal Achievement</h6>
                    
                    <!-- SLA Goal -->
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1" style="color: var(--modal-text-secondary);">
                            <span>SLA Goal (â‰¤ 3.2h)</span>
                            <span>${slaGoalRate}%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: ${slaGoalRate}%"></div>
                        </div>
                    </div>
                    

                </div>

                <!-- Performance Categories -->
                <div class="mb-6">
                    <h6 class="text-sm font-medium mb-3" style="color: var(--modal-text);">Performance Categories</h6>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="p-2 rounded" style="background-color: var(--modal-bg);">
                            <div class="text-lg font-bold text-green-400">${(exceedingGoals.count || 0).toLocaleString()}</div>
                            <div class="text-xs text-green-300">Exceeding</div>
                            <div class="text-xs" style="color: var(--modal-text-secondary);">â‰¤ 2.0h</div>
                        </div>
                        <div class="p-2 rounded" style="background-color: var(--modal-bg);">
                            <div class="text-lg font-bold text-amber-400">${(meetingGoals.count || 0).toLocaleString()}</div>
                            <div class="text-xs text-amber-300">Meeting</div>
                            <div class="text-xs" style="color: var(--modal-text-secondary);">2.0-3.2h</div>
                        </div>
                        <div class="p-2 rounded" style="background-color: var(--modal-bg);">
                            <div class="text-lg font-bold text-red-400">${(missingGoals.count || 0).toLocaleString()}</div>
                            <div class="text-xs text-red-300">Missing</div>
                            <div class="text-xs" style="color: var(--modal-text-secondary);">> 3.2h</div>
                        </div>
                    </div>
                </div>

                <!-- Top and Low Performing Teams -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- Top Performing Teams -->
                    <div class="p-3 rounded" style="background-color: var(--modal-bg);">
                        <h6 class="text-sm font-medium mb-3" style="color: var(--modal-text);">ðŸ† Top 5 Performing Teams</h6>
                        <div class="space-y-2">
                            ${data.best_performing_teams.slice(0, 5).map((team, index) => `
                                <div class="flex justify-between items-center p-2 rounded" style="background-color: var(--modal-card-bg);">
                                    <div class="flex items-center">
                                        <span class="text-xs font-bold text-green-400 mr-2">#${index + 1}</span>
                                        <span class="text-xs" style="color: var(--modal-text);">${team.team.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '')}</span>
                                    </div>
                                    <div class="text-xs text-green-400">${team.avg_mttr}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Low Performing Teams -->
                    <div class="p-3 rounded" style="background-color: var(--modal-bg);">
                        <h6 class="text-sm font-medium mb-3" style="color: var(--modal-text);">ðŸ“ˆ Top 5 Improvement Opportunities</h6>
                        <div class="space-y-2">
                            ${data.worst_performing_teams.slice(0, 5).map((team, index) => `
                                <div class="flex justify-between items-center p-2 rounded" style="background-color: var(--modal-card-bg);">
                                    <div class="flex items-center">
                                        <span class="text-xs font-bold text-red-400 mr-2">#${index + 1}</span>
                                        <span class="text-xs" style="color: var(--modal-text);">${team.team.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '')}</span>
                                    </div>
                                    <div class="text-xs text-red-400">${team.avg_mttr}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }



        function populateMTTRDrillDown(data) {
            // Store current data for comparison
            window.currentMTTRData = data;
            
            // Update current month title
            document.getElementById('current-month-title').textContent = data.month_name;
            
            // Generate complete content for current month
            const currentCompleteContent = generateCompleteMonthContent(data);
            document.getElementById('current-month-complete-content').innerHTML = currentCompleteContent;
            

            

            
            // Update insights section with initial state
            updateComparisonInsights();
            
            // Show data and hide loading
            document.getElementById('mttr-modal-loading').classList.add('hidden');
            const modalData = document.getElementById('mttr-modal-data');
            modalData.classList.remove('hidden');
            
            // Add staggered entrance animations
            const animationSections = modalData.querySelectorAll('.rounded-lg');
            animationSections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                section.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, 100 + (index * 100));
            });
        }



        // Incident Drill-Down Functions
        function openIncidentDrillDown(monthDate, monthLabel, incidentCount) {
            console.log(`Opening Incident drill-down for ${monthLabel} (${monthDate})`);
            console.log(`Modal flags - incidentDrilldownModalClosing: ${incidentDrilldownModalClosing}, modalClosing: ${modalClosing}`);
            
            // Force reset flags if they've been stuck for too long
            const now = Date.now();
            if (!window.lastIncidentCloseTime) window.lastIncidentCloseTime = 0;
            if (now - window.lastIncidentCloseTime > 3000) { // If more than 3 seconds since last close
                incidentDrilldownModalClosing = false;
                modalClosing = false;
                console.log('Force reset Incident modal flags due to timeout');
            }
            
            // Prevent opening if modal is in closing state
            if (incidentDrilldownModalClosing || modalClosing) {
                console.log('Incident modal opening prevented - in closing state');
                return;
            }
            
            const modal = document.getElementById('incident-drilldown-modal');
            const modalContent = modal.querySelector('.modal-content');
            const modalLoading = document.getElementById('incident-modal-loading');
            const modalData = document.getElementById('incident-modal-data');
            const monthNameSpan = document.getElementById('incident-month-name');
            
            // Set month name
            if (monthNameSpan) monthNameSpan.textContent = monthLabel + ' 2025';
            
            // Reset animation classes and modal state
            modal.classList.remove('closing', 'hidden');
            modalContent.classList.remove('closing');
            modal.style.display = 'flex';
            
            // Reset content visibility
            if (modalLoading) modalLoading.classList.remove('hidden');
            if (modalData) modalData.classList.add('hidden');
            
            // Trigger entrance animation
            setTimeout(() => {
                modalContent.style.animation = 'modalSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
            }, 10);
            
            console.log('Incident modal opened successfully');
            
            // Fetch incident drill-down data
            setTimeout(() => {
                fetchIncidentDrillDownData(monthDate, monthLabel);
            }, 800);
        }

        function closeIncidentDrillDown() {
            console.log('Closing Incident drill-down modal');
            
            const modal = document.getElementById('incident-drilldown-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Track close time for force reset mechanism
            window.lastIncidentCloseTime = Date.now();
            
            // Set specific incident drilldown modal flag to prevent immediate reopening
            incidentDrilldownModalClosing = true;
            modalClosing = true;
            
            // Add closing animation classes
            modal.classList.add('closing');
            modalContent.classList.add('closing');
            
            // Wait for animation to complete before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('closing');
                modalContent.classList.remove('closing');
                modal.style.display = 'none'; // Ensure it's fully hidden
                
                // Reset modal content to loading state for next time
                const modalLoading = document.getElementById('incident-modal-loading');
                const modalData = document.getElementById('incident-modal-data');
                if (modalLoading) modalLoading.classList.remove('hidden');
                if (modalData) modalData.classList.add('hidden');
                
                console.log('Incident modal hidden, resetting flags in 500ms');
                
                // Reset flags after a shorter delay for faster recovery
                setTimeout(() => {
                    modalClosing = false;
                    incidentDrilldownModalClosing = false;
                    console.log('Incident modal flags reset');
                }, 500); // Reduced from 1000ms to 500ms
            }, 300);
        }

        // FCR Drill-Down Functions
        function openFCRDrillDown(monthDate, monthLabel, fcrRate) {
            console.log(`Opening FCR drill-down for ${monthLabel} (${monthDate})`);
            console.log(`Modal flags - fcrModalClosing: ${fcrModalClosing}, modalClosing: ${modalClosing}`);
            
            // Force reset flags if they've been stuck for too long
            const now = Date.now();
            if (!window.lastFCRCloseTime) window.lastFCRCloseTime = 0;
            if (now - window.lastFCRCloseTime > 3000) { // If more than 3 seconds since last close
                fcrModalClosing = false;
                modalClosing = false;
                console.log('Force reset FCR modal flags due to timeout');
            }
            
            // Prevent opening if modal is in closing state
            if (fcrModalClosing || modalClosing) {
                console.log('FCR modal opening prevented - in closing state');
                return;
            }
            
            const modal = document.getElementById('fcr-drilldown-modal');
            const modalContent = modal.querySelector('.modal-content');
            const modalLoading = document.getElementById('fcr-modal-loading');
            const modalData = document.getElementById('fcr-modal-data');
            const monthNameSpan = document.getElementById('fcr-month-name');
            
            // Set month name
            if (monthNameSpan) monthNameSpan.textContent = monthLabel + ' 2025';
            
            // Reset animation classes and modal state
            modal.classList.remove('closing', 'hidden');
            modalContent.classList.remove('closing');
            modal.style.display = 'flex';
            
            // Reset content visibility
            if (modalLoading) modalLoading.classList.remove('hidden');
            if (modalData) modalData.classList.add('hidden');
            
            // Trigger entrance animation
            setTimeout(() => {
                modalContent.style.animation = 'modalSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
            }, 10);
            
            console.log('FCR modal opened successfully');
            
            // Fetch FCR drill-down data
            setTimeout(() => {
                fetchFCRDrillDownData(monthDate, monthLabel);
            }, 800);
        }

        function closeFCRDrillDown() {
            console.log('Closing FCR drill-down modal');
            
            const modal = document.getElementById('fcr-drilldown-modal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Track close time for force reset mechanism
            window.lastFCRCloseTime = Date.now();
            
            // Set specific FCR modal flag to prevent immediate reopening
            fcrModalClosing = true;
            modalClosing = true;
            
            // Add closing animation classes
            modal.classList.add('closing');
            modalContent.classList.add('closing');
            
            // Wait for animation to complete before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('closing');
                modalContent.classList.remove('closing');
                modal.style.display = 'none'; // Ensure it's fully hidden
                
                // Reset modal content to loading state for next time
                const modalLoading = document.getElementById('fcr-modal-loading');
                const modalData = document.getElementById('fcr-modal-data');
                if (modalLoading) modalLoading.classList.remove('hidden');
                if (modalData) modalData.classList.add('hidden');
                
                console.log('FCR modal hidden, resetting flags in 500ms');
                
                // Reset flags after a shorter delay for faster recovery
                setTimeout(() => {
                    modalClosing = false;
                    fcrModalClosing = false;
                    console.log('FCR modal flags reset');
                }, 500); // Reduced from 1000ms to 500ms
            }, 300);
        }

        async function fetchIncidentDrillDownData(monthDate, monthLabel) {
            try {
                console.log(`ðŸ” INCIDENT DRILL-DOWN VERIFICATION for: ${monthLabel} (${monthDate})`);
                
                // Get expected incident count from chart data for validation
                const expectedIncidentCount = getExpectedIncidentCountFromChart(monthDate);
                console.log(`ðŸ“Š Expected incident count from chart: ${expectedIncidentCount}`);
                
                // Store the current drill-down month for application drill-down
                currentDrillDownMonth = monthDate;
                
                // For drill-down, we want complete month data without dashboard filters
                // This allows meaningful month-to-month comparisons across all data
                const response = await fetch(`/api/incident_drilldown?month=${monthDate}`);
                
                // Show notification about data scope
                showDrillDownNotification('month', monthLabel);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`ðŸ”„ Received incident drill-down data:`, data);
                
                // Validate incident count consistency
                if (expectedIncidentCount !== null && data.total_incidents !== undefined) {
                    const actualCount = data.total_incidents;
                    if (expectedIncidentCount === actualCount) {
                        console.log(`âœ… INCIDENT COUNT VALIDATED: Chart (${expectedIncidentCount}) matches drill-down (${actualCount})`);
                    } else {
                        console.warn(`âš ï¸ INCIDENT COUNT MISMATCH: Chart shows ${expectedIncidentCount}, drill-down shows ${actualCount}`);
                    }
                }
                
                populateIncidentDrillDown(data);
            } catch (error) {
                console.error('Error fetching incident drill-down data:', error);
                document.getElementById('incident-modal-loading').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load incident analysis</p>
                        <p class="text-sm mt-2" style="color: var(--modal-text-secondary);">${error.message}</p>
                        <button onclick="fetchIncidentDrillDownData('${monthDate}', '${monthLabel}')" class="mt-4 px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        async function fetchFCRDrillDownData(monthDate, monthLabel) {
            try {
                console.log(`ðŸ” FCR DRILL-DOWN VERIFICATION for: ${monthLabel} (${monthDate})`);
                
                // Get expected FCR rate from chart data for validation
                const expectedFCRRate = getExpectedFCRRateFromChart(monthDate);
                console.log(`ðŸ“Š Expected FCR rate from chart: ${expectedFCRRate}%`);
                
                // For drill-down, we want complete month data without dashboard filters
                // This allows meaningful month-to-month comparisons across all data
                const response = await fetch(`/api/fcr_drilldown?month=${monthDate}`);
                
                // Show notification about data scope
                showDrillDownNotification('month', monthLabel);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`ðŸ”„ Received FCR drill-down data:`, data);
                
                // Validate FCR rate consistency
                if (expectedFCRRate !== null && data.fcr_rate !== undefined) {
                    const actualRate = data.fcr_rate;
                    const tolerance = 0.1; // Allow small rounding differences
                    if (Math.abs(expectedFCRRate - actualRate) <= tolerance) {
                        console.log(`âœ… FCR RATE VALIDATED: Chart (${expectedFCRRate}%) matches drill-down (${actualRate}%)`);
                    } else {
                        console.warn(`âš ï¸ FCR RATE MISMATCH: Chart shows ${expectedFCRRate}%, drill-down shows ${actualRate}%`);
                    }
                }
                
                populateFCRDrillDown(data);
            } catch (error) {
                console.error('Error fetching FCR drill-down data:', error);
                document.getElementById('fcr-modal-loading').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load FCR analysis</p>
                        <p class="text-sm mt-2" style="color: var(--modal-text-secondary);">${error.message}</p>
                        <button onclick="fetchFCRDrillDownData('${monthDate}', '${monthLabel}')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function populateIncidentDrillDown(data) {
            // Update summary metrics
            document.getElementById('incident-total-count').textContent = (data.total_incidents || 0).toLocaleString();
            document.getElementById('incident-avg-daily').textContent = (data.insights.avg_daily_incidents || 0).toFixed(1);
            document.getElementById('incident-major-percentage').textContent = `${data.incident_breakdown.major.percentage}%`;
            // Update KB coverage in place of peak hour
            if (data.insights.kb_coverage !== undefined) {
                document.getElementById('incident-peak-hour').textContent = data.insights.kb_coverage + '%';
                // Update the label too
                const peakHourCard = document.getElementById('incident-peak-hour').parentElement;
                const labelDiv = peakHourCard.querySelector('div:first-child');
                if (labelDiv) {
                    labelDiv.textContent = 'KB Coverage';
                }
            }
            
            // Populate affected applications
            const appsContainer = document.getElementById('incident-applications-list');
            appsContainer.innerHTML = '';
            data.affected_applications.forEach((app, index) => {
                const appDiv = document.createElement('div');
                appDiv.className = 'flex items-center justify-between p-2 bg-gray-700 rounded cursor-pointer hover:bg-gray-600 transition-colors';
                appDiv.innerHTML = `
                    <span class="text-sm">${app.name} <span class="text-xs text-blue-400 ml-2">â–¶ Click for details</span></span>
                    <div class="text-right">
                        <span class="text-cyan-400 font-semibold">${app.count}</span>
                        <span class="text-xs text-gray-400 ml-1">(${app.percentage}%)</span>
                    </div>
                `;
                
                // Add click handler for drill-down
                appDiv.addEventListener('click', () => {
                    console.log(`ðŸ–±ï¸ Application clicked: "${app.name}"`);
                    showApplicationDrillDown(app.name);
                });
                
                appsContainer.appendChild(appDiv);
            });
            
            // Populate KB articles
            const kbContainer = document.getElementById('incident-kb-articles-list');
            kbContainer.innerHTML = '';
            if (data.top_kb_articles && data.top_kb_articles.length > 0) {
                data.top_kb_articles.forEach((kb, index) => {
                    const kbDiv = document.createElement('div');
                    kbDiv.className = 'p-3 bg-gray-700 rounded mb-2';
                    kbDiv.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-mono text-sm text-cyan-400 mb-1">${kb.kb_id}</div>
                                <div class="text-sm" style="color: var(--modal-text-secondary);">${kb.description}</div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="text-cyan-400 font-semibold">${kb.count}</div>
                                <div class="text-xs text-gray-400">${kb.percentage}%</div>
                            </div>
                        </div>
                    `;
                    kbContainer.appendChild(kbDiv);
                });
            } else {
                kbContainer.innerHTML = '<div class="text-center py-4 text-gray-400">No KB articles used in this period</div>';
            }
            
            // Populate critical incidents table
            const tableBody = document.getElementById('incident-critical-table');
            tableBody.innerHTML = '';
            data.critical_incidents.forEach((incident) => {
                const row = document.createElement('tr');
                row.className = 'transition-colors hover:bg-gray-700 cursor-pointer';
                row.style.borderBottom = '1px solid var(--modal-border)';
                row.innerHTML = `
                    <td class="py-2 px-2 text-cyan-400 hover:text-cyan-300" onclick="openIncidentDetails('${incident.number}')">${incident.number}</td>
                    <td class="py-2 px-2 text-xs">${incident.description}</td>
                    <td class="py-2 px-2 text-xs">${incident.team.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '')}</td>
                    <td class="text-right py-2 px-2">${incident.mttr_hours}h</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Show data and hide loading
            document.getElementById('incident-modal-loading').classList.add('hidden');
            const modalData = document.getElementById('incident-modal-data');
            modalData.classList.remove('hidden');
            
            // Add staggered entrance animations
            const animationSections = modalData.querySelectorAll('.rounded-lg');
            animationSections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                section.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, 100 + (index * 100));
            });
        }

        function populateFCRDrillDown(data) {
            // Update summary metrics
            document.getElementById('fcr-rate-value').textContent = `${data.fcr_rate}%`;
            document.getElementById('fcr-total-incidents').textContent = (data.total_incidents || 0).toLocaleString();
            document.getElementById('fcr-successful').textContent = (data.successful_fcr || 0).toLocaleString();
            document.getElementById('fcr-reopened').textContent = (data.reopened_incidents || 0).toLocaleString();
            
            // Update KB impact
            document.getElementById('fcr-kb-rate').textContent = `${data.kb_impact.with_kb.fcr_rate}%`;
            document.getElementById('fcr-kb-count').textContent = (data.kb_impact.with_kb.total || 0).toLocaleString();
            document.getElementById('fcr-no-kb-rate').textContent = `${data.kb_impact.without_kb.fcr_rate}%`;
            document.getElementById('fcr-no-kb-count').textContent = (data.kb_impact.without_kb.total || 0).toLocaleString();
            
            // Populate best teams
            const bestTeamsContainer = document.getElementById('fcr-best-teams');
            bestTeamsContainer.innerHTML = '';
            data.best_performing_teams.forEach((team) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'flex items-center justify-between p-2 bg-gray-700 rounded';
                teamDiv.innerHTML = `
                    <span class="text-sm">${team.team.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '')}</span>
                    <div class="text-right">
                        <span class="text-green-400 font-semibold">${team.fcr_rate}%</span>
                        <span class="text-xs text-gray-400 ml-1">(${team.total_incidents})</span>
                    </div>
                `;
                bestTeamsContainer.appendChild(teamDiv);
            });
            
            // Populate worst teams
            const worstTeamsContainer = document.getElementById('fcr-worst-teams');
            worstTeamsContainer.innerHTML = '';
            data.worst_performing_teams.forEach((team) => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'flex items-center justify-between p-2 bg-gray-700 rounded';
                teamDiv.innerHTML = `
                    <span class="text-sm">${team.team.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '')}</span>
                    <div class="text-right">
                        <span class="text-red-400 font-semibold">${team.fcr_rate}%</span>
                        <span class="text-xs text-gray-400 ml-1">(${team.total_incidents})</span>
                    </div>
                `;
                worstTeamsContainer.appendChild(teamDiv);
            });
            
            // Populate reopen reasons
            const reopenContainer = document.getElementById('fcr-reopen-reasons');
            reopenContainer.innerHTML = '';
            data.reopen_reasons.forEach((reason) => {
                const reasonDiv = document.createElement('div');
                reasonDiv.className = 'p-3 bg-gray-700 rounded';
                reasonDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium">${reason.reason}</span>
                        <span class="text-red-400 font-semibold">${reason.count}</span>
                    </div>
                    <div class="text-xs text-gray-400">${reason.percentage}% of reopens</div>
                    <div class="w-full bg-gray-600 rounded-full h-2 mt-2">
                        <div class="bg-red-400 h-2 rounded-full" style="width: ${reason.percentage}%"></div>
                    </div>
                `;
                reopenContainer.appendChild(reasonDiv);
            });
            
            // Populate incident types FCR
            const typesContainer = document.getElementById('fcr-incident-types');
            typesContainer.innerHTML = '';
            data.incident_types_fcr.forEach((type) => {
                const typeDiv = document.createElement('div');
                typeDiv.className = 'flex items-center justify-between p-2 bg-gray-700 rounded';
                typeDiv.innerHTML = `
                    <span class="text-sm">${type.symptom}</span>
                    <div class="text-right">
                        <span class="text-blue-400 font-semibold">${type.fcr_rate}%</span>
                        <span class="text-xs text-gray-400 ml-1">(${type.total_incidents})</span>
                    </div>
                `;
                typesContainer.appendChild(typeDiv);
            });
            
            // Populate reopened incidents table
            const tableBody = document.getElementById('fcr-reopened-table');
            tableBody.innerHTML = '';
            data.reopened_samples.forEach((incident) => {
                const row = document.createElement('tr');
                row.className = 'transition-colors hover:bg-gray-700 cursor-pointer';
                row.style.borderBottom = '1px solid var(--modal-border)';
                row.innerHTML = `
                    <td class="py-2 px-2 text-blue-400 hover:text-blue-300" onclick="openIncidentDetails('${incident.number}')">${incident.number}</td>
                    <td class="py-2 px-2 text-xs">${incident.description}</td>
                    <td class="py-2 px-2 text-xs">${incident.team.replace('AEDT - Enterprise Tech Spot - ', '').replace('ADE - Enterprise Tech Spot - ', '')}</td>
                    <td class="text-right py-2 px-2 text-red-400">${incident.reopen_count}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Show data and hide loading
            document.getElementById('fcr-modal-loading').classList.add('hidden');
            const modalData = document.getElementById('fcr-modal-data');
            modalData.classList.remove('hidden');
            
            // Add staggered entrance animations
            const animationSections = modalData.querySelectorAll('.rounded-lg');
            animationSections.forEach((section, index) => {
                section.style.opacity = '0';
                section.style.transform = 'translateY(20px)';
                section.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                
                setTimeout(() => {
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }, 100 + (index * 100));
            });
        }

        function syncQuarterFilter(newQuarter, source) {
            // Update the global quarter variable
            currentQuarter = newQuarter;
            
            // Sync both filter dropdowns
            const mainFilter = document.getElementById('quarter-filter');
            const modalFilter = document.getElementById('modal-quarter-filter');
            
            if (source !== 'main' && mainFilter) {
                mainFilter.value = newQuarter;
            }
            if (source !== 'modal' && modalFilter) {
                modalFilter.value = newQuarter;
            }
            
            // Update dashboard title and subtitles
            updateDashboardTitles();
            
            // Refresh all main dashboard data
            refreshAllData();
            
            // If modal is open, refresh the drill-down data too
            if (window.currentDrillDownTeam && !document.getElementById('team-modal').classList.contains('hidden')) {
                updateModalQuarterInfo();
                fetchTeamDrillDownData(window.currentDrillDownTeam);
            }
        }

        function updateModalQuarterInfo() {
            const modalQuarterInfo = document.getElementById('modal-quarter-info');
            if (modalQuarterInfo) {
                let quarterText;
                if (currentTimePeriod === 'Q1') {
                    quarterText = 'Q1 (Feb-Apr)';
                } else if (currentTimePeriod === 'Q2') {
                    quarterText = 'Q2 (May-Jun)';
                } else if (currentTimePeriod.match(/^\d{4}-\d{2}$/)) {
                    const monthNames = {
                        '2025-02': 'February 2025',
                        '2025-03': 'March 2025', 
                        '2025-04': 'April 2025',
                        '2025-05': 'May 2025',
                        '2025-06': 'June 2025'
                    };
                    quarterText = monthNames[currentTimePeriod];
                } else {
                    quarterText = '(Feb-Jun)';
                }
                if (modalQuarterInfo) {
                    modalQuarterInfo.textContent = `FY 2026 ${quarterText} - Detailed Analysis`;
                }
            }
        }

        function updateDashboardTitles() {
            const title = document.querySelector('h1');
            const baseTitle = 'FY26 TECH SPOT OPERATIONAL METRICS';
            
            // Build title suffix based on filters
            let titleSuffix = '';
            let timeText = '';
            let regionText = '';
            
            // Parse current time period for display
            if (currentTimePeriod === 'Q1') {
                timeText = 'Q1 (Feb-Apr)';
            } else if (currentTimePeriod === 'Q2') {
                timeText = 'Q2 (May-Jun)';
            } else if (currentTimePeriod.match(/^\d{4}-\d{2}$/)) {
                const monthNames = {
                    '2025-02': 'February 2025',
                    '2025-03': 'March 2025', 
                    '2025-04': 'April 2025',
                    '2025-05': 'May 2025',
                    '2025-06': 'June 2025'
                };
                timeText = monthNames[currentTimePeriod];
            }
            
            if (currentRegion !== 'all') {
                regionText = currentRegion;
            }
            
            if (timeText && regionText) {
                titleSuffix = ` - ${timeText} - ${regionText}`;
            } else if (timeText) {
                titleSuffix = ` - ${timeText}`;
            } else if (regionText) {
                titleSuffix = ` - ${regionText}`;
            }
            
            title.textContent = baseTitle + titleSuffix;
            
            // Update all chart subtitles
            let subtitleText;
            if (currentTimePeriod === 'Q1') {
                subtitleText = 'FY 2026 - Q1 (Feb-Apr)';
            } else if (currentTimePeriod === 'Q2') {
                subtitleText = 'FY 2026 - Q2 (May-Jun)';
            } else if (currentTimePeriod.match(/^\d{4}-\d{2}$/)) {
                const monthNames = {
                    '2025-02': 'FY 2026 - February 2025',
                    '2025-03': 'FY 2026 - March 2025', 
                    '2025-04': 'FY 2026 - April 2025',
                    '2025-05': 'FY 2026 - May 2025',
                    '2025-06': 'FY 2026 - June 2025'
                };
                subtitleText = monthNames[currentTimePeriod];
            } else {
                subtitleText = 'FY 2026 - Last 6 Months';
            }
            
            if (currentRegion !== 'all') {
                subtitleText += ` - ${currentRegion}`;
            }
            
            const subtitleElements = ['incident-subtitle', 'fcr-subtitle', 'mttr-subtitle'];
            subtitleElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = subtitleText;
            });
            
            const slaSubtitle = document.getElementById('sla-subtitle');
            if (slaSubtitle) slaSubtitle.textContent = subtitleText + ' - Goal: 3hrs 12min | Baseline: 4hrs';
            
            const breachSubtitle = document.getElementById('breach-subtitle');
            if (breachSubtitle) breachSubtitle.textContent = subtitleText + ' (MTTR > 240min)';
            
            const aiSubtitle = document.getElementById('ai-subtitle');
            if (aiSubtitle) aiSubtitle.textContent = subtitleText + ' - Data-Driven Operational Insights';
        }


async function fetchTeamDrillDownData(teamName, timePeriod = null) {
    try {
        // Use current dashboard filters if no specific time period provided
        let selectedTimePeriod = timePeriod;
        if (!selectedTimePeriod) {
            const modalFilter = document.getElementById("modal-time-period-filter");
            if (modalFilter) {
                selectedTimePeriod = modalFilter.value;
            } else {
                // Fall back to current dashboard filters
                const currentTimePeriod = document.getElementById("time-period-filter")?.value || "all";
                selectedTimePeriod = currentTimePeriod;
            }
        }
        
        console.log(`ðŸ” TEAM DRILL-DOWN VERIFICATION for: "${teamName}"`);
        console.log(`ðŸ“… Time period: "${selectedTimePeriod}"`);
        console.log(`ðŸŽ›ï¸ Dashboard filter: ${document.getElementById("time-period-filter")?.value}`);
        console.log(`ðŸŽ›ï¸ Modal filter: ${document.getElementById("modal-time-period-filter")?.value}`);
        
        // Get expected data from main table for validation
        const expectedData = getTeamDataFromMainTable(teamName);
        console.log(`ðŸ“Š Expected data from main table:`, expectedData);
        
        const { quarter, month } = parseTimePeriod(selectedTimePeriod);
        console.log(`DEBUG: Parsed values - quarter: ${quarter}, month: ${month}`);
        const response = await fetch(`/api/team_drill_down?team=${encodeURIComponent(teamName)}&quarter=${quarter}&month=${month}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
            console.error("API Error:", response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }
                
                const teamData = await response.json();
        console.log("ðŸ”„ Received team data:", teamData);
        
        // Comprehensive validation of drill-down data
        if (expectedData && teamData.metrics) {
            console.log('ðŸ” VALIDATING TEAM DRILL-DOWN DATA:');
            
            const validationResults = {
                incidents: {
                    expected: expectedData.incidents,
                    actual: teamData.metrics.total_incidents,
                    match: expectedData.incidents === teamData.metrics.total_incidents
                },
                fcr: {
                    expected: expectedData.fcrRate,
                    actual: teamData.metrics.fcr_rate,
                    match: Math.abs(expectedData.fcrRate - teamData.metrics.fcr_rate) <= 0.1
                },
                mttr: {
                    expected: expectedData.avgResolutionTime,
                    actual: teamData.metrics.avg_mttr_hours,
                    match: Math.abs(expectedData.avgResolutionTime - teamData.metrics.avg_mttr_hours) <= 0.2
                },
                criticalBreaches: {
                    expected: expectedData.criticalBreaches,
                    actual: teamData.metrics.critical_breaches,
                    match: expectedData.criticalBreaches === teamData.metrics.critical_breaches
                }
            };
            
            console.log('ðŸ“Š VALIDATION RESULTS:', validationResults);
            
            // Check for any mismatches
            const mismatches = Object.entries(validationResults).filter(([key, result]) => !result.match);
            if (mismatches.length === 0) {
                console.log('âœ… ALL DATA VALIDATED - Perfect match between main table and drill-down!');
            } else {
                console.warn('âš ï¸ DATA DISCREPANCIES FOUND:');
                mismatches.forEach(([metric, result]) => {
                    console.warn(`  ${metric}: Expected ${result.expected}, Got ${result.actual}`);
                });
            }
        }
                
        showDrillDownNotification("team", teamName);
        
                verifyDataConsistency(teamName, teamData);
                
                populateTeamDrillDown(teamData);
            } catch (error) {
        console.error("Error fetching team drill-down data:", error);
        
        // Log additional debug info for DGTC team specifically
        if (teamName === "DGTC") {
            console.log("DGTC team debug info:", {
                teamName: teamName,
                errorMessage: error.message,
                responseStatus: error.status || "Unknown",
                timestamp: new Date().toISOString()
            });
        }
        
        const modalLoading = document.getElementById("modal-loading");
        if (modalLoading) {
            modalLoading.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load team data for "${teamName}"</p>
                        <p class="text-sm mt-2" style="color: var(--modal-text-secondary);">${error.message}</p>
                        <button onclick="fetchTeamDrillDownData('${teamName}')" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
}        function verifyDataConsistency(teamName, drillDownData) {
            // Get the corresponding row from the main team performance table
            const teamRows = document.querySelectorAll('#team-performance-table tr');
            let mainTableData = null;
            
            for (let row of teamRows) {
                const teamCell = row.querySelector('.team-name');
                if (teamCell && teamCell.textContent.trim() === teamName) {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 9) {
                        mainTableData = {
                            incidents: parseInt(cells[2].textContent.replace(/,/g, '')),
                            avgResolutionTime: parseFloat(cells[3].textContent),
                            fcrRate: parseFloat(cells[4].textContent.replace('%', '')),
                            slaCompliance: parseFloat(cells[5].textContent.replace('%', '')),
                            slaBreaches: parseInt(cells[6].textContent.replace(/,/g, '')),
                            criticalBreaches: parseInt(cells[8].textContent.replace(/,/g, ''))
                        };
                    }
                    break;
                }
            }
            
            if (mainTableData && drillDownData.metrics) {
                const tolerance = 0.2; // Allow small rounding differences (increased for business hours calculation)
                const mttrTolerance = 0.3; // Allow larger differences for MTTR due to business hours calculation changes
                const slaToleranceHigh = 5.0; // Allow larger differences for SLA compliance (different calculation methods)
                
                // Check for major discrepancies
                const incidentMatch = mainTableData.incidents === drillDownData.metrics.total_incidents;
                const fcrMatch = Math.abs(mainTableData.fcrRate - drillDownData.metrics.fcr_rate) <= tolerance;
                const mttrMatch = Math.abs(mainTableData.avgResolutionTime - drillDownData.metrics.avg_mttr_hours) <= mttrTolerance;
                const slaMatch = Math.abs(mainTableData.slaCompliance - drillDownData.metrics.sla_compliance) <= slaToleranceHigh;
                // For breach comparison, main table shows total breaches, drill-down shows critical breaches only
                // So we expect main table breaches >= drill-down critical breaches
                const breachMatch = mainTableData.slaBreaches >= drillDownData.metrics.critical_breaches;
                const criticalMatch = mainTableData.criticalBreaches === drillDownData.metrics.critical_breaches;
                
                // Only warn about major discrepancies (incidents, FCR, critical breaches)
                // MTTR and SLA compliance can have small differences due to different calculation methods
                const majorDiscrepancies = !incidentMatch || !fcrMatch || !criticalMatch;
                
                if (majorDiscrepancies) {
                    // Only log significant discrepancies - minor calculation differences are normal
                    console.log(`â„¹ï¸  Data consistency check for team: ${teamName}`);
                    console.log(`ðŸ“Š Main table data:`, mainTableData);
                    console.log(`ðŸ” Drill-down data:`, drillDownData.metrics);
                    if (!incidentMatch) {
                        console.warn(`  âš ï¸  Incident count mismatch: ${mainTableData.incidents} vs ${drillDownData.metrics.total_incidents}`);
                    }
                    if (!fcrMatch) {
                        console.warn(`  âš ï¸  FCR rate mismatch: ${mainTableData.fcrRate}% vs ${drillDownData.metrics.fcr_rate}%`);
                    }
                    if (!criticalMatch) {
                        console.warn(`  âš ï¸  Critical breaches mismatch: ${mainTableData.criticalBreaches} vs ${drillDownData.metrics.critical_breaches}`);
                    }
                } else {
                    console.log(`âœ… Data consistency verified for team: ${teamName}`);
                }
            }
        }



        function populateTeamDrillDown(data) {
            // IMMEDIATE DEBUG - Check if function is called
            console.log('ðŸš¨ POPULATE TEAM DRILL-DOWN FUNCTION CALLED');
            console.log('ðŸš¨ Data received:', data);
            console.log('ðŸš¨ Data type:', typeof data);
            console.log('ðŸš¨ Data is null/undefined:', data === null || data === undefined);
            
            // Add comprehensive defensive programming for data structure
            if (data && data.metrics) {
                console.log('ðŸ”§ data.metrics.total_incidents:', data.metrics.total_incidents);
            } else {
                console.log('ðŸš¨ DATA OR METRICS IS MISSING!');
                console.log('ðŸš¨ data exists:', !!data);
                console.log('ðŸš¨ data.metrics exists:', !!(data && data.metrics));
            }
            
            // Ensure metrics object exists
            const metrics = data.metrics || {};
            
            // Update overview metrics
            const drillIncidents = document.getElementById('drill-incidents');
            const drillFcr = document.getElementById('drill-fcr');
            const drillMttr = document.getElementById('drill-mttr');
            const drillSlaGoal = document.getElementById('drill-sla-goal');
            const drillSlaBaseline = document.getElementById('drill-sla-baseline');
            const drillCriticalBreaches = document.getElementById('drill-critical-breaches');
            const drillModerateBreaches = document.getElementById('drill-moderate-breaches');
            
            // Fix: Use ultra-robust defensive programming with comprehensive error handling
            if (drillIncidents) {
                try {
                    const incidentCount = metrics.total_incidents || data.total_incidents || 0;
                    console.log('ðŸ”§ incidentCount value:', incidentCount, 'type:', typeof incidentCount);
                    
                    // Ensure incidentCount is a valid number
                    const safeIncidentCount = (typeof incidentCount === 'number' && !isNaN(incidentCount)) ? incidentCount : 0;
                    drillIncidents.textContent = safeIncidentCount.toLocaleString();
                } catch (error) {
                    console.error('ðŸš¨ Error in incident count formatting:', error);
                    drillIncidents.textContent = '0';
                }
            }
            if (drillFcr) drillFcr.textContent = `${metrics.fcr_rate || 0}%`;
            if (drillMttr) drillMttr.textContent = `${metrics.avg_mttr_hours || 0}h`;
            if (drillSlaGoal) drillSlaGoal.textContent = `${metrics.sla_goal_compliance || 0}%`;
            if (drillSlaBaseline) drillSlaBaseline.textContent = '';
            
            // Update breach analysis with ultra-robust defensive programming
            if (drillCriticalBreaches) {
                try {
                    const criticalCount = metrics.critical_breaches || 0;
                    const safeCriticalCount = (typeof criticalCount === 'number' && !isNaN(criticalCount)) ? criticalCount : 0;
                    drillCriticalBreaches.textContent = safeCriticalCount.toLocaleString();
                } catch (error) {
                    console.error('ðŸš¨ Error in critical breaches formatting:', error);
                    drillCriticalBreaches.textContent = '0';
                }
            }
            if (drillModerateBreaches) {
                try {
                    const moderateCount = metrics.moderate_breaches || 0;
                    const safeModerateCount = (typeof moderateCount === 'number' && !isNaN(moderateCount)) ? moderateCount : 0;
                    drillModerateBreaches.textContent = safeModerateCount.toLocaleString();
                } catch (error) {
                    console.error('ðŸš¨ Error in moderate breaches formatting:', error);
                    drillModerateBreaches.textContent = '0';
                }
            }
            
            // Create charts
            createTeamIncidentChart(data.monthly_incidents, data.monthlyLabels);
            createTeamMetricsChart(data.monthly_metrics, data.monthlyLabels);
            
            // Populate recent incidents table
            populateRecentIncidentsTable(data.recent_incidents);
            
            // Show data and hide loading with staggered animation
            document.getElementById('modal-loading').classList.add('hidden');
            const modalData = document.getElementById('modal-data');
            modalData.classList.remove('hidden');
            
            // Add staggered entrance animations for content sections
            const animationSections = [
                modalData.querySelector('.grid.grid-cols-2.md\\:grid-cols-4'), // Overview cards
                modalData.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-6'), // Charts
                modalData.querySelectorAll('.rounded-lg.p-4')[2], // SLA breach analysis
                modalData.querySelectorAll('.rounded-lg.p-4')[3]  // Recent incidents table
            ];
            
            animationSections.forEach((section, index) => {
                if (section) {
                    section.style.opacity = '0';
                    section.style.transform = 'translateY(20px)';
                    section.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    
                    setTimeout(() => {
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }, 100 + (index * 150)); // Staggered timing
                }
            });
            
            // Animate the overview metric cards individually
            const metricCards = modalData.querySelectorAll('.grid.grid-cols-2.md\\:grid-cols-4 > div');
            metricCards.forEach((card, index) => {
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.8) translateY(20px)';
                    card.style.transition = 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'scale(1) translateY(0)';
                    }, 200 + (index * 100));
                }
            });
        }

        function createTeamIncidentChart(monthlyData, monthlyLabels) {
            const ctx = document.getElementById('team-incident-chart').getContext('2d');
            const chartContainer = ctx.canvas.parentElement;
            
            // Add loading state
            chartContainer.style.opacity = '0';
            chartContainer.style.transform = 'scale(0.9)';
            
            if (teamIncidentChart) {
                teamIncidentChart.destroy();
            }
            
            const isDark = currentTheme === 'dark';
            
            teamIncidentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'Monthly Incidents',
                        data: monthlyData,
                        borderColor: isDark ? '#06d6a0' : '#041F41',
                        backgroundColor: isDark ? 'rgba(6, 214, 160, 0.1)' : 'rgba(4, 31, 65, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e5e7eb' : '#374151'
                            }
                        },
                        x: {
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e5e7eb' : '#374151'
                            }
                        }
                    }
                }
            });
            
            // Animate chart appearance
            setTimeout(() => {
                chartContainer.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                chartContainer.style.opacity = '1';
                chartContainer.style.transform = 'scale(1)';
            }, 100);
        }

        function createTeamMetricsChart(metricsData, monthlyLabels) {
            const ctx = document.getElementById('team-metrics-chart').getContext('2d');
            const chartContainer = ctx.canvas.parentElement;
            
            // Add loading state
            chartContainer.style.opacity = '0';
            chartContainer.style.transform = 'scale(0.9)';
            
            if (teamMetricsChart) {
                teamMetricsChart.destroy();
            }
            
            const isDark = currentTheme === 'dark';
            
            teamMetricsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [
                        {
                            label: 'FCR Rate (%)',
                            data: metricsData.fcr,
                            backgroundColor: isDark ? 'rgba(168, 85, 247, 0.8)' : 'rgba(124, 58, 237, 0.8)',
                            borderColor: isDark ? '#a855f7' : '#7c3aed',
                            borderWidth: 1
                        },
                        {
                            label: 'SLA Compliance (%)',
                            data: metricsData.sla,
                            backgroundColor: isDark ? 'rgba(34, 197, 94, 0.8)' : 'rgba(21, 128, 61, 0.8)',
                            borderColor: isDark ? '#22c55e' : '#15803d',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: isDark ? '#e5e7eb' : '#374151'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e5e7eb' : '#374151'
                            }
                        },
                        x: {
                            grid: {
                                color: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: isDark ? '#e5e7eb' : '#374151'
                            }
                        }
                    }
                }
            });
            
            // Animate chart appearance
            setTimeout(() => {
                chartContainer.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                chartContainer.style.opacity = '1';
                chartContainer.style.transform = 'scale(1)';
            }, 200); // Slightly delayed from incident chart
        }

        function populateRecentIncidentsTable(incidents) {
            const tbody = document.getElementById('recent-incidents-table');
            tbody.innerHTML = '';
            
            incidents.forEach(incident => {
                const row = document.createElement('tr');
                row.className = 'transition-colors';
                row.style.borderBottom = '1px solid var(--modal-border)';
                row.addEventListener('mouseenter', () => {
                    row.style.backgroundColor = 'var(--modal-card-bg)';
                });
                row.addEventListener('mouseleave', () => {
                    row.style.backgroundColor = 'transparent';
                });
                
                const priorityClass = {
                    'Critical': 'text-red-400 font-bold',
                    'High': 'text-orange-400 font-semibold',
                    'Medium': 'text-yellow-400',
                    'Low': 'text-blue-400'
                }[incident.priority] || '';
                
                // Enhanced SLA status classification with better colors
                const statusClass = {
                    'Severe Breach': 'text-red-600 font-bold',
                    'Critical Breach': 'text-red-400 font-bold',
                    'Major Breach': 'text-orange-400 font-semibold',
                    'Minor Breach': 'text-yellow-400',
                    'Met': 'text-green-400'
                }[incident.sla_status] || '';
                
                // SLA variance color coding
                let varianceClass = 'text-gray-400';
                if (incident.sla_variance && incident.sla_variance.includes('over SLA')) {
                    const hoursOver = parseFloat(incident.sla_variance.match(/\d+\.?\d*/)[0]);
                    if (hoursOver >= 8) varianceClass = 'text-red-600 font-bold';
                    else if (hoursOver >= 4) varianceClass = 'text-red-400 font-semibold';
                    else if (hoursOver >= 2) varianceClass = 'text-orange-400';
                    else varianceClass = 'text-yellow-400';
                } else if (incident.sla_variance && incident.sla_variance.includes('Within SLA')) {
                    varianceClass = 'text-green-400';
                }
                
                row.innerHTML = `
                    <td class="py-2 px-2 font-mono text-xs">
                        <button onclick="openIncidentDetails('${incident.id}')" 
                                class="text-blue-400 hover:text-blue-300 underline hover:no-underline transition-colors cursor-pointer">
                            ${incident.id}
                        </button>
                    </td>
                    <td class="py-2 px-2 ${priorityClass}">${incident.priority}</td>
                    <td class="py-2 px-2" style="color: var(--modal-text-secondary);">${incident.created}</td>
                    <td class="text-right py-2 px-2 font-semibold" style="color: var(--modal-text);">${incident.resolution_time}</td>
                    <td class="text-right py-2 px-2 ${varianceClass} text-xs font-medium">${incident.sla_variance || 'N/A'}</td>
                    <td class="text-right py-2 px-2 ${statusClass}">${incident.sla_status}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updateModalTheme() {
            const modal = document.getElementById('team-modal');
            if (!modal || modal.classList.contains('hidden')) return;
            
            // Update modal filter dropdown styling
            const modalQuarterFilter = document.getElementById('modal-quarter-filter');
            const modalMonthFilter = document.getElementById('modal-month-filter');
            
            [modalQuarterFilter, modalMonthFilter].forEach(filter => {
                if (filter) {
                    filter.style.backgroundColor = 'var(--modal-card-bg)';
                    filter.style.color = 'var(--modal-text)';
                    filter.style.borderColor = 'var(--modal-border)';
                }
            });
            
            // Update chart colors if modal is open
            if (teamIncidentChart) {
                const isDark = currentTheme === 'dark';
                teamIncidentChart.data.datasets[0].borderColor = isDark ? '#06d6a0' : '#041F41';
                teamIncidentChart.data.datasets[0].backgroundColor = isDark ? 'rgba(6, 214, 160, 0.1)' : 'rgba(4, 31, 65, 0.1)';
                teamIncidentChart.update();
            }
            
            if (teamMetricsChart) {
                const isDark = currentTheme === 'dark';
                teamMetricsChart.data.datasets[0].backgroundColor = isDark ? 'rgba(168, 85, 247, 0.8)' : 'rgba(124, 58, 237, 0.8)';
                teamMetricsChart.data.datasets[0].borderColor = isDark ? '#a855f7' : '#7c3aed';
                teamMetricsChart.data.datasets[1].backgroundColor = isDark ? 'rgba(34, 197, 94, 0.8)' : 'rgba(21, 128, 61, 0.8)';
                teamMetricsChart.data.datasets[1].borderColor = isDark ? '#22c55e' : '#15803d';
                teamMetricsChart.update();
            }
        }

        // Incident Details Modal Functions
        function openIncidentDetails(incidentNumber) {
            const modal = document.getElementById('incident-modal');
            const modalContent = document.getElementById('incident-modal-content');
            const loading = document.getElementById('incident-loading');
            const content = document.getElementById('incident-content');
            
            // Show modal with loading state
            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            
            // Animate modal entrance
            setTimeout(() => {
                modalContent.style.opacity = '1';
                modalContent.style.transform = 'scale(1)';
            }, 10);
            
            // Update title
            document.getElementById('incident-modal-title').textContent = `Incident ${incidentNumber}`;
            document.getElementById('incident-modal-subtitle').textContent = 'Comprehensive incident analysis and timeline';
            
            // Fetch incident details
            fetch(`/api/incident_details?incident_number=${incidentNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    populateIncidentDetails(data);
                    
                    // Hide loading and show content
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                    
                    // Animate content appearance
                    setTimeout(() => {
                        const sections = content.querySelectorAll('.rounded-lg');
                        sections.forEach((section, index) => {
                            section.style.opacity = '0';
                            section.style.transform = 'translateY(20px)';
                            setTimeout(() => {
                                section.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                section.style.opacity = '1';
                                section.style.transform = 'translateY(0)';
                            }, index * 100);
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error fetching incident details:', error);
                    loading.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-red-500 text-lg font-medium">
                                Error loading incident details: ${error.message}
                            </div>
                            <button onclick="closeIncidentDetails()" 
                                    class="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                                Close
                            </button>
                        </div>
                    `;
                });
        }

        function closeIncidentDetails() {
            const modal = document.getElementById('incident-modal');
            const modalContent = document.getElementById('incident-modal-content');
            
            // Animate modal exit
            modalContent.style.opacity = '0';
            modalContent.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                modal.classList.add('hidden');
                // Reset modal state
                document.getElementById('incident-loading').classList.remove('hidden');
                document.getElementById('incident-content').classList.add('hidden');
                modalContent.style.opacity = '0';
                modalContent.style.transform = 'scale(0.95)';
            }, 300);
        }

        function populateIncidentDetails(data) {
            // Populate basic information
            const basicInfo = document.getElementById('basic-info');
            basicInfo.innerHTML = `
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Incident Number:</span>
                    <span class="font-mono" style="color: var(--modal-text);">${data.incident_number}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Assignment Group:</span>
                    <span style="color: var(--modal-text);">${data.basic_info.assignment_group}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Priority:</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityClass(data.basic_info.priority)}">${data.basic_info.priority}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Status:</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${data.basic_info.status.includes('Resolved') || data.basic_info.status.includes('Closed') ? 'text-green-400 bg-green-900' : 'text-yellow-400 bg-yellow-900'}">${data.basic_info.status}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Opened By:</span>
                    <span style="color: var(--modal-text);">${data.basic_info.opened_by}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Resolved By:</span>
                    <span style="color: var(--modal-text);">${data.basic_info.resolved_by}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Made SLA:</span>
                    <span class="${data.basic_info.made_sla ? 'text-green-400' : 'text-red-400'}">${data.basic_info.made_sla ? 'Yes' : 'No'}</span>
                </div>
            `;
            
            // Populate timing analysis
            const timingAnalysis = document.getElementById('timing-analysis');
            timingAnalysis.innerHTML = `
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Created:</span>
                    <span style="color: var(--modal-text);">${formatDateTime(data.basic_info.created)}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Resolved:</span>
                    <span style="color: var(--modal-text);">${data.basic_info.resolved === 'Not Resolved' ? 'Pending' : formatDateTime(data.basic_info.resolved)}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">Total Resolution Time:</span>
                    <span class="font-semibold" style="color: var(--modal-text);">${data.timing_analysis.total_resolution_time}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">SLA Target:</span>
                    <span style="color: var(--modal-text);">${data.timing_analysis.sla_target}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">SLA Status:</span>
                    <span class="px-2 py-1 rounded text-xs font-medium ${getSLAStatusClass(data.timing_analysis.sla_status)}">${data.timing_analysis.sla_status}</span>
                </div>
                <div class="flex justify-between">
                    <span style="color: var(--modal-text-secondary);">SLA Variance:</span>
                    <span class="font-medium ${data.timing_analysis.sla_variance_minutes > 0 ? 'text-red-400' : 'text-green-400'}">${data.timing_analysis.sla_variance_formatted}</span>
                </div>
            `;
            
            // Populate timeline
            const timeline = document.getElementById('incident-timeline');
            timeline.innerHTML = data.timeline.map(event => `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mt-1 ${event.status === 'completed' ? 'bg-green-400' : 'bg-yellow-400'}"></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h5 class="font-medium" style="color: var(--modal-text);">${event.event}</h5>
                            <span class="text-xs" style="color: var(--modal-text-secondary);">${event.timestamp === 'Pending' ? 'Pending' : formatDateTime(event.timestamp)}</span>
                        </div>
                        <p class="text-sm mt-1" style="color: var(--modal-text-secondary);">${event.description}</p>
                    </div>
                </div>
            `).join('');
            
            // Populate technical notes
            const techNotes = document.getElementById('tech-notes');
            techNotes.innerHTML = `
                <div>
                    <h5 class="font-medium mb-2 flex items-center" style="color: var(--modal-text);">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Customer Description
                    </h5>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded text-sm" style="color: var(--modal-text-secondary); background-color: var(--modal-border);">
                        ${formatTechNotes(data.tech_notes.customer_description)}
                    </div>
                </div>
                <div>
                    <h5 class="font-medium mb-2 flex items-center" style="color: var(--modal-text);">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Work Notes
                    </h5>
                    <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded text-sm" style="color: var(--modal-text-secondary); background-color: rgba(59, 130, 246, 0.1);">
                        ${formatTechNotes(data.tech_notes.work_notes)}
                    </div>
                </div>
                <div>
                    <h5 class="font-medium mb-2 flex items-center" style="color: var(--modal-text);">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Resolution Notes
                    </h5>
                    <div class="bg-green-50 dark:bg-green-900 p-3 rounded text-sm" style="color: var(--modal-text-secondary); background-color: rgba(34, 197, 94, 0.1);">
                        ${formatTechNotes(data.tech_notes.resolution_notes)}
                    </div>
                </div>
                <div>
                    <h5 class="font-medium mb-2 flex items-center" style="color: var(--modal-text);">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.832 18.477 19.246 18 17.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                        Knowledge Base Reference
                    </h5>
                    <div class="bg-purple-50 dark:bg-purple-900 p-3 rounded text-sm" style="color: var(--modal-text-secondary); background-color: rgba(168, 85, 247, 0.1);">
                        ${data.tech_notes.knowledge_id !== 'No KB article referenced' ? 
                            `<span class="font-mono text-purple-600 dark:text-purple-400">${data.tech_notes.knowledge_id}</span>` : 
                            `<span class="italic">${data.tech_notes.knowledge_id}</span>`
                        }
                    </div>
                </div>
            `;
            
            // Populate root cause analysis
            const rootCauseAnalysis = document.getElementById('root-cause-analysis');
            rootCauseAnalysis.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h5 class="font-medium mb-2" style="color: var(--modal-text);">Data Analysis</h5>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">${data.analysis.root_cause}</p>
                    </div>
                    <div>
                        <h5 class="font-medium mb-2" style="color: var(--modal-text);">Impact Assessment</h5>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">${data.analysis.impact_assessment}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h5 class="font-medium mb-2" style="color: var(--modal-text);">Incident Details</h5>
                        <div class="space-y-1 text-sm" style="color: var(--modal-text-secondary);">
                            <div class="flex justify-between">
                                <span>Affected Application:</span>
                                <span>${data.analysis.incident_details.affected_application}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Resolution Type:</span>
                                <span>${data.analysis.incident_details.resolution_type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Resolution Code:</span>
                                <span>${data.analysis.incident_details.resolution_code}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Reopen Count:</span>
                                <span class="${data.analysis.incident_details.reopen_count > 0 ? 'text-red-400' : 'text-green-400'}">${data.analysis.incident_details.reopen_count}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Reassignment Count:</span>
                                <span class="${data.analysis.incident_details.reassignment_count > 2 ? 'text-red-400' : data.analysis.incident_details.reassignment_count > 0 ? 'text-yellow-400' : 'text-green-400'}">${data.analysis.incident_details.reassignment_count}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Major Incident:</span>
                                <span class="${data.analysis.incident_details.major_incident ? 'text-red-400' : 'text-green-400'}">${data.analysis.incident_details.major_incident ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Created During:</span>
                                <span>${data.analysis.incident_details.weekend_incident ? 'Weekend' : 'Business Hours'}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h5 class="font-medium mb-2" style="color: var(--modal-text);">Real Data Insights</h5>
                        <p class="text-sm" style="color: var(--modal-text-secondary);">${data.analysis.lessons_learned}</p>
                    </div>
                </div>
            `;
        }

        function getPriorityClass(priority) {
            const classes = {
                'Critical': 'text-red-400 bg-red-900',
                'High': 'text-orange-400 bg-orange-900',
                'Medium': 'text-yellow-400 bg-yellow-900',
                'Low': 'text-blue-400 bg-blue-900'
            };
            return classes[priority] || 'text-gray-400 bg-gray-900';
        }

        function getSLAStatusClass(status) {
            const classes = {
                'Severe Breach': 'text-red-600 bg-red-900 font-bold',
                'Critical Breach': 'text-red-400 bg-red-900 font-bold',
                'Major Breach': 'text-orange-400 bg-orange-900',
                'Minor Breach': 'text-yellow-400 bg-yellow-900',
                'Met': 'text-green-400 bg-green-900'
            };
            return classes[status] || 'text-gray-400 bg-gray-900';
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays === 1) {
                return 'Yesterday ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else if (diffDays < 7) {
                return diffDays + ' days ago ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined,
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        function formatTechNotes(notes) {
            if (!notes || notes.trim() === '' || notes.includes('No ') || notes.includes('N/A')) {
                return `<span class="italic text-gray-500">${notes}</span>`;
            }
            
            // Basic text formatting for better readability
            let formatted = notes
                .replace(/\n/g, '<br>')  // Convert line breaks
                .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')  // Convert tabs to spaces
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold text
                .replace(/\*(.*?)\*/g, '<em>$1</em>');  // Italic text
            
            // Truncate very long notes with expand option
            if (formatted.length > 500) {
                const truncated = formatted.substring(0, 500);
                const remaining = formatted.substring(500);
                return `
                    <div>
                        <span>${truncated}</span>
                        <span id="more-text" class="hidden">${remaining}</span>
                        <button onclick="toggleMoreText(this)" class="text-blue-400 hover:text-blue-300 ml-2 text-xs underline">
                            Show more...
                        </button>
                    </div>
                `;
            }
            
            return formatted;
        }

        function toggleMoreText(button) {
            const moreText = button.parentElement.querySelector('#more-text');
            if (moreText.classList.contains('hidden')) {
                moreText.classList.remove('hidden');
                button.textContent = 'Show less...';
            } else {
                moreText.classList.add('hidden');
                button.textContent = 'Show more...';
            }
        }

        // SLA Breach Incidents Modal Functions
        async function showSlaBreachIncidents(severity) {
            try {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                console.log(`Showing ${severity} SLA breach incidents for time period: ${currentTimePeriod} and region: ${currentRegion}`);
                
                // Force reset modal flags to prevent stuck state
                slaBreachModalClosing = false;
                modalClosing = false;
                
                // Show modal with loading state
                const modal = document.getElementById('sla-breach-modal');
                const loading = document.getElementById('sla-modal-loading');
                const data = document.getElementById('sla-modal-data');
                
                // Reset modal state completely
                modal.style.display = '';
                modal.classList.remove('hidden');
                loading.classList.remove('hidden');
                data.classList.add('hidden');
                
                // Set modal title and badge
                updateSlaModalHeader(severity);
                
                // Show modal with animation
                modal.style.animation = 'walmartFadeInUp 0.4s ease-out';
                
                // Fetch data (now filter-independent)
                const response = await fetch(`/api/sla_breach_incidents?severity=${severity}&quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const breachData = await response.json();
                console.log('Received SLA breach data:', breachData);
                
                // Show notification about filtered data scope
                try {
                    const filterContext = getFilterContext();
                    showDrillDownNotification('sla_breach', severity.charAt(0).toUpperCase() + severity.slice(1), filterContext);
                } catch (contextError) {
                    console.warn('Error getting filter context:', contextError);
                }
                
                // Populate modal with data
                if (typeof populateSlaBreachModal === 'function') {
                    populateSlaBreachModal(breachData);
                } else {
                    console.error('populateSlaBreachModal function not found');
                    // Fallback: show basic data
                    document.getElementById('sla-modal-loading').innerHTML = `
                        <div class="text-center py-12">
                            <p>SLA Breach Data Loaded: ${breachData.incidents?.length || 0} incidents</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error fetching SLA breach incidents:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name,
                    severity: severity,
                    url: `/api/sla_breach_incidents?severity=${severity}&quarter=${quarter}&month=${month}&location=${currentLocation}&region=${currentRegion}&assignment_group=all`
                });
                // Show error in modal
                document.getElementById('sla-modal-loading').innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-400 text-xl mb-4">âš ï¸</div>
                        <p style="color: var(--modal-text-secondary);">Failed to load ${severity} SLA breach incidents</p>
                        <p class="text-sm mt-2" style="color: var(--modal-text-secondary);">${error.message}</p>
                        <button onclick="showSlaBreachIncidents('${severity}')" class="mt-4 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function updateSlaModalHeader(severity) {
            const modalTitle = document.getElementById('sla-modal-title');
            const modalDescription = document.getElementById('sla-modal-description');
            const severityBadge = document.getElementById('sla-severity-badge');
            const severityText = document.getElementById('sla-severity-text');
            
            // Update title and description
            modalTitle.textContent = `${severity.charAt(0).toUpperCase() + severity.slice(1)} SLA Breach Incidents`;
            
            // Update badge styling and text
            severityText.textContent = severity.charAt(0).toUpperCase() + severity.slice(1);
            
            // Remove existing classes and add severity-specific styling
            severityBadge.className = 'px-3 py-1 rounded-full text-sm font-medium';
            
            if (severity === 'critical') {
                severityBadge.classList.add('bg-red-900', 'text-red-300');
                modalDescription.textContent = 'Incidents exceeding SLA by more than 3 hours (>180 minutes over 4-hour baseline)';
            } else if (severity === 'moderate') {
                severityBadge.classList.add('bg-orange-900', 'text-orange-300');
                modalDescription.textContent = 'Incidents exceeding SLA by 1-3 hours (60-180 minutes over 4-hour baseline)';
            } else if (severity === 'minor') {
                severityBadge.classList.add('bg-yellow-900', 'text-yellow-300');
                modalDescription.textContent = 'Incidents exceeding SLA by 1 hour or less (â‰¤60 minutes over 4-hour baseline)';
            }
        }

        function populateSlaBreachModal(data) {
            // Update summary metrics
            document.getElementById('sla-total-count').textContent = (data.total_incidents || 0).toLocaleString();
            
            // Calculate average variance
            if (data.incidents.length > 0) {
                const avgVariance = data.incidents.reduce((sum, inc) => sum + inc.sla_variance_minutes, 0) / data.incidents.length;
                document.getElementById('sla-avg-variance').textContent = `${(avgVariance / 60).toFixed(1)}h`;
                
                // Count affected teams
                const uniqueTeams = [...new Set(data.incidents.map(inc => inc.team))];
                document.getElementById('sla-affected-teams').textContent = uniqueTeams.length.toLocaleString();
            } else {
                document.getElementById('sla-avg-variance').textContent = '0h';
                document.getElementById('sla-affected-teams').textContent = '0';
            }
            
            // Populate incidents table
            populateSlaIncidentsTable(data.incidents);
            
            // Show data and hide loading
            document.getElementById('sla-modal-loading').classList.add('hidden');
            const modalData = document.getElementById('sla-modal-data');
            modalData.classList.remove('hidden');
            
            // Add entrance animation
            modalData.style.opacity = '0';
            modalData.style.transform = 'translateY(20px)';
            modalData.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            
            setTimeout(() => {
                modalData.style.opacity = '1';
                modalData.style.transform = 'translateY(0)';
            }, 100);
        }

        function populateSlaIncidentsTable(incidents) {
            const tableBody = document.getElementById('sla-incidents-table');
            
            if (incidents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8" style="color: var(--modal-text-secondary);">
                            <div class="text-lg mb-2">ðŸŽ‰</div>
                            <div>No incidents found for this severity level</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = incidents.map(incident => `
                <tr class="border-b hover:bg-opacity-50 transition-colors" 
                    style="border-color: var(--modal-border);"
                    onmouseover="this.style.backgroundColor='var(--modal-card-bg)'" 
                    onmouseout="this.style.backgroundColor='transparent'">
                    <td class="py-3 px-2">
                        <button onclick="openIncidentDetails('${incident.id}')" 
                                class="font-mono text-blue-400 hover:text-blue-300 underline hover:no-underline transition-colors cursor-pointer">
                            ${incident.id}
                        </button>
                    </td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityClass(incident.priority)}">${incident.priority}</span>
                    </td>
                    <td class="py-3 px-2 font-medium">${incident.team}</td>
                    <td class="py-3 px-2">
                        <div>${incident.created}</div>
                        <div class="text-xs" style="color: var(--text-disabled);">${incident.created_date}</div>
                    </td>
                    <td class="text-right py-3 px-2">
                        <span class="font-mono font-bold">${incident.resolution_time}</span>
                    </td>
                    <td class="text-right py-3 px-2">
                        <span class="font-mono font-bold text-red-400">${incident.sla_variance}</span>
                    </td>
                    <td class="py-3 px-2 text-sm">
                        <span class="truncate block max-w-32" title="${incident.affected_application}">${incident.affected_application}</span>
                    </td>
                </tr>
            `).join('');
        }

        function closeSlaBreachModal() {
            console.log('Closing SLA breach modal');
            
            const modal = document.getElementById('sla-breach-modal');
            
            // Immediately reset flags to prevent getting stuck
            slaBreachModalClosing = false;
            modalClosing = false;
            
            // Hide modal immediately
                modal.classList.add('hidden');
                modal.style.animation = '';
            modal.style.display = 'none';
            
            // Reset modal content for next use
            const loading = document.getElementById('sla-modal-loading');
            const data = document.getElementById('sla-modal-data');
            if (loading) loading.classList.remove('hidden');
            if (data) data.classList.add('hidden');
            
            console.log('SLA breach modal closed and reset');
        }

        // Application drill-down function
        async function showApplicationDrillDown(applicationName, monthDate) {
            console.log(`ðŸ” showApplicationDrillDown called with: applicationName="${applicationName}", monthDate="${monthDate}"`);
            
            // If no specific month provided, use current dashboard time period
            if (!monthDate) {
                const { quarter, month } = parseTimePeriod(currentTimePeriod);
                console.log(`ðŸ“… Parsed currentTimePeriod "${currentTimePeriod}" to: quarter="${quarter}", month="${month}"`);
                
                // If current time period is a specific month, use it
                if (month && month !== 'all') {
                    monthDate = month;
                } else {
                    // For quarters or "all", use most recent month (June 2025)
                    monthDate = '2025-06';
                }
                
                console.log(`âœ… Using ${monthDate} for application drill-down (from currentTimePeriod: ${currentTimePeriod})`);
            }
            
            try {
                // Show loading state
                const modal = document.getElementById('applicationDrillDownModal');
                const modalContent = document.getElementById('applicationDrillDownModalContent');
                console.log(`ðŸ” Modal element found:`, modal);
                console.log(`ðŸ” Modal current classes:`, modal.className);
                
                // Reset animation classes and show modal (following pattern from other modals)
                modal.classList.remove('closing', 'hidden');
                modalContent.classList.remove('closing');
                
                // Trigger opening animation
                setTimeout(() => {
                    modalContent.style.transform = 'scale(1)';
                    modalContent.style.opacity = '1';
                }, 10);
                
                console.log(`âœ… Modal should now be visible. New classes:`, modal.className);
                
                const loadingHtml = `
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-400 mx-auto mb-4"></div>
                        <div class="text-gray-300">Loading ${applicationName} incidents...</div>
                    </div>
                `;
                document.getElementById('applicationDrillDownContent').innerHTML = loadingHtml;
                
                // Fetch application drill-down data
                const response = await fetch(`/api/application_drilldown?month=${monthDate}&application_type=${encodeURIComponent(applicationName)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Format the month for display
                const monthLabel = new Date(monthDate + '-01').toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long' 
                });
                
                // Update modal content
                populateApplicationDrillDown(data, monthLabel);
                
            } catch (error) {
                console.error('Error fetching application drill-down data:', error);
                document.getElementById('applicationDrillDownContent').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-red-400 mb-2">âš ï¸ Error loading data</div>
                        <div class="text-gray-400 text-sm">${error.message}</div>
                    </div>
                `;
            }
        }
        
        function populateApplicationDrillDown(data, monthLabel) {
            const summary = data.summary;
            const incidents = data.incidents || [];
            
            const contentHtml = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="border-b border-gray-600 pb-4">
                        <h3 class="text-xl font-bold text-white">${data.application_type}</h3>
                        <p class="text-gray-400">${monthLabel} - Detailed Analysis</p>
                    </div>
                    
                    <!-- Summary Statistics -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs">Total Incidents</div>
                            <div class="text-2xl font-bold text-cyan-400">${summary.total_incidents}</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs">Avg MTTR</div>
                            <div class="text-2xl font-bold text-orange-400">${summary.avg_mttr_hours}h</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs">SLA Compliance</div>
                            <div class="text-2xl font-bold text-green-400">${summary.sla_compliance_rate}%</div>
                        </div>
                        <div class="bg-gray-700 rounded-lg p-4">
                            <div class="text-gray-400 text-xs">Resolved</div>
                            <div class="text-2xl font-bold text-purple-400">${summary.resolved_incidents}</div>
                            <div class="text-xs text-gray-400">of ${summary.total_incidents}</div>
                        </div>
                    </div>
                    
                    <!-- Top Assignment Groups -->
                    ${summary.top_assignment_groups.length > 0 ? `
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-white mb-3">Top Assignment Groups</h4>
                        <div class="space-y-2">
                            ${summary.top_assignment_groups.map(group => `
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-gray-300">${group.group.replace(/^(AEDT|ADE) - Enterprise Tech Spot( 2)? - /, '')}</span>
                                    <span class="text-cyan-400 font-semibold">${group.count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Recent Incidents -->
                    <div class="bg-gray-700 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-white mb-3">Recent Incidents (${incidents.length} shown)</h4>
                        <div class="space-y-3 max-h-96 overflow-y-auto">
                            ${incidents.length > 0 ? incidents.map(incident => `
                                <div class="bg-gray-800 rounded-lg p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="font-mono text-blue-400 text-sm">${incident.incident_number}</div>
                                        <div class="flex gap-2">
                                            <span class="px-2 py-1 rounded text-xs ${incident.sla_met ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">
                                                ${incident.sla_met ? 'SLA Met' : 'SLA Missed'}
                                            </span>
                                            ${incident.mttr_minutes ? `<span class="px-2 py-1 bg-orange-900 text-orange-300 rounded text-xs">${Math.round(incident.mttr_minutes / 60)}h MTTR</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-300 mb-2">${incident.description}</div>
                                    <div class="flex justify-between text-xs text-gray-400">
                                        <span>Created: ${incident.created_date}</span>
                                        <span>Resolved: ${incident.resolved_date}</span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${incident.assignment_group.replace(/^(AEDT|ADE) - Enterprise Tech Spot( 2)? - /, '')}</div>
                                </div>
                            `).join('') : '<div class="text-gray-400 text-center py-4">No incidents found</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('applicationDrillDownContent').innerHTML = contentHtml;
        }

        function closeApplicationDrillDownModal() {
            const modal = document.getElementById('applicationDrillDownModal');
            const modalContent = document.getElementById('applicationDrillDownModalContent');
            
            // Add closing animation classes
            modal.classList.add('closing');
            modalContent.classList.add('closing');
            
            // Reset transform and opacity for closing
            modalContent.style.transform = 'scale(0.95)';
            modalContent.style.opacity = '0';
            
            // Wait for animation to complete before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('closing');
                modalContent.classList.remove('closing');
            }, 300);
        }

        // Initialize dashboard with animations
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Walmart brand theme
            initializeWalmartTheme();
            
            // Initialize animations and hover effects
            addHoverEffects();
            
            // Set up theme toggle event listener with enhanced animation
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('click', toggleTheme);
            
            // Set up smart filter event listeners for main dashboard
            const timePeriodFilter = document.getElementById('time-period');
            if (timePeriodFilter) {
                timePeriodFilter.addEventListener('change', function() {
                    handleTimePeriodChange();
                });
            }
            
            const locationFilter = document.getElementById('location-filter');
            locationFilter.addEventListener('change', function() {
                handleLocationChange();
            });
            
            const regionFilter = document.getElementById('region-filter');
            regionFilter.addEventListener('change', function() {
                handleRegionChange();
            });
            
            // Assignment group filter removed - using location filter instead
            
            // Load regions and locations first, then apply saved filters and load data
            Promise.all([fetchRegions(), fetchLocations()]).then(() => {
                // Load and apply saved filter state
                const savedFilters = loadFilterState();
                if (savedFilters) {
                    applyFilterState(savedFilters);
                    showSmartFilterNotification('ðŸ”„ Restored previous filter settings');
                }
                refreshAllData();
            });
            
            // Refresh data every 5 minutes
            setInterval(refreshAllData, 300000);
            
            // Close team modal when clicking outside
            document.getElementById('team-modal').addEventListener('click', function(e) {
                console.log('Team modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this) {
                    console.log('Closing Team modal via backdrop click');
                    closeTeamDrillDown();
                }
            });
            
            // Add event delegation for team clicks to ensure they always work
            const teamTable = document.getElementById('team-performance-table');
            if (teamTable) {
                console.log('Team performance table found, adding click listener');
                teamTable.addEventListener('click', function(e) {
                    console.log('Team table clicked:', e.target);
                    
                // Find the closest team name cell
                const teamCell = e.target.closest('.team-name');
                if (teamCell) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Extract team name from the cell content
                    const teamName = teamCell.textContent.trim();
                    console.log(`Team clicked: ${teamName}`);

                    
                    // Call the drill-down function
                    animateTeamClick(teamCell);
                    openTeamDrillDown(teamName);
                    } else {
                        console.log('No team cell found, clicked element:', e.target.className);

                }
            });
            } else {
                console.error('Team performance table not found!');

            }
            
            // Close incident modal when clicking outside
            document.getElementById('incident-modal').addEventListener('click', function(e) {
                console.log('Incident details modal clicked:', e.target === this ? 'backdrop' : 'content');
                // Check if clicked on the backdrop (outermost div) or the wrapper div (but not the modal content)
                const modalContent = document.getElementById('incident-modal-content');
                if (e.target === this || (e.target !== modalContent && !modalContent.contains(e.target))) {
                    console.log('Closing Incident details modal via backdrop click');
                    closeIncidentDetails();
                }
            });
            
            // Close SLA breach modal when clicking outside
            document.getElementById('sla-breach-modal').addEventListener('click', function(e) {
                console.log('SLA breach modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this && !slaBreachModalClosing) {
                    console.log('Closing SLA breach modal via backdrop click');
                    closeSlaBreachModal();
                }
            });
            
            // Close drill-down modals when clicking outside
            document.getElementById('mttr-modal').addEventListener('click', function(e) {
                console.log('MTTR modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this && !mttrModalClosing) {
                    console.log('Closing MTTR modal via backdrop click');
                    closeMTTRDrillDown();
                }
            });
            
            document.getElementById('incident-drilldown-modal').addEventListener('click', function(e) {
                console.log('Incident modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this && !incidentDrilldownModalClosing) {
                    console.log('Closing Incident modal via backdrop click');
                    closeIncidentDrillDown();
                }
            });
            
            // Add event listener for FCR modal with additional safeguards
            const fcrModal = document.getElementById('fcr-drilldown-modal');
            fcrModal.addEventListener('click', function(e) {
                console.log('FCR modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this && !fcrModalClosing) {
                    console.log('Closing FCR modal via backdrop click');
                    closeFCRDrillDown();
                }
            });
            
            // Close technicians and locations modals when clicking outside
            document.getElementById('technicians-modal').addEventListener('click', function(e) {
                console.log('Technicians modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this) {
                    console.log('Closing Technicians modal via backdrop click');
                    closeTechniciansModal();
                }
            });
            
            document.getElementById('locations-modal').addEventListener('click', function(e) {
                console.log('Locations modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this) {
                    console.log('Closing Locations modal via backdrop click');
                    closeLocationsModal();
                }
            });
            
            // Close application drill-down modal when clicking outside
            document.getElementById('applicationDrillDownModal').addEventListener('click', function(e) {
                console.log('Application drill-down modal clicked:', e.target === this ? 'backdrop' : 'content');
                if (e.target === this) {
                    console.log('Closing Application drill-down modal via backdrop click');
                    closeApplicationDrillDownModal();
                }
            });
            
            // Close modals with ESC key and manual flag reset
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    if (!document.getElementById('incident-modal').classList.contains('hidden')) {
                        closeIncidentDetails();
                    } else if (!document.getElementById('team-modal').classList.contains('hidden')) {
                        closeTeamDrillDown();
                    } else if (!document.getElementById('sla-breach-modal').classList.contains('hidden') && !slaBreachModalClosing) {
                        closeSlaBreachModal();
                    } else if (!document.getElementById('mttr-modal').classList.contains('hidden') && !mttrModalClosing) {
                        closeMTTRDrillDown();
                    } else if (!document.getElementById('incident-drilldown-modal').classList.contains('hidden') && !incidentDrilldownModalClosing) {
                        closeIncidentDrillDown();
                    } else if (!document.getElementById('fcr-drilldown-modal').classList.contains('hidden') && !fcrModalClosing) {
                        closeFCRDrillDown();
                    } else if (!document.getElementById('technicians-modal').classList.contains('hidden')) {
                        closeTechniciansModal();
                    } else if (!document.getElementById('locations-modal').classList.contains('hidden')) {
                        closeLocationsModal();
                    }
                }
                

            });
        });
    </script>
</body>
</html> 